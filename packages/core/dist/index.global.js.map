{"version":3,"sources":["../src/index.ts","#style-inject:#style-inject","../src/markers.css","../src/dotmarket.ts","../src/marker.ts","../src/adapters/maplibre/markermanager.ts","../src/adapters/google/markermanager.ts","../src/adapters/mapbox/markermanager.ts","../src/adapters/index.ts","../src/adapters/maplibre.ts","../src/adapters/google.ts","../src/adapters/mapbox.ts","../src/utils/clustering.ts"],"sourcesContent":["import type { MapAdapter } from \"./adapters\";\nimport { MapLibreAdapter } from \"./adapters/maplibre\";\nimport { GoogleMapsAdapter } from \"./adapters/google\";\nimport { MapboxAdapter } from \"./adapters/mapbox\";\nimport type { Property, PropertyType } from \"./types\";\nimport type { MapLibreNamespace } from \"./adapters/maplibre/markermanager\";\nimport type { GoogleMapsNamespace } from \"./adapters/google/markermanager\";\nimport type { MapboxNamespace } from \"./adapters/mapbox/markermanager\";\nimport {\n  ClusterDisplayItem,\n  clusterMarkers,\n  extractViewState,\n  metersToPixels,\n  ViewStateSnapshot,\n} from \"./utils/clustering\";\n\nexport type { Property, PropertyType } from \"./types\";\n\nexport type { MapLibreNamespace } from \"./adapters/maplibre/markermanager\";\n\nexport type { GoogleMapsNamespace } from \"./adapters/google/markermanager\";\n\nexport type { MapboxNamespace } from \"./adapters/mapbox/markermanager\";\n\ntype BaseMapFirstOptions = {\n  markers?: Property[];\n  primaryType?: PropertyType;\n  selectedMarkerId?: number | null;\n  clusterRadiusMeters?: number;\n  autoSelectOnClick?: boolean;\n  onClusterUpdate?: (\n    clusters: ClusterDisplayItem[],\n    viewState: ViewStateSnapshot | null\n  ) => void;\n};\n\ntype AdapterDrivenOptions = BaseMapFirstOptions & {\n  adapter: MapAdapter;\n  platform?: undefined;\n};\n\ntype MapLibreOptions = BaseMapFirstOptions & {\n  platform: \"maplibre\";\n  mapInstance: any;\n  maplibregl: MapLibreNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\ntype GoogleMapsOptions = BaseMapFirstOptions & {\n  platform: \"google\";\n  mapInstance: any; // google.maps.Map\n  google: GoogleMapsNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\ntype MapboxOptions = BaseMapFirstOptions & {\n  platform: \"mapbox\";\n  mapInstance: any;\n  mapboxgl: MapboxNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\nexport type MapFirstOptions =\n  | AdapterDrivenOptions\n  | MapLibreOptions\n  | GoogleMapsOptions\n  | MapboxOptions;\n\nconst DEFAULT_PRIMARY_TYPE: PropertyType = \"Accommodation\";\n\nexport class MapFirstCore {\n  private readonly adapter: MapAdapter;\n  private markers: Property[] = [];\n  private primaryType?: PropertyType;\n  private selectedMarkerId: number | null = null;\n  private destroyed = false;\n  private clusterItems: ClusterDisplayItem[] = [];\n\n  constructor(private readonly options: MapFirstOptions) {\n    this.markers = [...(options.markers ?? [])];\n    this.primaryType = options.primaryType;\n    this.selectedMarkerId = options.selectedMarkerId ?? null;\n\n    if (isMapLibreOptions(options)) {\n      const adapter = new MapLibreAdapter(options.mapInstance);\n      const shouldAutoSelect = options.autoSelectOnClick ?? true;\n\n      adapter.initialize({\n        maplibregl: options.maplibregl,\n        onMarkerClick: (marker) => {\n          if (shouldAutoSelect) {\n            this.setSelectedMarker(marker.tripadvisor_id);\n          }\n          options.onMarkerClick?.(marker);\n        },\n        onRefresh: () => this.refresh(),\n      });\n\n      this.adapter = adapter;\n    } else if (isGoogleMapsOptions(options)) {\n      const adapter = new GoogleMapsAdapter(options.mapInstance);\n      const shouldAutoSelect = options.autoSelectOnClick ?? true;\n\n      adapter.initialize({\n        google: options.google,\n        onMarkerClick: (marker) => {\n          if (shouldAutoSelect) {\n            this.setSelectedMarker(marker.tripadvisor_id);\n          }\n          options.onMarkerClick?.(marker);\n        },\n        onRefresh: () => this.refresh(),\n      });\n\n      this.adapter = adapter;\n    } else if (isMapboxOptions(options)) {\n      const adapter = new MapboxAdapter(options.mapInstance);\n      const shouldAutoSelect = options.autoSelectOnClick ?? true;\n\n      adapter.initialize({\n        mapboxgl: options.mapboxgl,\n        onMarkerClick: (marker) => {\n          if (shouldAutoSelect) {\n            this.setSelectedMarker(marker.tripadvisor_id);\n          }\n          options.onMarkerClick?.(marker);\n        },\n        onRefresh: () => this.refresh(),\n      });\n\n      this.adapter = adapter;\n    } else {\n      this.adapter = options.adapter;\n    }\n\n    this.refresh();\n  }\n\n  setMarkers(markers: Property[]) {\n    this.ensureAlive();\n    this.markers = [...markers];\n    this.refresh();\n  }\n\n  addMarker(marker: Property) {\n    this.ensureAlive();\n    this.markers = [...this.markers, marker];\n    this.refresh();\n  }\n\n  clearMarkers() {\n    this.ensureAlive();\n    this.markers = [];\n    this.refresh();\n  }\n\n  setPrimaryType(primary: PropertyType) {\n    this.ensureAlive();\n    if (this.primaryType === primary) return;\n    this.primaryType = primary;\n    this.refresh();\n  }\n\n  setSelectedMarker(markerId: number | null) {\n    this.ensureAlive();\n    if (this.selectedMarkerId === markerId) return;\n    this.selectedMarkerId = markerId;\n    this.refresh();\n  }\n\n  getClusters(): ClusterDisplayItem[] {\n    this.ensureAlive();\n    return [...this.clusterItems];\n  }\n\n  refresh() {\n    this.ensureAlive();\n    const viewState = this.safeExtractViewState();\n    const primaryType = this.resolvePrimaryType();\n\n    this.clusterItems = clusterMarkers({\n      primaryType,\n      markers: this.markers,\n      map: this.adapter,\n      selectedMarkerId: this.selectedMarkerId,\n      zoom: viewState?.zoom ?? 0,\n    });\n\n    const markerManager = this.adapter.getMarkerManager();\n    markerManager.render(this.clusterItems);\n\n    this.options.onClusterUpdate?.(this.clusterItems, viewState);\n  }\n\n  destroy() {\n    if (this.destroyed) {\n      return;\n    }\n    const markerManager = this.adapter.getMarkerManager();\n    markerManager.destroy();\n\n    this.adapter.cleanup();\n\n    this.clusterItems = [];\n    this.markers = [];\n    this.destroyed = true;\n  }\n\n  private resolvePrimaryType(): PropertyType {\n    return (\n      this.primaryType ??\n      this.markers.find((marker) => marker.type)?.type ??\n      DEFAULT_PRIMARY_TYPE\n    );\n  }\n\n  private safeExtractViewState(): ViewStateSnapshot | null {\n    try {\n      return extractViewState(this.adapter);\n    } catch {\n      return null;\n    }\n  }\n\n  private ensureAlive() {\n    if (this.destroyed) {\n      throw new Error(\"MapFirstCore instance has been destroyed\");\n    }\n  }\n}\n\nfunction isMapLibreOptions(\n  options: MapFirstOptions\n): options is MapLibreOptions {\n  return (options as MapLibreOptions).platform === \"maplibre\";\n}\n\nfunction isGoogleMapsOptions(\n  options: MapFirstOptions\n): options is GoogleMapsOptions {\n  return (options as GoogleMapsOptions).platform === \"google\";\n}\n\nfunction isMapboxOptions(options: MapFirstOptions): options is MapboxOptions {\n  return (options as MapboxOptions).platform === \"mapbox\";\n}\n","\n          export default function styleInject(css, { insertAt } = {}) {\n            if (!css || typeof document === 'undefined') return\n          \n            const head = document.head || document.getElementsByTagName('head')[0]\n            const style = document.createElement('style')\n            style.type = 'text/css'\n          \n            if (insertAt === 'top') {\n              if (head.firstChild) {\n                head.insertBefore(style, head.firstChild)\n              } else {\n                head.appendChild(style)\n              }\n            } else {\n              head.appendChild(style)\n            }\n          \n            if (style.styleSheet) {\n              style.styleSheet.cssText = css\n            } else {\n              style.appendChild(document.createTextNode(css))\n            }\n          }\n          ","import styleInject from '#style-inject';styleInject(\".mapfirst-marker-root{display:flex;z-index:20;flex-direction:column;align-items:center;pointer-events:auto}.mapfirst-marker-pill{border:2px solid;border-radius:999px;padding:8px;font-size:16px;font-weight:600;font-family:system-ui,-apple-system,sans-serif;box-shadow:0 4px 6px #6b728080;display:flex;align-items:center;justify-content:center;position:relative;transition:transform .2s;transform-origin:center bottom}.mapfirst-marker-pill-pending{background:#ffffff80;backdrop-filter:blur(4px);border-color:transparent;cursor:default}.mapfirst-marker-pill-active{background:#012b11;border-color:#fff;color:#fff;cursor:pointer}.mapfirst-marker-pill-active:hover{transform:scale(1.2)}.mapfirst-marker-badge{position:absolute;top:-12px;right:-20px}.mapfirst-marker-award-container{position:relative;width:32px;height:32px}.mapfirst-marker-award-back{position:absolute;stroke:#f5f5f5;stroke-width:2px}.mapfirst-marker-award-dot{position:absolute;top:6.2px;left:6.3px;width:18.5px;height:18.5px;border-radius:50%;z-index:1}.mapfirst-marker-award-dot-type-0{background:#ffef0e}.mapfirst-marker-award-dot-type-1{background:#01ea5b}.mapfirst-marker-award-front{position:relative;z-index:2;color:#012b11}.mapfirst-marker-rating-badge{display:flex;align-items:center;justify-content:center;border-radius:999px;background:#03852e;color:#fff;font-size:12px;line-height:1;box-shadow:0 2px 4px #0003;padding:2px 6px;border:2px solid #ffffff;font-weight:400}.mapfirst-marker-content{display:flex;align-items:center}.mapfirst-dot-marker-container{display:flex;z-index:10;align-items:center;justify-content:center;pointer-events:auto}.mapfirst-dot-marker-button{width:20px;height:20px;border-radius:999px;border:2px solid #ffffff;box-shadow:0 2px 4px #6b728066;transition:transform .2s;outline:none;transform-origin:center center}.mapfirst-dot-marker-button-pending{background:#d1d5db;cursor:default}.mapfirst-dot-marker-button-active{background:#012b11;cursor:pointer}.mapfirst-dot-marker-button-active:hover{transform:scale(1.2)}.mapfirst-dot-marker-button-active:focus{outline:2px solid #ffffff;outline-offset:2px}\\n\")","import type { Property } from \".\";\r\nimport \"./markers.css\";\r\nimport { ClusterDisplayItem } from \"./utils/clustering\";\r\n\r\nexport function createDotMarkerElement(\r\n  item: Extract<ClusterDisplayItem, { kind: \"dot\" }>,\r\n  onMarkerClick?: (marker: Property) => void\r\n) {\r\n  if (typeof document === \"undefined\") {\r\n    return null;\r\n  }\r\n\r\n  const marker = item.marker;\r\n  const isAccommodation = marker.type === \"Accommodation\";\r\n  const isPending =\r\n    isAccommodation && marker.pricing?.offer?.availability !== \"available\";\r\n\r\n  // Create container div to match primary marker structure\r\n  const container = document.createElement(\"div\");\r\n  container.className = \"mapfirst-dot-marker-container\";\r\n\r\n  const button = document.createElement(\"button\");\r\n  button.type = \"button\";\r\n  button.className = isPending\r\n    ? \"mapfirst-dot-marker-button mapfirst-dot-marker-button-pending\"\r\n    : \"mapfirst-dot-marker-button mapfirst-dot-marker-button-active\";\r\n  button.title = marker.name ?? String(marker.tripadvisor_id);\r\n\r\n  button.addEventListener(\"click\", (evt) => {\r\n    evt.stopPropagation();\r\n    if (!isPending) {\r\n      onMarkerClick?.(marker);\r\n    }\r\n  });\r\n\r\n  container.appendChild(button);\r\n  return container;\r\n}\r\n","import type { Property } from \".\";\r\nimport \"./markers.css\";\r\nimport { ClusterDisplayItem } from \"./utils/clustering\";\r\n\r\nconst AWARD_SVG = `<svg viewBox=\"0 0 24 24\" width=\"32\" height=\"32\" fill=\"currentColor\"><path d=\"M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014\"></path><path d=\"M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827\"></path></svg>`;\r\n\r\nconst AWARD_BACK_SVG = `<svg viewBox=\"0 0 24 24\" width=\"32\" height=\"32\"><path d=\"M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014\"></path><path d=\"M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827\"></path></svg>`;\r\n\r\nconst EAT_DRINK_SVG = `<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"currentColor\"><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M14.051 6.549v.003l1.134 1.14 3.241-3.25.003-.002 1.134 1.136-3.243 3.252 1.134 1.14a1 1 0 0 0 .09-.008c.293-.05.573-.324.72-.474l.005-.006 2.596-2.603L22 8.016l-2.597 2.604a3.73 3.73 0 0 1-1.982 1.015 4.3 4.3 0 0 1-3.162-.657l-.023-.016-.026-.018-1.366 1.407 8.509 8.512L20.219 22l-.002-.002-6.654-6.663-2.597 2.76-7.3-7.315C1.967 8.948 1.531 6.274 2.524 4.198c.241-.504.566-.973.978-1.386l8.154 8.416 1.418-1.423-.039-.045c-.858-1.002-1.048-2.368-.62-3.595a4.15 4.15 0 0 1 .983-1.561L16 2l1.135 1.138-2.598 2.602-.047.045c-.16.151-.394.374-.433.678zM3.809 5.523c-.362 1.319-.037 2.905 1.06 4.103L10.93 15.7l1.408-1.496zM2.205 20.697 3.34 21.84l4.543-4.552-1.135-1.143z\"/></svg>`;\r\n\r\nconst ATTRACTION_SVG = `<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"currentColor\"><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M7.56 7.5H3.75a.25.25 0 0 0-.25.25v10c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25v-10a.25.25 0 0 0-.25-.25h-3.81l-2-2H9.56zM8.94 4h6.12l2 2h3.19c.966 0 1.75.784 1.75 1.75v10a1.75 1.75 0 0 1-1.75 1.75H3.75A1.75 1.75 0 0 1 2 17.75v-10C2 6.784 2.784 6 3.75 6h3.19z\"/><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M12 9.25a2.75 2.75 0 1 0 0 5.5 2.75 2.75 0 0 0 0-5.5M7.75 12a4.25 4.25 0 1 1 8.5 0 4.25 4.25 0 0 1-8.5 0\"/></svg>`;\r\n\r\nexport function createPrimaryMarkerElement(\r\n  item: Extract<ClusterDisplayItem, { kind: \"primary\" }>,\r\n  onMarkerClick?: (marker: Property) => void\r\n) {\r\n  if (typeof document === \"undefined\") {\r\n    return null;\r\n  }\r\n\r\n  const marker = item.marker;\r\n  const isAccommodation = marker.type === \"Accommodation\";\r\n  const hasPrice = marker.pricing?.offer?.displayPrice;\r\n  const isPending = isAccommodation && !hasPrice;\r\n\r\n  // Rating\r\n  const ratingLabel = (() => {\r\n    if (marker.rating === undefined || marker.rating === null) return null;\r\n    const numeric =\r\n      typeof marker.rating === \"number\" ? marker.rating : Number(marker.rating);\r\n    if (Number.isNaN(numeric) || numeric <= 0) return null;\r\n    return numeric.toFixed(1);\r\n  })();\r\n\r\n  const root = document.createElement(\"div\");\r\n  root.className = \"mapfirst-marker-root\";\r\n\r\n  const pill = document.createElement(\"button\");\r\n  pill.type = \"button\";\r\n  pill.className = isPending\r\n    ? \"mapfirst-marker-pill mapfirst-marker-pill-pending\"\r\n    : \"mapfirst-marker-pill mapfirst-marker-pill-active\";\r\n  pill.title = marker.name ?? String(marker.tripadvisor_id);\r\n\r\n  // Awards or Rating badge\r\n  if (!isPending && (marker.awards?.length || ratingLabel)) {\r\n    const badge = document.createElement(\"div\");\r\n    badge.className = \"mapfirst-marker-badge\";\r\n\r\n    if (marker.awards?.length && marker.awards[0].type) {\r\n      const awardContainer = document.createElement(\"div\");\r\n      awardContainer.className = \"mapfirst-marker-award-container\";\r\n\r\n      const backLayer = document.createElement(\"div\");\r\n      backLayer.className = \"mapfirst-marker-award-back\";\r\n      backLayer.innerHTML = AWARD_BACK_SVG;\r\n\r\n      const colorDot = document.createElement(\"div\");\r\n      colorDot.className = `mapfirst-marker-award-dot mapfirst-marker-award-dot-type-${marker.awards[0].type}`;\r\n\r\n      const frontLayer = document.createElement(\"div\");\r\n      frontLayer.className = \"mapfirst-marker-award-front\";\r\n      frontLayer.innerHTML = AWARD_SVG;\r\n\r\n      awardContainer.appendChild(backLayer);\r\n      awardContainer.appendChild(colorDot);\r\n      awardContainer.appendChild(frontLayer);\r\n      badge.appendChild(awardContainer);\r\n    } else if (ratingLabel) {\r\n      badge.className = \"mapfirst-marker-badge mapfirst-marker-rating-badge\";\r\n      badge.textContent = ratingLabel;\r\n    }\r\n\r\n    pill.appendChild(badge);\r\n  }\r\n\r\n  // Content\r\n  const content = document.createElement(\"span\");\r\n  content.className = \"mapfirst-marker-content\";\r\n  if (isAccommodation) {\r\n    content.textContent = marker.pricing?.offer?.displayPrice ?? \"â€”\";\r\n  } else if (marker.type === \"Eat & Drink\") {\r\n    content.innerHTML = EAT_DRINK_SVG;\r\n  } else if (marker.type === \"Attraction\") {\r\n    content.innerHTML = ATTRACTION_SVG;\r\n  }\r\n  pill.appendChild(content);\r\n\r\n  pill.addEventListener(\"click\", (evt) => {\r\n    evt.stopPropagation();\r\n    if (!isPending) {\r\n      onMarkerClick?.(marker);\r\n    }\r\n  });\r\n\r\n  root.appendChild(pill);\r\n  return root;\r\n}\r\n","import type { Property } from \"../../types\";\r\nimport { createDotMarkerElement } from \"../../dotmarket\";\r\nimport { createPrimaryMarkerElement } from \"../../marker\";\r\nimport { ClusterDisplayItem } from \"../../utils/clustering\";\r\n\r\nexport type MapLibreMarkerHandle = {\r\n  setLngLat(lngLat: [number, number]): MapLibreMarkerHandle;\r\n  addTo(map: any): MapLibreMarkerHandle;\r\n  remove(): void;\r\n  getElement(): HTMLElement;\r\n};\r\n\r\nexport type MapLibreNamespace = {\r\n  Marker: new (options?: {\r\n    element?: HTMLElement;\r\n    anchor?: string;\r\n  }) => MapLibreMarkerHandle;\r\n};\r\n\r\ntype MapLibreMarkerManagerOptions = {\r\n  mapInstance: any;\r\n  maplibregl: MapLibreNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\ntype MarkerEntry = {\r\n  key: string;\r\n  marker: MapLibreMarkerHandle;\r\n  kind: \"primary\" | \"dot\";\r\n  parentId?: number;\r\n};\r\n\r\nexport class MapLibreMarkerManager {\r\n  private readonly mapInstance: any;\r\n  private readonly MarkerCtor?: MapLibreNamespace[\"Marker\"];\r\n  private readonly onMarkerClick?: (marker: Property) => void;\r\n  private markerCache = new Map<string, MarkerEntry>();\r\n\r\n  constructor(options: MapLibreMarkerManagerOptions) {\r\n    this.mapInstance = options.mapInstance;\r\n    this.MarkerCtor = options.maplibregl?.Marker;\r\n    this.onMarkerClick = options.onMarkerClick;\r\n  }\r\n\r\n  render(items: ClusterDisplayItem[]) {\r\n    if (!this.MarkerCtor) {\r\n      return;\r\n    }\r\n\r\n    // Create a set of keys for the new items\r\n    const newKeys = new Set(items.map((item) => item.key));\r\n\r\n    // Remove markers that are no longer needed\r\n    for (const [key, entry] of this.markerCache.entries()) {\r\n      if (!newKeys.has(key)) {\r\n        try {\r\n          entry.marker.remove();\r\n        } catch {\r\n          // swallow removal errors\r\n        }\r\n        this.markerCache.delete(key);\r\n      }\r\n    }\r\n\r\n    // Add or update markers\r\n    for (const item of items) {\r\n      const coords = safeLatLon(item.marker.location);\r\n      if (!coords) continue;\r\n\r\n      const existing = this.markerCache.get(item.key);\r\n\r\n      if (existing) {\r\n        // Update existing marker position if needed\r\n        try {\r\n          existing.marker.setLngLat([coords.lon, coords.lat]);\r\n        } catch {\r\n          // If update fails, remove and recreate\r\n          try {\r\n            existing.marker.remove();\r\n          } catch {\r\n            // swallow\r\n          }\r\n          this.markerCache.delete(item.key);\r\n          this.createAndAddMarker(item, coords);\r\n        }\r\n      } else {\r\n        // Create new marker\r\n        this.createAndAddMarker(item, coords);\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const entry of this.markerCache.values()) {\r\n      try {\r\n        entry.marker.remove();\r\n      } catch {\r\n        // swallow removal errors\r\n      }\r\n    }\r\n    this.markerCache.clear();\r\n  }\r\n\r\n  private createAndAddMarker(\r\n    item: ClusterDisplayItem,\r\n    coords: { lon: number; lat: number }\r\n  ) {\r\n    if (!this.MarkerCtor) return;\r\n\r\n    const element =\r\n      item.kind === \"primary\"\r\n        ? createPrimaryMarkerElement(item, this.onMarkerClick)\r\n        : createDotMarkerElement(item, this.onMarkerClick);\r\n\r\n    if (!element) return;\r\n\r\n    try {\r\n      const marker = new this.MarkerCtor({\r\n        element,\r\n        anchor: item.kind === \"primary\" ? \"bottom\" : \"center\",\r\n      })\r\n        .setLngLat([coords.lon, coords.lat])\r\n        .addTo(this.mapInstance);\r\n\r\n      this.markerCache.set(item.key, {\r\n        key: item.key,\r\n        marker,\r\n        kind: item.kind,\r\n        parentId: item.kind === \"dot\" ? item.parentId : undefined,\r\n      });\r\n    } catch {\r\n      // swallow marker creation errors\r\n    }\r\n  }\r\n}\r\n\r\nfunction safeLatLon(location?: { lon?: number; lat?: number }) {\r\n  if (typeof location?.lon !== \"number\" || typeof location?.lat !== \"number\") {\r\n    return null;\r\n  }\r\n  if (Number.isNaN(location.lon) || Number.isNaN(location.lat)) {\r\n    return null;\r\n  }\r\n  return { lon: location.lon, lat: location.lat };\r\n}\r\n","import type { Property } from \"../../types\";\r\nimport { createDotMarkerElement } from \"../../dotmarket\";\r\nimport { createPrimaryMarkerElement } from \"../../marker\";\r\nimport { ClusterDisplayItem } from \"../../utils/clustering\";\r\n\r\nexport type GoogleMapsMarkerHandle = any; // google.maps.marker.AdvancedMarkerElement\r\n\r\nexport type GoogleMapsNamespace = any; // typeof google.maps\r\n\r\ntype GoogleMapsMarkerManagerOptions = {\r\n  mapInstance: any; // google.maps.Map\r\n  google: GoogleMapsNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\ntype MarkerEntry = {\r\n  key: string;\r\n  marker: GoogleMapsMarkerHandle;\r\n  kind: \"primary\" | \"dot\";\r\n  parentId?: number;\r\n};\r\n\r\nexport class GoogleMapsMarkerManager {\r\n  private readonly mapInstance: any; // google.maps.Map\r\n  private readonly google: GoogleMapsNamespace;\r\n  private readonly onMarkerClick?: (marker: Property) => void;\r\n  private markerCache = new Map<string, MarkerEntry>();\r\n\r\n  constructor(options: GoogleMapsMarkerManagerOptions) {\r\n    this.mapInstance = options.mapInstance;\r\n    this.google = options.google;\r\n    this.onMarkerClick = options.onMarkerClick;\r\n  }\r\n\r\n  render(items: ClusterDisplayItem[]) {\r\n    if (!this.google?.marker?.AdvancedMarkerElement) {\r\n      console.warn(\"AdvancedMarkerElement not available\");\r\n      return;\r\n    }\r\n\r\n    // Create a set of keys for the new items\r\n    const newKeys = new Set(items.map((item) => item.key));\r\n\r\n    // Remove markers that are no longer needed\r\n    for (const [key, entry] of this.markerCache.entries()) {\r\n      if (!newKeys.has(key)) {\r\n        try {\r\n          entry.marker.map = null;\r\n        } catch (error) {\r\n          console.error(\"Error removing marker\", error);\r\n        }\r\n        this.markerCache.delete(key);\r\n      }\r\n    }\r\n\r\n    // Add or update markers\r\n    for (const item of items) {\r\n      const coords = safeLatLon(item.marker.location);\r\n      if (!coords) continue;\r\n\r\n      const existing = this.markerCache.get(item.key);\r\n\r\n      if (existing) {\r\n        // Update existing marker position if needed\r\n        try {\r\n          existing.marker.position = { lat: coords.lat, lng: coords.lon };\r\n        } catch {\r\n          // If update fails, remove and recreate\r\n          try {\r\n            existing.marker.map = null;\r\n          } catch (error) {\r\n            console.error(\"Error removing marker\", error);\r\n          }\r\n          this.markerCache.delete(item.key);\r\n          this.createAndAddMarker(item, coords);\r\n        }\r\n      } else {\r\n        // Create new marker\r\n        this.createAndAddMarker(item, coords);\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const entry of this.markerCache.values()) {\r\n      try {\r\n        entry.marker.map = null;\r\n      } catch (error) {\r\n        console.error(\"Error removing marker\", error);\r\n      }\r\n    }\r\n    this.markerCache.clear();\r\n  }\r\n\r\n  private createAndAddMarker(\r\n    item: ClusterDisplayItem,\r\n    coords: { lon: number; lat: number }\r\n  ) {\r\n    if (!this.google?.marker?.AdvancedMarkerElement) return;\r\n\r\n    const element =\r\n      item.kind === \"primary\"\r\n        ? createPrimaryMarkerElement(item, this.onMarkerClick)\r\n        : createDotMarkerElement(item, this.onMarkerClick);\r\n\r\n    if (!element) return;\r\n\r\n    try {\r\n      const marker = new this.google.marker.AdvancedMarkerElement({\r\n        map: this.mapInstance,\r\n        position: { lat: coords.lat, lng: coords.lon },\r\n        content: element,\r\n        zIndex: item.kind === \"primary\" ? 20 : 10,\r\n      });\r\n\r\n      this.markerCache.set(item.key, {\r\n        key: item.key,\r\n        marker,\r\n        kind: item.kind,\r\n        parentId: item.kind === \"dot\" ? item.parentId : undefined,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error creating marker\", error);\r\n    }\r\n  }\r\n}\r\n\r\nfunction safeLatLon(location?: { lon?: number; lat?: number }) {\r\n  if (typeof location?.lon !== \"number\" || typeof location?.lat !== \"number\") {\r\n    return null;\r\n  }\r\n  if (Number.isNaN(location.lon) || Number.isNaN(location.lat)) {\r\n    return null;\r\n  }\r\n  return { lon: location.lon, lat: location.lat };\r\n}\r\n","import type { Property } from \"../../types\";\r\nimport { createDotMarkerElement } from \"../../dotmarket\";\r\nimport { createPrimaryMarkerElement } from \"../../marker\";\r\nimport { ClusterDisplayItem } from \"../../utils/clustering\";\r\n\r\nexport type MapboxMarkerHandle = {\r\n  setLngLat(lngLat: [number, number]): MapboxMarkerHandle;\r\n  addTo(map: any): MapboxMarkerHandle;\r\n  remove(): void;\r\n  getElement(): HTMLElement;\r\n};\r\n\r\nexport type MapboxNamespace = {\r\n  Marker: new (options?: {\r\n    element?: HTMLElement;\r\n    anchor?: string;\r\n  }) => MapboxMarkerHandle;\r\n};\r\n\r\ntype MapboxMarkerManagerOptions = {\r\n  mapInstance: any;\r\n  mapboxgl: MapboxNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\ntype MarkerEntry = {\r\n  key: string;\r\n  marker: MapboxMarkerHandle;\r\n  kind: \"primary\" | \"dot\";\r\n  parentId?: number;\r\n};\r\n\r\nexport class MapboxMarkerManager {\r\n  private readonly mapInstance: any;\r\n  private readonly MarkerCtor?: MapboxNamespace[\"Marker\"];\r\n  private readonly onMarkerClick?: (marker: Property) => void;\r\n  private markerCache = new Map<string, MarkerEntry>();\r\n\r\n  constructor(options: MapboxMarkerManagerOptions) {\r\n    this.mapInstance = options.mapInstance;\r\n    this.MarkerCtor = options.mapboxgl?.Marker;\r\n    this.onMarkerClick = options.onMarkerClick;\r\n  }\r\n\r\n  render(items: ClusterDisplayItem[]) {\r\n    if (!this.MarkerCtor) {\r\n      return;\r\n    }\r\n\r\n    // Create a set of keys for the new items\r\n    const newKeys = new Set(items.map((item) => item.key));\r\n\r\n    // Remove markers that are no longer needed\r\n    for (const [key, entry] of this.markerCache.entries()) {\r\n      if (!newKeys.has(key)) {\r\n        try {\r\n          entry.marker.remove();\r\n        } catch {\r\n          // swallow removal errors\r\n        }\r\n        this.markerCache.delete(key);\r\n      }\r\n    }\r\n\r\n    // Add or update markers\r\n    for (const item of items) {\r\n      const coords = safeLatLon(item.marker.location);\r\n      if (!coords) continue;\r\n\r\n      const existing = this.markerCache.get(item.key);\r\n\r\n      if (existing) {\r\n        // Update existing marker position if needed\r\n        try {\r\n          existing.marker.setLngLat([coords.lon, coords.lat]);\r\n        } catch {\r\n          // If update fails, remove and recreate\r\n          try {\r\n            existing.marker.remove();\r\n          } catch {\r\n            // swallow\r\n          }\r\n          this.markerCache.delete(item.key);\r\n          this.createAndAddMarker(item, coords);\r\n        }\r\n      } else {\r\n        // Create new marker\r\n        this.createAndAddMarker(item, coords);\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const entry of this.markerCache.values()) {\r\n      try {\r\n        entry.marker.remove();\r\n      } catch {\r\n        // swallow removal errors\r\n      }\r\n    }\r\n    this.markerCache.clear();\r\n  }\r\n\r\n  private createAndAddMarker(\r\n    item: ClusterDisplayItem,\r\n    coords: { lon: number; lat: number }\r\n  ) {\r\n    if (!this.MarkerCtor) return;\r\n\r\n    const element =\r\n      item.kind === \"primary\"\r\n        ? createPrimaryMarkerElement(item, this.onMarkerClick)\r\n        : createDotMarkerElement(item, this.onMarkerClick);\r\n\r\n    if (!element) return;\r\n\r\n    try {\r\n      const marker = new this.MarkerCtor({\r\n        element,\r\n        anchor: item.kind === \"primary\" ? \"bottom\" : \"center\",\r\n      })\r\n        .setLngLat([coords.lon, coords.lat])\r\n        .addTo(this.mapInstance);\r\n\r\n      this.markerCache.set(item.key, {\r\n        key: item.key,\r\n        marker,\r\n        kind: item.kind,\r\n        parentId: item.kind === \"dot\" ? item.parentId : undefined,\r\n      });\r\n    } catch {\r\n      // swallow marker creation errors\r\n    }\r\n  }\r\n}\r\n\r\nfunction safeLatLon(location?: { lon?: number; lat?: number }) {\r\n  if (typeof location?.lon !== \"number\" || typeof location?.lat !== \"number\") {\r\n    return null;\r\n  }\r\n  if (Number.isNaN(location.lon) || Number.isNaN(location.lat)) {\r\n    return null;\r\n  }\r\n  return { lon: location.lon, lat: location.lat };\r\n}\r\n","export {\r\n  MapLibreMarkerManager,\r\n  type MapLibreMarkerHandle,\r\n  type MapLibreNamespace,\r\n} from \"./maplibre/markermanager\";\r\n\r\nexport {\r\n  GoogleMapsMarkerManager,\r\n  type GoogleMapsMarkerHandle,\r\n  type GoogleMapsNamespace,\r\n} from \"./google/markermanager\";\r\n\r\nexport {\r\n  MapboxMarkerManager,\r\n  type MapboxMarkerHandle,\r\n  type MapboxNamespace,\r\n} from \"./mapbox/markermanager\";\r\n\r\n/**\r\n * Abstract base class for map adapters supporting different map libraries\r\n */\r\nexport abstract class MapAdapter {\r\n  protected map: any;\r\n\r\n  constructor(map: any) {\r\n    this.map = map;\r\n  }\r\n\r\n  /**\r\n   * Get the underlying map instance\r\n   * @returns {any} The native map instance\r\n   */\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n\r\n  /**\r\n   * Initialize the adapter with platform-specific configuration\r\n   * @param {any} options Platform-specific initialization options\r\n   * @returns {any} The marker manager instance\r\n   */\r\n  abstract initialize(options: any): any;\r\n\r\n  /**\r\n   * Get the marker manager instance\r\n   * @returns {any} The marker manager\r\n   */\r\n  abstract getMarkerManager(): any;\r\n\r\n  /**\r\n   * Clean up event listeners and resources\r\n   */\r\n  abstract cleanup(): void;\r\n\r\n  /**\r\n   * Get the current center coordinates of the map\r\n   * @returns {{ lng: number; lat: number }} [longitude, latitude]\r\n   */\r\n  abstract getCenter(): { lng: number; lat: number };\r\n\r\n  /**\r\n   * Get the current zoom level of the map\r\n   * @returns {number} Current zoom level\r\n   */\r\n  abstract getZoom(): number;\r\n\r\n  /**\r\n   * Get the current bearing (rotation) of the map\r\n   * @returns {number} Bearing in degrees\r\n   */\r\n  abstract getBearing(): number;\r\n\r\n  /**\r\n   * Get the current pitch (tilt) of the map\r\n   * @returns {number} Pitch in degrees\r\n   */\r\n  abstract getPitch(): number;\r\n\r\n  /**\r\n   * Get the current bounds of the map viewport\r\n   * @returns {MapBounds} Map bounds with southwest and northeast corners\r\n   */\r\n  abstract getMapBounds(): MapBounds;\r\n\r\n  /**\r\n   * Project a geographical coordinate to screen space\r\n   * @param {[number, number]} lngLat [longitude, latitude]\r\n   * @returns {{ x: number; y: number }} Screen coordinates\r\n   */\r\n  abstract project(lngLat: [number, number]): { x: number; y: number };\r\n}\r\n\r\nexport type LngLat = { lng: number; lat: number };\r\n\r\nexport type MapBounds = {\r\n  sw: { lat: number; lng: number };\r\n  ne: { lat: number; lng: number };\r\n};\r\n","import { MapAdapter, type LngLat, type MapBounds } from \"./index\";\nimport {\n  MapLibreMarkerManager,\n  type MapLibreNamespace,\n} from \"./maplibre/markermanager\";\nimport type { Property } from \"../types\";\n\nexport class MapLibreAdapter extends MapAdapter {\n  private markerManager?: MapLibreMarkerManager;\n  private cleanupFns: Array<() => void> = [];\n\n  constructor(map: any) {\n    super(map);\n  }\n\n  initialize(options: {\n    maplibregl: MapLibreNamespace;\n    onMarkerClick?: (marker: Property) => void;\n    onRefresh?: () => void;\n  }) {\n    this.markerManager = new MapLibreMarkerManager({\n      mapInstance: this.map,\n      maplibregl: options.maplibregl,\n      onMarkerClick: options.onMarkerClick,\n    });\n\n    if (options.onRefresh) {\n      this.attachEventListeners(options.onRefresh);\n    }\n\n    return this.markerManager;\n  }\n\n  private attachEventListeners(onRefresh: () => void) {\n    if (!this.map || typeof this.map.on !== \"function\") {\n      return;\n    }\n    const events = [\"move\", \"zoom\", \"dragend\", \"pitch\", \"rotate\"];\n    events.forEach((eventName) => {\n      this.map.on(eventName, onRefresh);\n      this.cleanupFns.push(() => {\n        if (typeof this.map.off === \"function\") {\n          this.map.off(eventName, onRefresh);\n        }\n      });\n    });\n  }\n\n  getMarkerManager() {\n    return this.markerManager;\n  }\n\n  cleanup() {\n    for (const cleanup of this.cleanupFns) {\n      try {\n        cleanup();\n      } catch {\n        // ignore\n      }\n    }\n    this.cleanupFns.length = 0;\n  }\n\n  getMap(): any {\n    return this.map;\n  }\n\n  getCenter(): LngLat {\n    const center = this.map.getCenter();\n    return { lng: center.lng, lat: center.lat };\n  }\n\n  getZoom(): number {\n    return this.map.getZoom();\n  }\n\n  getBearing(): number {\n    return this.map.getBearing();\n  }\n\n  getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  getMapBounds(): MapBounds {\n    const bounds = this.map.getBounds();\n    const sw = bounds.getSouthWest();\n    const ne = bounds.getNorthEast();\n    return {\n      sw: { lat: sw.lat, lng: sw.lng },\n      ne: { lat: ne.lat, lng: ne.lng },\n    };\n  }\n\n  project(lngLat: [number, number]) {\n    return this.map.project({ lng: lngLat[0], lat: lngLat[1] });\n  }\n\n  on(event: string, handler: (...args: any[]) => void): void {\n    this.map.on(event, handler);\n  }\n\n  off(event: string, handler: (...args: any[]) => void): void {\n    this.map.off(event, handler);\n  }\n\n  resize(): void {\n    this.map.resize();\n  }\n\n  remove(): void {\n    this.cleanup();\n    this.map.remove();\n  }\n}\n","import { MapAdapter, type LngLat, type MapBounds } from \"./index\";\r\nimport {\r\n  GoogleMapsMarkerManager,\r\n  type GoogleMapsNamespace,\r\n} from \"./google/markermanager\";\r\nimport type { Property } from \"../types\";\r\n\r\nexport class GoogleMapsAdapter extends MapAdapter {\r\n  private overlayView: any;\r\n  private markerManager?: GoogleMapsMarkerManager;\r\n  private cleanupFns: Array<() => void> = [];\r\n\r\n  constructor(map: any) {\r\n    super(map);\r\n    this.initializeOverlayView();\r\n  }\r\n\r\n  initialize(options: {\r\n    google: GoogleMapsNamespace;\r\n    onMarkerClick?: (marker: Property) => void;\r\n    onRefresh?: () => void;\r\n  }) {\r\n    this.markerManager = new GoogleMapsMarkerManager({\r\n      mapInstance: this.map,\r\n      google: options.google,\r\n      onMarkerClick: options.onMarkerClick,\r\n    });\r\n\r\n    if (options.onRefresh) {\r\n      this.attachEventListeners(options.onRefresh);\r\n    }\r\n\r\n    return this.markerManager;\r\n  }\r\n\r\n  private attachEventListeners(onRefresh: () => void) {\r\n    const events = [\r\n      \"center_changed\",\r\n      \"zoom_changed\",\r\n      \"drag\",\r\n      \"heading_changed\",\r\n      \"tilt_changed\",\r\n    ];\r\n    const listeners: any[] = [];\r\n\r\n    events.forEach((eventName) => {\r\n      const listener = this.map.addListener(eventName, onRefresh);\r\n      listeners.push(listener);\r\n    });\r\n\r\n    this.cleanupFns.push(() => {\r\n      listeners.forEach((listener) => {\r\n        try {\r\n          listener.remove();\r\n        } catch {\r\n          // ignore\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  getMarkerManager() {\r\n    return this.markerManager;\r\n  }\r\n\r\n  cleanup() {\r\n    for (const cleanup of this.cleanupFns) {\r\n      try {\r\n        cleanup();\r\n      } catch {\r\n        // ignore\r\n      }\r\n    }\r\n    this.cleanupFns.length = 0;\r\n  }\r\n\r\n  private initializeOverlayView() {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (!googleMaps) return;\r\n\r\n    // Create a custom overlay to access the projection\r\n    const OverlayView = googleMaps.OverlayView;\r\n    if (!OverlayView) return;\r\n\r\n    this.overlayView = new OverlayView();\r\n    this.overlayView.draw = function () {}; // Required method\r\n    this.overlayView.setMap(this.map);\r\n  }\r\n\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n\r\n  getCenter(): LngLat {\r\n    const center = this.map.getCenter();\r\n    if (!center) {\r\n      return { lng: 0, lat: 0 };\r\n    }\r\n    return { lng: center.lng(), lat: center.lat() };\r\n  }\r\n\r\n  getZoom(): number {\r\n    return this.map.getZoom() ?? 0;\r\n  }\r\n\r\n  getBearing(): number {\r\n    return this.map.getHeading() ?? 0;\r\n  }\r\n\r\n  getPitch(): number {\r\n    return this.map.getTilt() ?? 0;\r\n  }\r\n\r\n  getMapBounds(): MapBounds {\r\n    const bounds = this.map.getBounds();\r\n    if (!bounds) {\r\n      return {\r\n        sw: { lat: 0, lng: 0 },\r\n        ne: { lat: 0, lng: 0 },\r\n      };\r\n    }\r\n    const sw = bounds.getSouthWest();\r\n    const ne = bounds.getNorthEast();\r\n    return {\r\n      sw: { lat: sw.lat(), lng: sw.lng() },\r\n      ne: { lat: ne.lat(), lng: ne.lng() },\r\n    };\r\n  }\r\n\r\n  project(lngLat: [number, number]): { x: number; y: number } {\r\n    if (!this.overlayView) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const projection = this.overlayView.getProjection();\r\n    if (!projection) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (!googleMaps) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const latLng = new googleMaps.LatLng(lngLat[1], lngLat[0]);\r\n    const point = projection.fromLatLngToContainerPixel(latLng);\r\n\r\n    if (!point) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    return {\r\n      x: point.x,\r\n      y: point.y,\r\n    };\r\n  }\r\n\r\n  on(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.addListener(event, handler);\r\n  }\r\n\r\n  off(event: string, handler: (...args: any[]) => void): void {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (googleMaps?.event) {\r\n      googleMaps.event.clearListeners(this.map, event);\r\n    }\r\n  }\r\n\r\n  resize(): void {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (googleMaps?.event) {\r\n      googleMaps.event.trigger(this.map, \"resize\");\r\n    }\r\n  }\r\n\r\n  remove(): void {\r\n    this.cleanup();\r\n    // Clean up overlay view\r\n    if (this.overlayView) {\r\n      this.overlayView.setMap(null);\r\n      this.overlayView = null;\r\n    }\r\n    // Google Maps doesn't have a remove method\r\n    // Users should handle cleanup themselves\r\n  }\r\n}\r\n","import { MapAdapter, type LngLat, type MapBounds } from \"./index\";\r\nimport {\r\n  MapboxMarkerManager,\r\n  type MapboxNamespace,\r\n} from \"./mapbox/markermanager\";\r\nimport type { Property } from \"../types\";\r\n\r\nexport class MapboxAdapter extends MapAdapter {\r\n  private markerManager?: MapboxMarkerManager;\r\n  private cleanupFns: Array<() => void> = [];\r\n\r\n  constructor(map: any) {\r\n    super(map);\r\n  }\r\n\r\n  initialize(options: {\r\n    mapboxgl: MapboxNamespace;\r\n    onMarkerClick?: (marker: Property) => void;\r\n    onRefresh?: () => void;\r\n  }) {\r\n    this.markerManager = new MapboxMarkerManager({\r\n      mapInstance: this.map,\r\n      mapboxgl: options.mapboxgl,\r\n      onMarkerClick: options.onMarkerClick,\r\n    });\r\n\r\n    if (options.onRefresh) {\r\n      this.attachEventListeners(options.onRefresh);\r\n    }\r\n\r\n    return this.markerManager;\r\n  }\r\n\r\n  private attachEventListeners(onRefresh: () => void) {\r\n    if (!this.map || typeof this.map.on !== \"function\") {\r\n      return;\r\n    }\r\n    const events = [\"move\", \"zoom\", \"dragend\", \"pitch\", \"rotate\"];\r\n    events.forEach((eventName) => {\r\n      this.map.on(eventName, onRefresh);\r\n      this.cleanupFns.push(() => {\r\n        if (typeof this.map.off === \"function\") {\r\n          this.map.off(eventName, onRefresh);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  getMarkerManager() {\r\n    return this.markerManager;\r\n  }\r\n\r\n  cleanup() {\r\n    for (const cleanup of this.cleanupFns) {\r\n      try {\r\n        cleanup();\r\n      } catch {\r\n        // ignore\r\n      }\r\n    }\r\n    this.cleanupFns.length = 0;\r\n  }\r\n\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n\r\n  getCenter(): LngLat {\r\n    const center = this.map.getCenter();\r\n    return { lng: center.lng, lat: center.lat };\r\n  }\r\n\r\n  getZoom(): number {\r\n    return this.map.getZoom();\r\n  }\r\n\r\n  getBearing(): number {\r\n    return this.map.getBearing();\r\n  }\r\n\r\n  getPitch(): number {\r\n    return this.map.getPitch();\r\n  }\r\n\r\n  getMapBounds(): MapBounds {\r\n    const bounds = this.map.getBounds();\r\n    const sw = bounds.getSouthWest();\r\n    const ne = bounds.getNorthEast();\r\n    return {\r\n      sw: { lat: sw.lat, lng: sw.lng },\r\n      ne: { lat: ne.lat, lng: ne.lng },\r\n    };\r\n  }\r\n\r\n  project(lngLat: [number, number]) {\r\n    return this.map.project({ lng: lngLat[0], lat: lngLat[1] });\r\n  }\r\n\r\n  on(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.on(event, handler);\r\n  }\r\n\r\n  off(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.off(event, handler);\r\n  }\r\n\r\n  resize(): void {\r\n    this.map.resize();\r\n  }\r\n\r\n  remove(): void {\r\n    this.cleanup();\r\n    this.map.remove();\r\n  }\r\n}\r\n","import { MapAdapter } from \"../adapters\";\r\nimport { Property, PropertyType } from \"../types\";\r\n\r\nexport type ClusterDisplayItem =\r\n  | {\r\n      kind: \"primary\";\r\n      marker: Property;\r\n      key: string;\r\n    }\r\n  | {\r\n      kind: \"dot\";\r\n      marker: Property;\r\n      key: string;\r\n      parentId: number;\r\n    };\r\n\r\nexport type ViewStateSnapshot = {\r\n  longitude: number;\r\n  latitude: number;\r\n  zoom: number;\r\n  bearing: number;\r\n  pitch: number;\r\n};\r\n\r\nexport type ClusterParams = {\r\n  primaryType: PropertyType;\r\n  markers: Property[];\r\n  map: MapAdapter | null;\r\n  selectedMarkerId: number | null;\r\n  zoom: number;\r\n  collisionThresholdPx?: number;\r\n  dotCollisionThresholdPx?: number;\r\n};\r\n\r\nexport type ProjectedMarker = {\r\n  marker: Property;\r\n  index: number;\r\n  x: number;\r\n  y: number;\r\n};\r\n\r\nexport function extractViewState(mapInstance: MapAdapter): ViewStateSnapshot {\r\n  const center = mapInstance.getCenter();\r\n  return {\r\n    longitude: center.lng,\r\n    latitude: center.lat,\r\n    zoom: mapInstance.getZoom(),\r\n    bearing: mapInstance.getBearing(),\r\n    pitch: mapInstance.getPitch(),\r\n  };\r\n}\r\n\r\nconst COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS: Array<{\r\n  zoom: number;\r\n  threshold: number;\r\n}> = [\r\n  { zoom: 6, threshold: 120 },\r\n  { zoom: 8, threshold: 108 },\r\n  { zoom: 10, threshold: 92 },\r\n  { zoom: 12, threshold: 80 },\r\n  { zoom: 14, threshold: 68 },\r\n  { zoom: 16, threshold: 56 },\r\n];\r\n\r\nfunction resolveCollisionThreshold(zoom: number) {\r\n  for (const breakpoint of COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS) {\r\n    if (zoom <= breakpoint.zoom) {\r\n      return breakpoint.threshold;\r\n    }\r\n  }\r\n  return 48;\r\n}\r\n\r\nexport function clusterMarkers({\r\n  primaryType,\r\n  markers,\r\n  map,\r\n  selectedMarkerId,\r\n  zoom,\r\n  collisionThresholdPx,\r\n  dotCollisionThresholdPx,\r\n}: ClusterParams): ClusterDisplayItem[] {\r\n  if (!markers.length) return [];\r\n  if (!map) {\r\n    return markers.map((marker) => ({\r\n      kind: \"primary\" as const,\r\n      marker,\r\n      key: `primary-${marker.tripadvisor_id}`,\r\n    }));\r\n  }\r\n\r\n  const projected: ProjectedMarker[] = markers\r\n    .map((marker, index) => {\r\n      const location = marker.location as { lon?: number; lat?: number };\r\n      if (\r\n        typeof location?.lon !== \"number\" ||\r\n        typeof location?.lat !== \"number\"\r\n      ) {\r\n        return null;\r\n      }\r\n      const { x, y } = map.project([location.lon, location.lat]);\r\n      return { marker, index, x, y };\r\n    })\r\n    .filter((value): value is ProjectedMarker => Boolean(value));\r\n\r\n  if (!projected.length) {\r\n    return [];\r\n  }\r\n\r\n  const threshold = resolveCollisionThreshold(zoom);\r\n  const dotThreshold = resolveDotCollisionThreshold(zoom);\r\n  const parent = projected.map((_, idx) => idx);\r\n\r\n  const find = (i: number): number => {\r\n    if (parent[i] === i) return i;\r\n    parent[i] = find(parent[i]);\r\n    return parent[i];\r\n  };\r\n\r\n  const union = (a: number, b: number) => {\r\n    const rootA = find(a);\r\n    const rootB = find(b);\r\n    if (rootA === rootB) return;\r\n    parent[rootB] = rootA;\r\n  };\r\n\r\n  for (let i = 0; i < projected.length; i += 1) {\r\n    for (let j = i + 1; j < projected.length; j += 1) {\r\n      const dx = projected[i].x - projected[j].x;\r\n      const dy = projected[i].y - projected[j].y;\r\n      if (Math.hypot(dx, dy) <= threshold) {\r\n        union(i, j);\r\n      }\r\n    }\r\n  }\r\n\r\n  const groups = new Map<number, ProjectedMarker[]>();\r\n  for (const item of projected) {\r\n    const root = find(item.index);\r\n    const group = groups.get(root);\r\n    if (group) {\r\n      group.push(item);\r\n    } else {\r\n      groups.set(root, [item]);\r\n    }\r\n  }\r\n\r\n  const clustered: ClusterDisplayItem[] = [];\r\n\r\n  groups.forEach((groupItems) => {\r\n    if (groupItems.length === 1) {\r\n      const [{ marker }] = groupItems;\r\n      clustered.push({\r\n        kind: \"primary\",\r\n        marker,\r\n        key: `primary-${marker.tripadvisor_id}`,\r\n      });\r\n      return;\r\n    }\r\n\r\n    const sorted = [...groupItems].sort((a, b) =>\r\n      compareMarkers(b.marker, a.marker, primaryType)\r\n    );\r\n    const [primary, ...rest] = sorted;\r\n    clustered.push({\r\n      kind: \"primary\",\r\n      marker: primary.marker,\r\n      key: `primary-${primary.marker.tripadvisor_id}`,\r\n    });\r\n\r\n    if (!rest.length) return;\r\n\r\n    const dotCandidates: ProjectedMarker[] = [];\r\n    const remainder: ProjectedMarker[] = [];\r\n\r\n    rest.forEach((item) => {\r\n      if (selectedMarkerId && item.marker.tripadvisor_id === selectedMarkerId) {\r\n        clustered.push({\r\n          kind: \"primary\",\r\n          marker: item.marker,\r\n          key: `primary-${item.marker.tripadvisor_id}`,\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (distancePx(primary, item) <= dotThreshold) {\r\n        dotCandidates.push(item);\r\n      } else {\r\n        remainder.push(item);\r\n      }\r\n    });\r\n\r\n    dotCandidates.forEach((item) => {\r\n      clustered.push({\r\n        kind: \"dot\",\r\n        marker: item.marker,\r\n        key: `dot-${item.marker.tripadvisor_id}`,\r\n        parentId: primary.marker.tripadvisor_id,\r\n      });\r\n    });\r\n\r\n    if (remainder.length) {\r\n      const followUp = clusterMarkers({\r\n        markers: remainder.map((item) => item.marker),\r\n        map,\r\n        selectedMarkerId,\r\n        zoom,\r\n        primaryType,\r\n        collisionThresholdPx,\r\n        dotCollisionThresholdPx,\r\n      });\r\n      clustered.push(...followUp);\r\n    }\r\n  });\r\n\r\n  return clustered;\r\n}\r\n\r\nfunction distancePx(a: ProjectedMarker, b: ProjectedMarker) {\r\n  return Math.hypot(a.x - b.x, a.y - b.y);\r\n}\r\n\r\nfunction resolveDotCollisionThreshold(zoom: number) {\r\n  const base = resolveCollisionThreshold(zoom);\r\n  return Math.max(48, base);\r\n}\r\n\r\nfunction compareMarkers(a: Property, b: Property, primaryType: PropertyType) {\r\n  const aIsPrimary = a.type === primaryType;\r\n  const bIsPrimary = b.type === primaryType;\r\n  if (aIsPrimary && !bIsPrimary) return 1;\r\n  if (!aIsPrimary && bIsPrimary) return -1;\r\n\r\n  const ratingDiff = resolveRating(a) - resolveRating(b);\r\n  if (ratingDiff !== 0) return ratingDiff;\r\n\r\n  const priceDiff = resolvePrice(a) - resolvePrice(b);\r\n  if (priceDiff !== 0) return priceDiff;\r\n\r\n  const reviewsDiff = (a.reviews ?? 0) - (b.reviews ?? 0);\r\n  if (reviewsDiff !== 0) return reviewsDiff;\r\n\r\n  return a.tripadvisor_id - b.tripadvisor_id;\r\n}\r\n\r\nfunction resolveRating(marker: Property) {\r\n  if (typeof marker.rating === \"number\") return marker.rating;\r\n  if (marker.rating === undefined || marker.rating === null) return -Infinity;\r\n  const parsed = Number(marker.rating);\r\n  return Number.isNaN(parsed) ? -Infinity : parsed;\r\n}\r\n\r\nfunction resolvePrice(marker: Property) {\r\n  if (!marker.pricing?.offer?.price) return -Infinity;\r\n  const numeric = Number(\r\n    (marker.pricing.offer.displayPrice ?? \"0\")\r\n      .replace(/[^0-9.,-]+/g, \"\")\r\n      .replace(/,/g, \"\")\r\n  );\r\n  return Number.isNaN(numeric) ? -Infinity : numeric;\r\n}\r\n\r\nexport function metersToPixels(meters: number, latitude: number, zoom: number) {\r\n  const metersPerPixel =\r\n    (Math.cos((latitude * Math.PI) / 180) * 2 * Math.PI * 6378137) /\r\n    (256 * 2 ** zoom);\r\n  if (!Number.isFinite(metersPerPixel) || metersPerPixel <= 0) {\r\n    return meters;\r\n  }\r\n  return meters / metersPerPixel;\r\n}\r\n"],"mappings":"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","names":["index_exports","__export","MapFirstCore","styleInject","css","insertAt","head","style","styleInject","createDotMarkerElement","item","onMarkerClick","_a","_b","_c","marker","isPending","container","button","evt","AWARD_SVG","AWARD_BACK_SVG","EAT_DRINK_SVG","ATTRACTION_SVG","createPrimaryMarkerElement","item","onMarkerClick","_a","_b","_c","_d","_e","_f","_g","_h","marker","isAccommodation","hasPrice","isPending","ratingLabel","numeric","root","pill","badge","awardContainer","backLayer","colorDot","frontLayer","content","evt","MapLibreMarkerManager","options","_a","items","newKeys","item","key","entry","coords","safeLatLon","existing","element","createPrimaryMarkerElement","createDotMarkerElement","marker","location","GoogleMapsMarkerManager","options","items","_a","_b","newKeys","item","key","entry","error","coords","safeLatLon","existing","element","createPrimaryMarkerElement","createDotMarkerElement","marker","location","MapboxMarkerManager","options","_a","items","newKeys","item","key","entry","coords","safeLatLon","existing","element","createPrimaryMarkerElement","createDotMarkerElement","marker","location","MapAdapter","map","MapLibreAdapter","MapAdapter","map","options","MapLibreMarkerManager","onRefresh","eventName","cleanup","center","bounds","sw","ne","lngLat","event","handler","GoogleMapsAdapter","MapAdapter","map","options","GoogleMapsMarkerManager","onRefresh","events","listeners","eventName","listener","cleanup","_a","googleMaps","OverlayView","center","bounds","sw","ne","lngLat","projection","latLng","point","event","handler","MapboxAdapter","MapAdapter","map","options","MapboxMarkerManager","onRefresh","eventName","cleanup","center","bounds","sw","ne","lngLat","event","handler","extractViewState","mapInstance","center","COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS","resolveCollisionThreshold","zoom","breakpoint","clusterMarkers","primaryType","markers","map","selectedMarkerId","collisionThresholdPx","dotCollisionThresholdPx","marker","projected","index","location","x","value","threshold","dotThreshold","resolveDotCollisionThreshold","parent","_","idx","find","i","union","a","b","rootA","rootB","j","dx","dy","groups","item","root","group","clustered","groupItems","sorted","compareMarkers","primary","rest","dotCandidates","remainder","distancePx","followUp","base","_a","_b","aIsPrimary","bIsPrimary","ratingDiff","resolveRating","priceDiff","resolvePrice","reviewsDiff","parsed","_c","numeric","DEFAULT_PRIMARY_TYPE","MapFirstCore","options","_a","_b","_c","_d","_e","isMapLibreOptions","adapter","MapLibreAdapter","shouldAutoSelect","marker","isGoogleMapsOptions","GoogleMapsAdapter","isMapboxOptions","MapboxAdapter","markers","primary","markerId","viewState","primaryType","clusterMarkers","extractViewState"]}