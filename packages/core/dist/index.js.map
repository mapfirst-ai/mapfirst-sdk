{"version":3,"sources":["../src/index.ts","#style-inject:#style-inject","../src/markers.css","../src/dotmarker.ts","../src/marker.ts","../src/marker-updater.ts","../src/adapters/markermanager.ts","../src/adapters/maplibre/markermanager.ts","../src/adapters/google/markermanager.ts","../src/adapters/mapbox/markermanager.ts","../src/adapters/index.ts","../src/adapters/maplibre/index.ts","../src/adapters/google/index.ts","../src/adapters/mapbox/index.ts","../src/utils/clustering.ts"],"sourcesContent":["import type { MapAdapter } from \"./adapters\";\nimport { MapLibreAdapter } from \"./adapters/maplibre\";\nimport { GoogleMapsAdapter } from \"./adapters/google\";\nimport { MapboxAdapter } from \"./adapters/mapbox\";\nimport type {\n  APIResponse,\n  FilterSchema,\n  HotelPricingAPIResponse,\n  InitialLocationData,\n  InitialRequestBody,\n  PollOptions,\n  Price,\n  PriceLevel,\n  Property,\n  PropertyType,\n  SmartFilter,\n} from \"./types\";\nimport type { MapLibreNamespace } from \"./adapters/maplibre/markermanager\";\nimport type { GoogleMapsNamespace } from \"./adapters/google/markermanager\";\nimport type { MapboxNamespace } from \"./adapters/mapbox/markermanager\";\nimport {\n  ClusterDisplayItem,\n  clusterMarkers,\n  extractViewState,\n  ViewStateSnapshot,\n} from \"./utils/clustering\";\nimport type {\n  MapBounds,\n  ViewState,\n  ActiveLocation,\n  FilterState,\n  MapState,\n  MapStateCallbacks,\n  MapStateUpdate,\n} from \"./state-types\";\n\nexport type {\n  Property,\n  PropertyType,\n  PriceLevel,\n  Price,\n  FilterSchema,\n  Locale,\n  SmartFilter,\n} from \"./types\";\n\nexport type {\n  MapBounds,\n  ViewState,\n  ActiveLocation,\n  FilterState,\n  MapState,\n  MapStateCallbacks,\n  MapStateUpdate,\n} from \"./state-types\";\n\nexport type { MapLibreNamespace } from \"./adapters/maplibre/markermanager\";\n\nexport type { GoogleMapsNamespace } from \"./adapters/google/markermanager\";\n\nexport type { MapboxNamespace } from \"./adapters/mapbox/markermanager\";\n\n// Environment configuration\nexport type Environment = \"prod\" | \"test\";\n\nconst API_URLS: Record<Environment, string> = {\n  prod: \"https://api.mapfirst.ai\",\n  test: \"https://ta-backend-test-290791666935.us-central1.run.app\",\n};\n\n// Properties fetch error class\nexport class PropertiesFetchError extends Error {\n  status: number;\n  code?: string;\n\n  constructor({\n    message,\n    status,\n    code,\n  }: {\n    message: string;\n    status: number;\n    code?: string;\n  }) {\n    super(message);\n    this.name = \"PropertiesFetchError\";\n    this.status = status;\n    this.code = code;\n  }\n}\n\ntype PropertiesErrorResponse = {\n  error?: string;\n  detail?: string;\n  code?: string;\n};\n\ntype FetchPropertiesOptions = {\n  signal?: AbortSignal;\n};\n\n// Fetch properties from API\nexport async function fetchProperties<TBody = any, TResponse = any>(\n  url: string,\n  body: TBody,\n  { signal }: FetchPropertiesOptions = {}\n): Promise<TResponse> {\n  const response = await fetch(url, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(body),\n    signal,\n  });\n\n  if (!response.ok) {\n    let message = `Unexpected response: ${response.status}`;\n    let code: string | undefined;\n    try {\n      const errorBody = (await response.json()) as PropertiesErrorResponse;\n      message = errorBody.detail ?? errorBody.error ?? message;\n      code = errorBody.code;\n    } catch {\n      // ignore JSON parsing errors and fall back to status-based message\n    }\n    throw new PropertiesFetchError({ message, status: response.status, code });\n  }\n\n  return (await response.json()) as TResponse;\n}\n\n// Helper function to convert Date to ISO date string (YYYY-MM-DD)\nfunction toISO(date: Date | string): string {\n  if (typeof date === \"string\") return date;\n  return date.toISOString().slice(0, 10);\n}\n\nexport type BaseMapFirstOptions = {\n  properties?: Property[];\n  primaryType?: PropertyType;\n  selectedMarkerId?: number | null;\n  clusterRadiusMeters?: number;\n  autoSelectOnClick?: boolean;\n  onClusterUpdate?: (\n    clusters: ClusterDisplayItem[],\n    viewState: ViewStateSnapshot | null\n  ) => void;\n  // State management options\n  state?: Partial<MapState>;\n  callbacks?: MapStateCallbacks;\n  // API configuration\n  environment?: Environment;\n  mfid?: string;\n  requestBody?: any;\n  // Initial location data (alternative to requestBody)\n  initialLocationData?: InitialLocationData;\n  // Map behavior options\n  fitBoundsPadding?: {\n    top?: number;\n    bottom?: number;\n    left?: number;\n    right?: number;\n  };\n  apiUrl?: string;\n};\n\ntype AdapterDrivenOptions = BaseMapFirstOptions & {\n  adapter: MapAdapter;\n  platform?: undefined;\n};\n\ntype MapLibreOptions = BaseMapFirstOptions & {\n  platform: \"maplibre\";\n  mapInstance?: any;\n  maplibregl: MapLibreNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\ntype GoogleMapsOptions = BaseMapFirstOptions & {\n  platform: \"google\";\n  mapInstance?: any; // google.maps.Map\n  google: GoogleMapsNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\ntype MapboxOptions = BaseMapFirstOptions & {\n  platform: \"mapbox\";\n  mapInstance?: any;\n  mapboxgl: MapboxNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\nexport type MapFirstOptions =\n  | AdapterDrivenOptions\n  | MapLibreOptions\n  | GoogleMapsOptions\n  | MapboxOptions;\n\nconst DEFAULT_PRIMARY_TYPE: PropertyType = \"Accommodation\";\n\n// Helper function to calculate default check-in/check-out dates\nfunction getDefaultDates(): { checkIn: Date; checkOut: Date } {\n  const dayMs = 24 * 60 * 60 * 1000;\n  const base = new Date(Date.now() + 10 * dayMs);\n  const daysUntilSaturday = (6 - base.getDay() + 7) % 7;\n  const checkIn = new Date(base.getTime() + daysUntilSaturday * dayMs);\n  const startDay = checkIn.getDay();\n  const daysUntilWeekend = startDay === 0 ? 6 : 6 - startDay;\n  const checkOut = new Date(checkIn.getTime() + (daysUntilWeekend + 1) * dayMs);\n  return { checkIn, checkOut };\n}\n\nexport class MapFirstCore {\n  private adapter: MapAdapter | null = null;\n  private properties: Property[] = [];\n  private primaryType?: PropertyType;\n  private selectedMarkerId: number | null = null;\n  private destroyed = false;\n  private clusterItems: ClusterDisplayItem[] = [];\n  private isMapAttached = false;\n\n  // State management\n  private state: MapState;\n  private callbacks: MapStateCallbacks;\n\n  // API configuration\n  private readonly environment: Environment;\n  private readonly apiUrl: string;\n  private readonly mfid?: string;\n  private currentPlatform: \"google\" | \"maplibre\" | \"mapbox\" | undefined;\n  private requestBody?: any;\n  private readonly fitBoundsPadding: {\n    top: number;\n    bottom: number;\n    left: number;\n    right: number;\n  };\n\n  constructor(private readonly options: MapFirstOptions) {\n    this.properties = [...(options.properties ?? [])];\n    this.primaryType = options.primaryType;\n    this.selectedMarkerId = options.selectedMarkerId ?? null;\n\n    // Initialize API configuration\n    this.environment = options.environment ?? \"prod\";\n    this.apiUrl = options.apiUrl ?? API_URLS[this.environment];\n    this.mfid = options.mfid ?? \"default\";\n    this.requestBody = options.requestBody;\n    this.currentPlatform = options.platform;\n\n    // Determine if using Google Maps\n    const isGoogleMaps = isGoogleMapsOptions(options);\n\n    // Set default padding based on platform (Google Maps uses 0, others use padding)\n    this.fitBoundsPadding = {\n      top: options.fitBoundsPadding?.top ?? (isGoogleMaps ? 0 : 50),\n      bottom: options.fitBoundsPadding?.bottom ?? (isGoogleMaps ? 0 : 160),\n      left: options.fitBoundsPadding?.left ?? (isGoogleMaps ? 0 : 50),\n      right: options.fitBoundsPadding?.right ?? (isGoogleMaps ? 0 : 50),\n    };\n\n    // Initialize default dates\n    const defaultDates = getDefaultDates();\n\n    // Initialize state\n    this.state = {\n      center: [0, 0],\n      zoom: 0,\n      bounds: null,\n      pendingBounds: null,\n      tempBounds: null,\n      properties: this.properties,\n      primary: this.primaryType ?? DEFAULT_PRIMARY_TYPE,\n      selectedPropertyId: this.selectedMarkerId,\n      initialLoading: true,\n      isSearching: false,\n      firstCallDone: false,\n      filters: {\n        checkIn: defaultDates.checkIn,\n        checkOut: defaultDates.checkOut,\n        numAdults: 2,\n        numRooms: 1,\n        ...(options.initialLocationData?.currency && {\n          currency: options.initialLocationData.currency,\n        }),\n      },\n      activeLocation: {\n        country: \"\",\n        location_id: null,\n        locationName: \"\",\n        coordinates: [0, 0],\n      },\n      isFlyToAnimating: false,\n      ...options.state,\n    };\n\n    this.callbacks = options.callbacks ?? {};\n\n    // Initialize map adapter if mapInstance is provided\n    if (this.hasMapInstance(options)) {\n      this.adapter = this.createAdapter(options);\n      this.isMapAttached = true;\n      this.refresh();\n    }\n\n    // Handle initial location data or auto-load properties\n    if (options.initialLocationData) {\n      this.initializeFromLocationData(options.initialLocationData);\n    } else if (this.requestBody && this.isMapAttached) {\n      this.autoLoadProperties();\n    }\n  }\n\n  private hasMapInstance(options: MapFirstOptions): boolean {\n    if (\"adapter\" in options && options.adapter) return true;\n    if (\"mapInstance\" in options && options.mapInstance) return true;\n    return false;\n  }\n\n  private async initializeFromLocationData(\n    locationData: InitialLocationData\n  ): Promise<void> {\n    try {\n      const { city, country, query, currency } = locationData;\n\n      let requestBody: any = {\n        filters: this.getFilters(),\n        initial: true,\n      };\n\n      // Geo-lookup if city/country provided\n      if ((city && country) || country) {\n        const geoResponse = await fetch(\n          `${this.apiUrl}/geo-lookup?country=${encodeURIComponent(country!)}${\n            city ? `&city=${encodeURIComponent(city)}` : \"\"\n          }`\n        );\n\n        if (geoResponse.ok) {\n          const geoData = await geoResponse.json();\n\n          let finalCity = city;\n          if (\n            geoData.location_name &&\n            geoData.path3_name &&\n            geoData.location_name === geoData.path3_name\n          ) {\n            finalCity = undefined;\n          }\n          if (geoData.location_name) finalCity = geoData.location_name;\n\n          const finalCountry = geoData.path3_name || country;\n\n          requestBody = {\n            ...requestBody,\n            city: finalCity,\n            country: finalCountry,\n            location_id: geoData.location_id,\n            longitude: geoData.longitude,\n            latitude: geoData.latitude,\n          };\n\n          // Update active location\n          this.setActiveLocation({\n            city: finalCity,\n            country: finalCountry,\n            location_id: geoData.location_id,\n            locationName:\n              finalCity && finalCountry\n                ? `${finalCity}, ${finalCountry}`\n                : finalCountry || \"\",\n            coordinates: [geoData.latitude, geoData.longitude],\n          });\n\n          // Update state center\n          this.setState({\n            center: [geoData.latitude, geoData.longitude],\n            zoom: 12,\n          });\n        } else {\n          this.handleError(\n            new Error(`Geo mapping fetch failed: ${geoResponse.statusText}`),\n            \"initializeFromLocationData\"\n          );\n        }\n      } else if (query) {\n        requestBody.query = query;\n      }\n\n      this.requestBody = requestBody;\n\n      // Auto-load properties if map is already attached\n      if (this.isMapAttached) {\n        await this.autoLoadProperties();\n      }\n    } catch (error) {\n      this.handleError(error, \"initializeFromLocationData\");\n    }\n  }\n\n  private async autoLoadProperties(): Promise<void> {\n    if (!this.requestBody) return;\n\n    // Default request body structure based on InitialDataLoader.tsx\n    const defaultRequestBody: InitialRequestBody = {\n      filters: this.getFilters(),\n      initial: true,\n      ...this.requestBody,\n    };\n\n    await this.runPropertiesSearch({\n      body: defaultRequestBody,\n      onError: (error) => {\n        this.handleError(error, \"autoLoadProperties\");\n        this.callbacks.onPropertiesLoadError?.(error);\n      },\n    });\n  }\n\n  attachMap(\n    mapInstance: any,\n    config: {\n      platform: \"maplibre\" | \"google\" | \"mapbox\";\n      maplibregl?: MapLibreNamespace;\n      google?: GoogleMapsNamespace;\n      mapboxgl?: MapboxNamespace;\n      onMarkerClick?: (marker: Property) => void;\n    }\n  ): void {\n    if (this.isMapAttached) {\n      console.warn(\"Map is already attached. Destroying previous adapter.\");\n      if (this.adapter) {\n        const markerManager = this.adapter.getMarkerManager();\n        markerManager?.destroy();\n        this.adapter.cleanup();\n      }\n    }\n\n    const adapterConfig: any = {\n      ...this.options,\n      platform: config.platform,\n      mapInstance,\n      maplibregl: config.maplibregl,\n      google: config.google,\n      mapboxgl: config.mapboxgl,\n      onMarkerClick: config.onMarkerClick,\n    };\n\n    this.currentPlatform = config.platform;\n    this.adapter = this.createAdapter(adapterConfig);\n    this.isMapAttached = true;\n    this.refresh();\n\n    // Auto-load properties if we have requestBody and haven't loaded yet\n    if (this.requestBody && !this.state.firstCallDone) {\n      this.autoLoadProperties();\n    }\n  }\n\n  private createAdapter(options: MapFirstOptions): MapAdapter | null {\n    if (isMapLibreOptions(options) && options.mapInstance) {\n      return this.initializeAdapter(new MapLibreAdapter(options.mapInstance), {\n        maplibregl: options.maplibregl,\n        onMarkerClick: options.onMarkerClick,\n      });\n    }\n    if (isGoogleMapsOptions(options) && options.mapInstance) {\n      return this.initializeAdapter(\n        new GoogleMapsAdapter(options.mapInstance),\n        { google: options.google, onMarkerClick: options.onMarkerClick }\n      );\n    }\n    if (isMapboxOptions(options) && options.mapInstance) {\n      return this.initializeAdapter(new MapboxAdapter(options.mapInstance), {\n        mapboxgl: options.mapboxgl,\n        onMarkerClick: options.onMarkerClick,\n      });\n    }\n    if (\"adapter\" in options && options.adapter) {\n      return options.adapter;\n    }\n    return null;\n  }\n\n  private initializeAdapter(adapter: MapAdapter, config: any): MapAdapter {\n    const shouldAutoSelect = this.options.autoSelectOnClick ?? true;\n    adapter.initialize({\n      ...config,\n      onMarkerClick: (marker: Property) => {\n        if (marker.location) {\n          this.flyMapTo(marker.location.lon, marker.location.lat, 14);\n        }\n\n        // Change primary type if clicking a secondary marker\n        if (marker.type !== this.primaryType) {\n          this.setPrimaryType(marker.type);\n        }\n        if (shouldAutoSelect) {\n          this.setSelectedMarker(\n            marker.tripadvisor_id === this.selectedMarkerId\n              ? null\n              : marker.tripadvisor_id\n          );\n        }\n        config.onMarkerClick?.(marker);\n      },\n      onRefresh: () => this.refresh(),\n    });\n    return adapter;\n  }\n\n  _setProperties(properties: Property[]) {\n    this.ensureAlive();\n    this.properties = [\n      ...properties.filter((x) =>\n        x.type === \"Accommodation\"\n          ? x.pricing?.availability !== \"unavailable\"\n          : true\n      ),\n    ];\n    this.updateState({\n      properties: this.properties,\n    });\n    this.callbacks.onPropertiesChange?.(properties);\n    this.refresh();\n  }\n\n  addProperty(property: Property) {\n    this.ensureAlive();\n    this.properties = [...this.properties, property];\n    this.updateState({ properties: this.properties });\n    this.callbacks.onPropertiesChange?.(this.properties);\n    this.refresh();\n  }\n\n  clearProperties() {\n    this.ensureAlive();\n    this.properties = [];\n    this.updateState({ properties: [] });\n    this.callbacks.onPropertiesChange?.([]);\n    this.refresh();\n  }\n\n  setPrimaryType(primary: PropertyType) {\n    this.ensureAlive();\n    if (this.primaryType === primary) return;\n    this.primaryType = primary;\n    this.updateState({ primary });\n    this.callbacks.onPrimaryTypeChange?.(primary);\n    this.refresh();\n  }\n\n  setSelectedMarker(markerId: number | null) {\n    this.ensureAlive();\n    if (this.selectedMarkerId === markerId) return;\n\n    // If selecting a marker, check if we need to change the primary type\n    if (markerId !== null) {\n      const marker = this.properties.find((p) => p.tripadvisor_id === markerId);\n      if (marker && marker.type !== this.primaryType) {\n        this.setPrimaryType(marker.type);\n      }\n    }\n\n    this.selectedMarkerId = markerId;\n    this.updateState({ selectedPropertyId: markerId });\n    this.callbacks.onSelectedPropertyChange?.(markerId);\n    this.refresh();\n  }\n\n  // State management methods\n  getState(): Readonly<MapState> {\n    return { ...this.state };\n  }\n\n  // Centralized error handler\n  private handleError(error: unknown, context: string = \"MapFirstCore\") {\n    const errorMessage = error instanceof Error ? error.message : String(error);\n    const errorObj = error instanceof Error ? error : new Error(errorMessage);\n\n    console.error(`[${context}]`, errorMessage);\n\n    if (this.callbacks.onError) {\n      this.callbacks.onError(errorObj, context);\n    }\n  }\n\n  updateState(update: MapStateUpdate) {\n    this.state = { ...this.state, ...update };\n  }\n\n  setState(newState: Partial<MapState>) {\n    const prevState = { ...this.state };\n    this.updateState(newState);\n\n    // Trigger callbacks for changed values\n    if (newState.center !== undefined && newState.center !== prevState.center) {\n      this.callbacks.onCenterChange?.(newState.center, this.state.zoom);\n    }\n    if (newState.zoom !== undefined && newState.zoom !== prevState.zoom) {\n      this.callbacks.onZoomChange?.(newState.zoom);\n    }\n    if (newState.bounds !== undefined && newState.bounds !== prevState.bounds) {\n      this.callbacks.onBoundsChange?.(newState.bounds);\n    }\n    if (\n      newState.filters !== undefined &&\n      newState.filters !== prevState.filters\n    ) {\n      this.callbacks.onFiltersChange?.(newState.filters);\n    }\n    if (\n      newState.activeLocation !== undefined &&\n      newState.activeLocation !== prevState.activeLocation\n    ) {\n      this.callbacks.onActiveLocationChange?.(newState.activeLocation);\n    }\n    if (\n      newState.initialLoading !== undefined &&\n      newState.initialLoading !== prevState.initialLoading\n    ) {\n      this.callbacks.onLoadingStateChange?.(newState.initialLoading);\n    }\n    if (\n      newState.isSearching !== undefined &&\n      newState.isSearching !== prevState.isSearching\n    ) {\n      this.callbacks.onSearchingStateChange?.(newState.isSearching);\n    }\n  }\n\n  setFilters(filters: FilterState) {\n    this.setState({ filters });\n  }\n\n  setActiveLocation(location: ActiveLocation) {\n    this.setState({ activeLocation: location });\n  }\n\n  setBounds(bounds: MapBounds | null) {\n    this.setState({ bounds });\n  }\n\n  setPendingBounds(bounds: MapBounds | null) {\n    this.setState({ pendingBounds: bounds });\n  }\n\n  setTempBounds(bounds: MapBounds | null) {\n    this.setState({ tempBounds: bounds });\n  }\n\n  setLoading(loading: boolean) {\n    this.setState({ initialLoading: loading });\n  }\n\n  setSearching(searching: boolean) {\n    this.setState({ isSearching: searching });\n  }\n\n  setFlyToAnimating(animating: boolean) {\n    this.setState({ isFlyToAnimating: animating });\n  }\n\n  flyMapTo(\n    longitude: number,\n    latitude: number,\n    zoom?: number | null,\n    animation: boolean = true\n  ) {\n    this.ensureAlive();\n    this.setState({ center: [latitude, longitude] });\n    if (typeof zoom === \"number\") {\n      this.setState({ zoom });\n    }\n\n    if (!this.adapter) return;\n    const mapInstance = this.adapter.getMap();\n    if (!mapInstance) return;\n\n    if (this.currentPlatform === \"google\") {\n      this.setFlyToAnimating(false);\n      mapInstance.setCenter({ lat: latitude, lng: longitude });\n      if (zoom !== null && typeof zoom === \"number\") {\n        mapInstance.setZoom(zoom ?? 13);\n      }\n      return;\n    }\n\n    // MapLibre/Mapbox\n    if (animation === false) {\n      this.setFlyToAnimating(false);\n      if (mapInstance.jumpTo) {\n        mapInstance.jumpTo({\n          center: [longitude, latitude],\n          ...(zoom !== null && { zoom: zoom ?? 13 }),\n        });\n      }\n      return;\n    }\n\n    this.setFlyToAnimating(true);\n    if (mapInstance.flyTo) {\n      mapInstance.flyTo({\n        center: [longitude, latitude],\n        ...(zoom !== null && { zoom: zoom ?? 13 }),\n      });\n    }\n  }\n\n  flyToPOIs(\n    pois?: { lat: number; lng: number }[],\n    type?: PropertyType,\n    animate: boolean = true\n  ) {\n    this.ensureAlive();\n    if (!this.adapter) return;\n    const mapInstance = this.adapter.getMap();\n    if (!mapInstance) return;\n\n    let points = pois;\n    if (!points || points.length === 0) {\n      points = this.properties\n        .filter(\n          (x) =>\n            x.location !== undefined &&\n            (type !== undefined ? x.type === type : true)\n        )\n        .map((h) => ({\n          lat: h.location!.lat,\n          lng: h.location!.lon,\n        }));\n    }\n    if (!points || points.length === 0) return;\n\n    // Check if this is Google Maps\n\n    if (points.length === 1) {\n      const poi = points[0];\n      if (this.currentPlatform === \"google\") {\n        mapInstance.setCenter({ lat: poi.lat, lng: poi.lng });\n        mapInstance.setZoom(13);\n      } else if (mapInstance.flyTo) {\n        mapInstance.flyTo({\n          center: [poi.lng, poi.lat],\n          zoom: 13,\n        });\n      }\n    } else {\n      if (this.currentPlatform === \"google\") {\n        // Google Maps\n        const LatLngBounds = (window as any).google?.maps?.LatLngBounds;\n        if (LatLngBounds) {\n          const bounds = new LatLngBounds();\n          points.forEach((poi) => {\n            bounds.extend({ lat: poi.lat, lng: poi.lng });\n          });\n          if (animate) {\n            this.setFlyToAnimating(true);\n          }\n          mapInstance.fitBounds(bounds, this.fitBoundsPadding);\n        }\n      } else if (mapInstance.fitBounds) {\n        // MapLibre/Mapbox\n        const bounds: [[number, number], [number, number]] = [\n          [points[0].lng, points[0].lat],\n          [points[0].lng, points[0].lat],\n        ];\n\n        points.forEach((poi) => {\n          bounds[0][0] = Math.min(bounds[0][0], poi.lng);\n          bounds[0][1] = Math.min(bounds[0][1], poi.lat);\n          bounds[1][0] = Math.max(bounds[1][0], poi.lng);\n          bounds[1][1] = Math.max(bounds[1][1], poi.lat);\n        });\n\n        if (animate) {\n          this.setFlyToAnimating(true);\n        }\n        mapInstance.fitBounds(bounds, {\n          padding: this.fitBoundsPadding,\n          animate,\n        });\n      }\n    }\n  }\n\n  getFilters() {\n    const filters = { ...this.state.filters };\n    // Convert Date objects to ISO strings for API compatibility\n    if (filters.checkIn instanceof Date) {\n      filters.checkIn = toISO(filters.checkIn);\n    }\n    if (filters.checkOut instanceof Date) {\n      filters.checkOut = toISO(filters.checkOut);\n    }\n    return filters as FilterSchema;\n  }\n\n  async loadProperties({\n    fetchFn,\n    onSuccess,\n    onError,\n  }: {\n    fetchFn: () => Promise<Property[]>;\n    onSuccess?: (properties: Property[]) => void;\n    onError?: (error: unknown) => void;\n  }): Promise<void> {\n    this.ensureAlive();\n    this.setLoading(true);\n    this.setSearching(true);\n    this.clearProperties();\n\n    try {\n      const properties = await fetchFn();\n\n      this._setProperties(properties);\n\n      if (!this.primaryType && properties.length > 0) {\n        const typeCounts = properties.reduce((counts, property) => {\n          counts[property.type] = (counts[property.type] || 0) + 1;\n          return counts;\n        }, {} as Record<PropertyType, number>);\n\n        const mostCommonType = Object.entries(typeCounts).reduce((a, b) =>\n          typeCounts[a[0] as PropertyType] > typeCounts[b[0] as PropertyType]\n            ? a\n            : b\n        )[0] as PropertyType;\n\n        this.setPrimaryType(mostCommonType);\n      }\n\n      this.setState({ firstCallDone: true });\n      onSuccess?.(properties);\n    } catch (error) {\n      this.clearProperties();\n      onError?.(error);\n    } finally {\n      this.setSearching(false);\n      this.setLoading(false);\n      this.setState({ firstCallDone: true });\n    }\n  }\n\n  async pollForPricing({\n    pollingLink,\n    maxAttempts = 15,\n    delayMs = 2000,\n    isCancelled,\n    price,\n    limit,\n  }: PollOptions): Promise<{\n    completed: boolean;\n    pollData?: HotelPricingAPIResponse;\n  }> {\n    this.ensureAlive();\n\n    if (!pollingLink) {\n      return { completed: false };\n    }\n\n    let completed = false;\n    let pollData: HotelPricingAPIResponse | undefined = undefined;\n\n    const filters = this.getFilters();\n    if (limit) {\n      filters.limit = limit;\n    }\n\n    const body: any = {\n      filters,\n      pollingLink,\n    };\n\n    for (let attempt = 0; attempt < maxAttempts; attempt++) {\n      if (isCancelled?.()) {\n        return { completed, pollData };\n      }\n\n      try {\n        const pollResp = await fetch(\n          `${this.apiUrl}/${this.mfid}/ta-polling?pollingNumber=${attempt}`,\n          {\n            method: \"POST\",\n            body: JSON.stringify(body),\n            headers: { \"Content-Type\": \"application/json\" },\n          }\n        );\n\n        if (!pollResp.ok) {\n          throw new PropertiesFetchError({\n            message: `Poll failed: ${pollResp.status}`,\n            status: pollResp.status,\n          });\n        }\n\n        pollData = await pollResp.json();\n\n        if (isCancelled?.()) {\n          return { completed, pollData };\n        }\n\n        const results = pollData?.success?.results ?? [];\n        if (results.length > 0) {\n          this.setProperties((prev) => {\n            const resultIds = new Set(results.map((h) => h.tripadvisor_id));\n            const updatedProperties = prev.filter(\n              (property) =>\n                property.type !== \"Accommodation\" ||\n                resultIds.has(property.tripadvisor_id)\n            );\n\n            results.forEach((property) => {\n              if (!property.location) return;\n              if (\n                property.pricing?.offer?.price &&\n                price &&\n                (property.pricing?.offer?.price < price?.min ||\n                  property.pricing?.offer?.price > price?.max)\n              ) {\n                property.pricing.availability = \"unavailable\";\n              }\n              const existingIndex = updatedProperties.findIndex(\n                (h) => h.tripadvisor_id === property.tripadvisor_id\n              );\n              if (existingIndex >= 0) {\n                updatedProperties[existingIndex] = property;\n              } else {\n                updatedProperties.push(property);\n              }\n            });\n            return updatedProperties;\n          });\n        }\n\n        if (pollData?.success?.isComplete) {\n          completed = true;\n          break;\n        }\n      } catch (error) {\n        this.handleError(error, \"pollForPricing\");\n        this.callbacks.onPropertiesLoadError?.(error);\n        break;\n      }\n\n      if (attempt < maxAttempts - 1) {\n        await new Promise((resolve) => setTimeout(resolve, delayMs));\n      }\n    }\n\n    return { completed, pollData };\n  }\n\n  private setProperties(updater: (prev: Property[]) => Property[]): void {\n    const updatedProperties = updater(this.properties);\n    this._setProperties(updatedProperties);\n  }\n\n  private mostCommonTypeFromProperties(properties: Property[]): PropertyType {\n    const typeCounts = properties.reduce((counts, property) => {\n      counts[property.type] = (counts[property.type] || 0) + 1;\n      return counts;\n    }, {} as Record<PropertyType, number>);\n\n    return Object.entries(typeCounts).reduce((a, b) =>\n      typeCounts[a[0] as PropertyType] > typeCounts[b[0] as PropertyType]\n        ? a\n        : b\n    )[0] as PropertyType;\n  }\n\n  async runPropertiesSearch({\n    body,\n    beforeApplyProperties,\n    smartFiltersClearable,\n    onError,\n  }: {\n    body: InitialRequestBody;\n    beforeApplyProperties?: (data: APIResponse) => {\n      price?: Price | null;\n      limit?: number;\n    };\n    smartFiltersClearable?: boolean;\n    onError?: (error: unknown) => void;\n  }): Promise<APIResponse | null> {\n    this.ensureAlive();\n    this.setState({ firstCallDone: false });\n    this.setSearching(true);\n    this.clearProperties();\n\n    try {\n      const data = await fetchProperties<InitialRequestBody, APIResponse>(\n        `${this.apiUrl}/${this.mfid}/hotels`,\n        body\n      );\n\n      this.updateActiveLocationFromResponse(data);\n\n      let price: Price | null = null;\n      let limit: number = 30;\n      let primary_type: PropertyType | undefined = data.filters.primary_type;\n\n      if (beforeApplyProperties) {\n        const result = beforeApplyProperties(data);\n        price = result.price ?? null;\n        limit = result.limit ?? 30;\n      }\n\n      // Track if we've already flown to POIs\n      const flown = data.properties.some((x) => !!x.location);\n\n      // Apply properties\n      this._setProperties(data.properties);\n\n      // Fly to POIs if properties have locations\n      if (flown) {\n        this.flyToPOIs(\n          data.properties\n            .filter(\n              (x) =>\n                !!x.location &&\n                (data.filters.primary_type\n                  ? x.type === data.filters.primary_type\n                  : true)\n            )\n            .map((x) => ({ lat: x.location!.lat, lng: x.location!.lon })),\n          undefined,\n          body.initial !== true\n        );\n      }\n\n      // Determine and set primary type\n      if (\n        data.filters.primary_type &&\n        data.properties.filter(\n          (property) =>\n            property.type === data.filters.primary_type &&\n            (property.type === \"Accommodation\"\n              ? property.pricing?.availability !== \"unavailable\"\n              : true)\n        ).length > 0\n      ) {\n        primary_type = data.filters.primary_type;\n        this.setPrimaryType(data.filters.primary_type);\n      } else if (data.properties.length > 0) {\n        const mostCommonType = this.mostCommonTypeFromProperties(\n          data.properties\n        );\n        this.setPrimaryType(mostCommonType);\n        primary_type = mostCommonType;\n      }\n\n      this.setState({ firstCallDone: true });\n\n      // Check if we need to poll for pricing\n      if (data.isComplete === false && data.pollingLink) {\n        const { completed, pollData } = await this.pollForPricing({\n          pollingLink: data.pollingLink,\n          ...(price && { price }),\n          ...(limit && { limit }),\n        });\n\n        if (\n          completed &&\n          pollData?.success?.results &&\n          pollData.success.results.filter(\n            (property) =>\n              property.type === data.filters.primary_type &&\n              (property.type === \"Accommodation\"\n                ? property.pricing?.availability !== \"unavailable\"\n                : true)\n          ).length === 0 &&\n          primary_type &&\n          primary_type !== data.filters.primary_type\n        ) {\n          const mostCommonType = this.mostCommonTypeFromProperties(\n            data.properties\n          );\n          this.setPrimaryType(mostCommonType);\n        }\n      }\n\n      // Fly to POIs if not already done\n      if (!flown) {\n        if (data.properties.some((x) => !!x.location)) {\n          this.flyToPOIs(\n            data.properties\n              .filter(\n                (x) =>\n                  !!x.location &&\n                  (data.filters.primary_type\n                    ? x.type === data.filters.primary_type\n                    : true)\n              )\n              .map((x) => ({ lat: x.location!.lat, lng: x.location!.lon })),\n            undefined,\n            body.initial !== true\n          );\n        } else if (\n          data.filters.location?.latitude &&\n          data.filters.location?.longitude\n        ) {\n          this.flyMapTo(\n            data.filters.location.longitude,\n            data.filters.location.latitude,\n            12,\n            body.initial !== true\n          );\n        }\n      }\n\n      return data;\n    } catch (error) {\n      this.handleError(error, \"runPropertiesSearch\");\n      onError?.(error);\n      this.callbacks.onPropertiesLoadError?.(error);\n      this.clearProperties();\n      this.setState({ firstCallDone: true });\n      return null;\n    } finally {\n      this.setSearching(false);\n      this.setState({ firstCallDone: true });\n    }\n  }\n\n  private updateActiveLocationFromResponse(data: APIResponse) {\n    const newLocationId = data.location_id ?? null;\n    const newCity = data.filters.location?.city ?? undefined;\n    const newCountry = data.filters.location?.country || \"\";\n    const newCoordinates = data.filters.location\n      ? [data.filters.location.latitude, data.filters.location.longitude]\n      : undefined;\n\n    if (!newCoordinates) return;\n\n    const currentLocation = this.state.activeLocation;\n\n    // Check if location has changed\n    if (\n      newLocationId !== currentLocation?.location_id ||\n      newCity !== currentLocation?.city ||\n      newCountry !== currentLocation?.country\n    ) {\n      this.setActiveLocation({\n        city: newCity,\n        country: newCountry,\n        location_id: newLocationId,\n        locationName:\n          newCity && newCountry\n            ? `${newCity}, ${newCountry}`\n            : newCountry || \"\",\n        coordinates: newCoordinates as [number, number],\n      });\n    }\n  }\n\n  async runSmartFilterSearch({\n    query,\n    filters,\n    onProcessFilters,\n    onError,\n  }: {\n    query?: string;\n    filters?: SmartFilter[];\n    onProcessFilters?: (\n      filters: any,\n      location_id?: number\n    ) => {\n      smartFilters?: SmartFilter[];\n      price?: Price | null;\n      limit?: number;\n      language?: string;\n    };\n    onError?: (error: unknown) => void;\n  }): Promise<APIResponse | null> {\n    this.ensureAlive();\n\n    // Build filter payload from smart filters if provided\n    let filterPayload = this.getFilters();\n    const state = this.getState();\n\n    if (filters && filters.length > 0) {\n      const amenities = new Set<string>();\n      const hotelStyle = new Set<string>();\n      let price: { min: number; max: number } | undefined;\n      let minRating: number | undefined;\n      let starRating: number | undefined;\n      let primary_type: PropertyType | undefined;\n      let transformed_query: string | undefined;\n      let selected_restaurant_price_levels: PriceLevel[] | undefined;\n\n      filters.forEach((filter) => {\n        switch (filter.type) {\n          case \"amenity\":\n            amenities.add(filter.value);\n            break;\n          case \"hotelStyle\":\n            hotelStyle.add(filter.value);\n            break;\n          case \"priceRange\":\n            if (filter.priceRange) {\n              price = {\n                min: filter.priceRange.min,\n                max: filter.priceRange.max ?? 0,\n              };\n            }\n            break;\n          case \"minRating\":\n            minRating = filter.numericValue ?? Number(filter.value);\n            break;\n          case \"starRating\":\n            starRating = filter.numericValue ?? Number(filter.value);\n            break;\n          case \"primary_type\":\n            primary_type = filter.propertyType;\n            break;\n          case \"transformed_query\":\n            transformed_query = filter.value;\n            break;\n          case \"selected_restaurant_price_levels\":\n            selected_restaurant_price_levels = filter.priceLevels;\n            break;\n        }\n      });\n\n      filterPayload = {\n        ...filterPayload,\n        ...(amenities.size > 0 && { amenities: Array.from(amenities) }),\n        ...(hotelStyle.size > 0 && { hotelStyle: Array.from(hotelStyle) }),\n        ...(price && { price }),\n        ...(minRating !== undefined && { minRating }),\n        ...(starRating !== undefined && { starRating }),\n        ...(primary_type && { primary_type }),\n        ...(transformed_query && { transformed_query }),\n        ...(selected_restaurant_price_levels && {\n          selected_restaurant_price_levels,\n        }),\n      };\n    } else if (!query) {\n      // Add default minRating if no filters and no query\n      filterPayload.minRating = 4;\n    }\n\n    const body: InitialRequestBody = {\n      filters: filterPayload,\n      ...(query && { query }),\n      ...(state.bounds\n        ? { bounds: state.bounds }\n        : state.activeLocation.location_id\n        ? { location_id: state.activeLocation.location_id }\n        : state.activeLocation.coordinates\n        ? {\n            latitude: state.activeLocation.coordinates[0],\n            longitude: state.activeLocation.coordinates[1],\n          }\n        : {}),\n    };\n\n    return this.runPropertiesSearch({\n      body,\n      beforeApplyProperties: onProcessFilters\n        ? (data) => {\n            const result = onProcessFilters(data.filters, data.location_id);\n            return {\n              price: result.price ?? null,\n              limit: result.limit ?? 30,\n            };\n          }\n        : undefined,\n      smartFiltersClearable: !!query,\n      onError,\n    });\n  }\n\n  getClusters(): ClusterDisplayItem[] {\n    this.ensureAlive();\n    return [...this.clusterItems];\n  }\n\n  refresh() {\n    this.ensureAlive();\n    if (!this.adapter) return;\n\n    const viewState = this.safeExtractViewState();\n    const primaryType = this.resolvePrimaryType();\n\n    this.clusterItems = clusterMarkers({\n      primaryType,\n      markers: this.properties,\n      map: this.adapter,\n      selectedMarkerId: this.selectedMarkerId,\n      zoom: viewState?.zoom ?? 0,\n    });\n\n    const markerManager = this.adapter.getMarkerManager();\n    markerManager.render(this.clusterItems, primaryType, this.selectedMarkerId);\n\n    this.options.onClusterUpdate?.(this.clusterItems, viewState);\n  }\n\n  destroy() {\n    if (this.destroyed) {\n      return;\n    }\n    if (this.adapter) {\n      const markerManager = this.adapter.getMarkerManager();\n      markerManager.destroy();\n      this.adapter.cleanup();\n    }\n\n    this.clusterItems = [];\n    this.properties = [];\n    this.destroyed = true;\n    this.isMapAttached = false;\n  }\n\n  private resolvePrimaryType(): PropertyType {\n    return (\n      this.primaryType ??\n      this.properties.find((marker) => marker.type)?.type ??\n      DEFAULT_PRIMARY_TYPE\n    );\n  }\n\n  private safeExtractViewState(): ViewStateSnapshot | null {\n    if (!this.adapter) return null;\n    try {\n      return extractViewState(this.adapter);\n    } catch {\n      return null;\n    }\n  }\n\n  private ensureAlive() {\n    if (this.destroyed) {\n      throw new Error(\"MapFirstCore instance has been destroyed\");\n    }\n  }\n}\n\nfunction isMapLibreOptions(\n  options: MapFirstOptions\n): options is MapLibreOptions {\n  return (options as MapLibreOptions).platform === \"maplibre\";\n}\n\nfunction isGoogleMapsOptions(\n  options: MapFirstOptions\n): options is GoogleMapsOptions {\n  return (options as GoogleMapsOptions).platform === \"google\";\n}\n\nfunction isMapboxOptions(options: MapFirstOptions): options is MapboxOptions {\n  return (options as MapboxOptions).platform === \"mapbox\";\n}\n","\n          export default function styleInject(css, { insertAt } = {}) {\n            if (!css || typeof document === 'undefined') return\n          \n            const head = document.head || document.getElementsByTagName('head')[0]\n            const style = document.createElement('style')\n            style.type = 'text/css'\n          \n            if (insertAt === 'top') {\n              if (head.firstChild) {\n                head.insertBefore(style, head.firstChild)\n              } else {\n                head.appendChild(style)\n              }\n            } else {\n              head.appendChild(style)\n            }\n          \n            if (style.styleSheet) {\n              style.styleSheet.cssText = css\n            } else {\n              style.appendChild(document.createTextNode(css))\n            }\n          }\n          ","import styleInject from '#style-inject';styleInject(\".mapfirst-marker-root{display:flex;z-index:20;flex-direction:column;align-items:center;pointer-events:auto}.mapfirst-marker-pill{border:2px solid;border-radius:999px;padding:8px;font-size:16px;font-weight:600;font-family:system-ui,-apple-system,sans-serif;box-shadow:0 4px 6px #6b728080;display:flex;align-items:center;justify-content:center;position:relative;transition:transform .2s;transform-origin:center bottom}.mapfirst-marker-pill-pending{background:#ffffff80;backdrop-filter:blur(4px);border-color:transparent;cursor:default}.mapfirst-marker-pill-active{background:#012b11;border-color:#fff;color:#fff;cursor:pointer}.mapfirst-marker-pill-active.mapfirst-marker-non-primary{background:#ffffffb3;border-color:#03852e80;color:#03852e80;padding:4px}.mapfirst-marker-pill-active.mapfirst-marker-selected{background:#fff;border-color:#03852e;color:#03852e;transform:scale(1.2)}.mapfirst-marker-pill-active:hover{transform:scale(1.2)}.mapfirst-marker-badge{position:absolute;top:-12px;right:-20px}.mapfirst-marker-award-container{position:relative;width:32px;height:32px}.mapfirst-marker-award-back{position:absolute;stroke:#f5f5f5;stroke-width:2px}.mapfirst-marker-award-dot{position:absolute;top:6.2px;left:6.3px;width:18.5px;height:18.5px;border-radius:50%;z-index:1}.mapfirst-marker-award-dot-type-0{background:#ffef0e}.mapfirst-marker-award-dot-type-1{background:#01ea5b}.mapfirst-marker-award-front{position:relative;z-index:2;color:#012b11}.mapfirst-marker-rating-badge{display:flex;align-items:center;justify-content:center;border-radius:999px;background:#03852e;color:#fff;font-size:12px;line-height:1;box-shadow:0 2px 4px #0003;padding:2px 6px;border:2px solid #ffffff;font-weight:400}.mapfirst-marker-content{display:flex;align-items:center}.mapfirst-dot-marker-container{display:flex;z-index:10;align-items:center;justify-content:center;pointer-events:auto}.mapfirst-dot-marker-button{width:20px;height:20px;border-radius:999px;border:2px solid #ffffff;box-shadow:0 2px 4px #6b728066;transition:transform .2s;outline:none;transform-origin:center center}.mapfirst-dot-marker-button-pending{background:#d1d5db;cursor:default}.mapfirst-dot-marker-button-active{background:#012b11;cursor:pointer}.mapfirst-dot-marker-button-active.mapfirst-dot-marker-non-primary{background:#ffffffb3;border-color:#03852e33}.mapfirst-dot-marker-button-active.mapfirst-dot-marker-selected{background:#fff;border-color:#03852e}.mapfirst-dot-marker-button-active:hover{transform:scale(1.2)}.mapfirst-dot-marker-button-active:focus{outline:2px solid #ffffff;outline-offset:2px}\\n\")","import type { Property } from \".\";\r\nimport \"./markers.css\";\r\nimport { ClusterDisplayItem } from \"./utils/clustering\";\r\n\r\nexport function createDotMarkerElement(\r\n  item: Extract<ClusterDisplayItem, { kind: \"dot\" }>,\r\n  primaryType: string,\r\n  selectedMarkerId: number | null,\r\n  onMarkerClick?: (marker: Property) => void\r\n) {\r\n  if (typeof document === \"undefined\") {\r\n    return null;\r\n  }\r\n\r\n  const marker = item.marker;\r\n  const isPrimaryType = marker.type === primaryType;\r\n  const isSelected = selectedMarkerId === marker.tripadvisor_id;\r\n  const isAccommodation = marker.type === \"Accommodation\";\r\n  const isPending =\r\n    isAccommodation && marker.pricing?.offer?.availability !== \"available\";\r\n\r\n  // Create container div to match primary marker structure\r\n  const container = document.createElement(\"div\");\r\n  container.className = \"mapfirst-dot-marker-container\";\r\n  container.style.zIndex = isSelected ? \"20\" : isPrimaryType ? \"3\" : \"1\";\r\n\r\n  const button = document.createElement(\"div\");\r\n  button.className = isPending\r\n    ? \"mapfirst-dot-marker-button mapfirst-dot-marker-button-pending\"\r\n    : `mapfirst-dot-marker-button mapfirst-dot-marker-button-active${\r\n        isSelected\r\n          ? \" mapfirst-dot-marker-selected\"\r\n          : !isPrimaryType\r\n          ? \" mapfirst-dot-marker-non-primary\"\r\n          : \"\"\r\n      }`;\r\n  button.title = marker.name ?? String(marker.tripadvisor_id);\r\n\r\n  button.addEventListener(\"click\", (evt) => {\r\n    evt.stopPropagation();\r\n    if (!isPending) {\r\n      onMarkerClick?.(marker);\r\n    }\r\n  });\r\n\r\n  container.appendChild(button);\r\n  return container;\r\n}\r\n","import type { Property } from \".\";\r\nimport \"./markers.css\";\r\nimport { ClusterDisplayItem } from \"./utils/clustering\";\r\n\r\nconst AWARD_SVG = `<svg viewBox=\"0 0 24 24\" width=\"32\" height=\"32\" fill=\"currentColor\"><path d=\"M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014\"></path><path d=\"M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827\"></path></svg>`;\r\n\r\nconst AWARD_BACK_SVG = `<svg viewBox=\"0 0 24 24\" width=\"32\" height=\"32\"><path d=\"M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014\"></path><path d=\"M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827\"></path></svg>`;\r\n\r\nconst EAT_DRINK_SVG = `<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"currentColor\"><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M14.051 6.549v.003l1.134 1.14 3.241-3.25.003-.002 1.134 1.136-3.243 3.252 1.134 1.14a1 1 0 0 0 .09-.008c.293-.05.573-.324.72-.474l.005-.006 2.596-2.603L22 8.016l-2.597 2.604a3.73 3.73 0 0 1-1.982 1.015 4.3 4.3 0 0 1-3.162-.657l-.023-.016-.026-.018-1.366 1.407 8.509 8.512L20.219 22l-.002-.002-6.654-6.663-2.597 2.76-7.3-7.315C1.967 8.948 1.531 6.274 2.524 4.198c.241-.504.566-.973.978-1.386l8.154 8.416 1.418-1.423-.039-.045c-.858-1.002-1.048-2.368-.62-3.595a4.15 4.15 0 0 1 .983-1.561L16 2l1.135 1.138-2.598 2.602-.047.045c-.16.151-.394.374-.433.678zM3.809 5.523c-.362 1.319-.037 2.905 1.06 4.103L10.93 15.7l1.408-1.496zM2.205 20.697 3.34 21.84l4.543-4.552-1.135-1.143z\"/></svg>`;\r\n\r\nconst ATTRACTION_SVG = `<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"currentColor\"><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M7.56 7.5H3.75a.25.25 0 0 0-.25.25v10c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25v-10a.25.25 0 0 0-.25-.25h-3.81l-2-2H9.56zM8.94 4h6.12l2 2h3.19c.966 0 1.75.784 1.75 1.75v10a1.75 1.75 0 0 1-1.75 1.75H3.75A1.75 1.75 0 0 1 2 17.75v-10C2 6.784 2.784 6 3.75 6h3.19z\"/><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M12 9.25a2.75 2.75 0 1 0 0 5.5 2.75 2.75 0 0 0 0-5.5M7.75 12a4.25 4.25 0 1 1 8.5 0 4.25 4.25 0 0 1-8.5 0\"/></svg>`;\r\n\r\nexport function createPrimaryMarkerElement(\r\n  item: Extract<ClusterDisplayItem, { kind: \"primary\" }>,\r\n  primaryType: string,\r\n  selectedMarkerId: number | null,\r\n  onMarkerClick?: (marker: Property) => void\r\n) {\r\n  if (typeof document === \"undefined\") {\r\n    return null;\r\n  }\r\n\r\n  const marker = item.marker;\r\n  const isPrimaryType = marker.type === primaryType;\r\n  const isSelected = selectedMarkerId === marker.tripadvisor_id;\r\n  const isAccommodation = marker.type === \"Accommodation\";\r\n  const hasPrice = marker.pricing?.offer?.displayPrice;\r\n  const isPending = isAccommodation && !hasPrice;\r\n\r\n  // Rating\r\n  const ratingLabel = (() => {\r\n    if (marker.rating === undefined || marker.rating === null) return null;\r\n    const numeric =\r\n      typeof marker.rating === \"number\" ? marker.rating : Number(marker.rating);\r\n    if (Number.isNaN(numeric) || numeric <= 0) return null;\r\n    return numeric.toFixed(1);\r\n  })();\r\n\r\n  const root = document.createElement(\"div\");\r\n  root.className = \"mapfirst-marker-root\";\r\n  root.style.zIndex = isSelected ? \"20\" : isPrimaryType ? \"12\" : \"11\";\r\n\r\n  const pill = document.createElement(\"div\");\r\n  pill.className = isPending\r\n    ? \"mapfirst-marker-pill mapfirst-marker-pill-pending\"\r\n    : `mapfirst-marker-pill mapfirst-marker-pill-active${\r\n        isSelected\r\n          ? \" mapfirst-marker-selected\"\r\n          : !isPrimaryType\r\n          ? \" mapfirst-marker-non-primary\"\r\n          : \"\"\r\n      }`;\r\n  pill.title = marker.name ?? String(marker.tripadvisor_id);\r\n\r\n  // Awards or Rating badge\r\n  if (!isPending && (marker.awards?.length || ratingLabel)) {\r\n    const badge = document.createElement(\"div\");\r\n    badge.className = \"mapfirst-marker-badge\";\r\n    if (!isPrimaryType) {\r\n      badge.style.opacity = \"0.2\";\r\n    }\r\n    badge.className = \"mapfirst-marker-badge\";\r\n\r\n    if (marker.awards?.length && marker.awards[0].type) {\r\n      const awardContainer = document.createElement(\"div\");\r\n      awardContainer.className = \"mapfirst-marker-award-container\";\r\n\r\n      const backLayer = document.createElement(\"div\");\r\n      backLayer.className = \"mapfirst-marker-award-back\";\r\n      backLayer.innerHTML = AWARD_BACK_SVG;\r\n\r\n      const colorDot = document.createElement(\"div\");\r\n      colorDot.className = `mapfirst-marker-award-dot mapfirst-marker-award-dot-type-${marker.awards[0].type}`;\r\n\r\n      const frontLayer = document.createElement(\"div\");\r\n      frontLayer.className = \"mapfirst-marker-award-front\";\r\n      frontLayer.innerHTML = AWARD_SVG;\r\n\r\n      awardContainer.appendChild(backLayer);\r\n      awardContainer.appendChild(colorDot);\r\n      awardContainer.appendChild(frontLayer);\r\n      badge.appendChild(awardContainer);\r\n    } else if (ratingLabel) {\r\n      badge.className = \"mapfirst-marker-badge mapfirst-marker-rating-badge\";\r\n      badge.textContent = ratingLabel;\r\n    }\r\n\r\n    pill.appendChild(badge);\r\n  }\r\n\r\n  // Content\r\n  const content = document.createElement(\"span\");\r\n  content.className = \"mapfirst-marker-content\";\r\n  if (isAccommodation) {\r\n    content.textContent = marker.pricing?.offer?.displayPrice ?? \"\";\r\n  } else if (marker.type === \"Eat & Drink\") {\r\n    content.innerHTML = EAT_DRINK_SVG;\r\n  } else if (marker.type === \"Attraction\") {\r\n    content.innerHTML = ATTRACTION_SVG;\r\n  }\r\n  pill.appendChild(content);\r\n\r\n  pill.addEventListener(\"click\", (evt) => {\r\n    evt.stopPropagation();\r\n    if (!isPending) {\r\n      onMarkerClick?.(marker);\r\n    }\r\n  });\r\n\r\n  root.appendChild(pill);\r\n  return root;\r\n}\r\n","/**\r\n * Utility functions to update marker DOM elements without recreating them\r\n */\r\n\r\n/**\r\n * Updates the z-index and CSS classes of a primary marker element\r\n */\r\nexport function updatePrimaryMarkerElement(\r\n  element: HTMLElement,\r\n  isPrimaryType: boolean,\r\n  isSelected: boolean,\r\n  isPending: boolean\r\n) {\r\n  // Update root z-index\r\n  const root = element;\r\n  root.style.zIndex = isSelected ? \"20\" : isPrimaryType ? \"12\" : \"11\";\r\n\r\n  // Update pill classes\r\n  const pill = root.querySelector(\".mapfirst-marker-pill\");\r\n  if (pill) {\r\n    if (isPending) {\r\n      pill.className = \"mapfirst-marker-pill mapfirst-marker-pill-pending\";\r\n    } else {\r\n      pill.className = `mapfirst-marker-pill mapfirst-marker-pill-active${\r\n        isSelected\r\n          ? \" mapfirst-marker-selected\"\r\n          : !isPrimaryType\r\n          ? \" mapfirst-marker-non-primary\"\r\n          : \"\"\r\n      }`;\r\n    }\r\n  }\r\n\r\n  // Update badge opacity for non-primary markers\r\n  const badge = root.querySelector(\".mapfirst-marker-badge\");\r\n  if (badge instanceof HTMLElement) {\r\n    badge.style.opacity = !isPrimaryType && !isSelected ? \"0.2\" : \"\";\r\n  }\r\n}\r\n\r\n/**\r\n * Updates the z-index and CSS classes of a dot marker element\r\n */\r\nexport function updateDotMarkerElement(\r\n  element: HTMLElement,\r\n  isPrimaryType: boolean,\r\n  isSelected: boolean,\r\n  isPending: boolean\r\n) {\r\n  // Update container z-index\r\n  const container = element;\r\n  container.style.zIndex = isSelected ? \"20\" : isPrimaryType ? \"3\" : \"1\";\r\n\r\n  // Update button classes\r\n  const button = container.querySelector(\".mapfirst-dot-marker-button\");\r\n  if (button) {\r\n    if (isPending) {\r\n      button.className =\r\n        \"mapfirst-dot-marker-button mapfirst-dot-marker-button-pending\";\r\n    } else {\r\n      button.className = `mapfirst-dot-marker-button mapfirst-dot-marker-button-active${\r\n        isSelected\r\n          ? \" mapfirst-dot-marker-selected\"\r\n          : !isPrimaryType\r\n          ? \" mapfirst-dot-marker-non-primary\"\r\n          : \"\"\r\n      }`;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Extracts the tripadvisor_id from a marker key\r\n */\r\nexport function extractMarkerIdFromKey(key: string): number | null {\r\n  const match = key.match(/^(?:primary|dot)-(\\d+)-/);\r\n  return match ? parseInt(match[1], 10) : null;\r\n}\r\n\r\n/**\r\n * Extracts the state flags from a marker key\r\n */\r\nexport function extractStateFromKey(key: string): {\r\n  isPrimary: boolean;\r\n  isSelected: boolean;\r\n} {\r\n  const match = key.match(/-p([01])-s([01])$/);\r\n  if (!match) {\r\n    return { isPrimary: true, isSelected: false };\r\n  }\r\n  return {\r\n    isPrimary: match[1] === \"1\",\r\n    isSelected: match[2] === \"1\",\r\n  };\r\n}\r\n","import type { Property } from \"../types\";\r\nimport { createDotMarkerElement } from \"../dotmarker\";\r\nimport { createPrimaryMarkerElement } from \"../marker\";\r\nimport {\r\n  updatePrimaryMarkerElement,\r\n  updateDotMarkerElement,\r\n  extractMarkerIdFromKey,\r\n} from \"../marker-updater\";\r\nimport { ClusterDisplayItem } from \"../utils/clustering\";\r\n\r\nexport type MarkerEntry<T = any> = {\r\n  key: string;\r\n  marker: T;\r\n  kind: \"primary\" | \"dot\";\r\n  parentId?: number;\r\n};\r\n\r\nexport abstract class BaseMarkerManager<TMarker = any> {\r\n  protected readonly mapInstance: any;\r\n  protected readonly onMarkerClick?: (marker: Property) => void;\r\n  protected markerCache = new Map<string, MarkerEntry<TMarker>>();\r\n  protected primaryType: string = \"Accommodation\";\r\n  protected selectedMarkerId: number | null = null;\r\n\r\n  constructor(mapInstance: any, onMarkerClick?: (marker: Property) => void) {\r\n    this.mapInstance = mapInstance;\r\n    this.onMarkerClick = onMarkerClick;\r\n  }\r\n\r\n  render(\r\n    items: ClusterDisplayItem[],\r\n    primaryType?: string,\r\n    selectedMarkerId?: number | null\r\n  ) {\r\n    if (primaryType && primaryType !== this.primaryType) {\r\n      this.primaryType = primaryType;\r\n    }\r\n    if (selectedMarkerId !== undefined) {\r\n      this.selectedMarkerId = selectedMarkerId;\r\n    }\r\n\r\n    // Create a set of keys for the new items\r\n    const newKeys = new Set(items.map((item) => item.key));\r\n\r\n    // Remove markers that are no longer needed\r\n    for (const [key, entry] of this.markerCache.entries()) {\r\n      if (!newKeys.has(key)) {\r\n        this.removeMarkerFromMap(entry.marker);\r\n        this.markerCache.delete(key);\r\n      }\r\n    }\r\n\r\n    // Add or update markers\r\n    for (const item of items) {\r\n      const coords = safeLatLon(item.marker.location);\r\n      if (!coords) continue;\r\n\r\n      const existing = this.markerCache.get(item.key);\r\n\r\n      if (existing) {\r\n        // Update existing marker position if needed\r\n        try {\r\n          this.updateMarkerPosition(existing.marker, coords);\r\n        } catch {\r\n          // If update fails, remove and recreate\r\n          this.removeMarkerFromMap(existing.marker);\r\n          this.markerCache.delete(item.key);\r\n          this.createAndAddMarker(item, coords);\r\n        }\r\n      } else {\r\n        // Check if there's a marker for the same property with a different key (styling change)\r\n        const markerId = item.marker.tripadvisor_id;\r\n        let existingEntry: MarkerEntry<TMarker> | undefined;\r\n        let existingKey: string | undefined;\r\n\r\n        for (const [key, entry] of this.markerCache.entries()) {\r\n          if (\r\n            extractMarkerIdFromKey(key) === markerId &&\r\n            entry.kind === item.kind\r\n          ) {\r\n            existingEntry = entry;\r\n            existingKey = key;\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (existingEntry && existingKey) {\r\n          // Same marker, different state - update styles instead of recreating\r\n          const isPrimaryType = item.marker.type === this.primaryType;\r\n          const isSelected =\r\n            this.selectedMarkerId === item.marker.tripadvisor_id;\r\n          const isAccommodation = item.marker.type === \"Accommodation\";\r\n          const isPending =\r\n            item.kind === \"primary\"\r\n              ? isAccommodation && !item.marker.pricing?.offer?.displayPrice\r\n              : isAccommodation &&\r\n                item.marker.pricing?.offer?.availability !== \"available\";\r\n\r\n          const element = this.getMarkerElement(existingEntry.marker);\r\n          if (element) {\r\n            if (item.kind === \"primary\") {\r\n              updatePrimaryMarkerElement(\r\n                element,\r\n                isPrimaryType,\r\n                isSelected,\r\n                isPending\r\n              );\r\n            } else {\r\n              updateDotMarkerElement(\r\n                element,\r\n                isPrimaryType,\r\n                isSelected,\r\n                isPending\r\n              );\r\n            }\r\n          }\r\n\r\n          // Update zIndex if supported\r\n          this.updateMarkerZIndex(\r\n            existingEntry.marker,\r\n            item,\r\n            isPrimaryType,\r\n            isSelected\r\n          );\r\n\r\n          // Update cache with new key\r\n          this.markerCache.delete(existingKey);\r\n          this.markerCache.set(item.key, existingEntry);\r\n\r\n          // Update position\r\n          try {\r\n            this.updateMarkerPosition(existingEntry.marker, coords);\r\n          } catch {\r\n            // If update fails, ignore\r\n          }\r\n        } else {\r\n          // Create new marker\r\n          this.createAndAddMarker(item, coords);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const entry of this.markerCache.values()) {\r\n      this.removeMarkerFromMap(entry.marker);\r\n    }\r\n    this.markerCache.clear();\r\n  }\r\n\r\n  protected createAndAddMarker(\r\n    item: ClusterDisplayItem,\r\n    coords: { lon: number; lat: number }\r\n  ) {\r\n    const element =\r\n      item.kind === \"primary\"\r\n        ? createPrimaryMarkerElement(\r\n            item,\r\n            this.primaryType,\r\n            this.selectedMarkerId,\r\n            this.onMarkerClick\r\n          )\r\n        : createDotMarkerElement(\r\n            item,\r\n            this.primaryType,\r\n            this.selectedMarkerId,\r\n            this.onMarkerClick\r\n          );\r\n\r\n    if (!element) return;\r\n\r\n    const isPrimaryType = item.marker.type === this.primaryType;\r\n    const isSelected = this.selectedMarkerId === item.marker.tripadvisor_id;\r\n\r\n    try {\r\n      const marker = this.createMarker(\r\n        element,\r\n        coords,\r\n        item,\r\n        isPrimaryType,\r\n        isSelected\r\n      );\r\n      if (marker) {\r\n        this.markerCache.set(item.key, {\r\n          key: item.key,\r\n          marker,\r\n          kind: item.kind,\r\n          parentId: item.kind === \"dot\" ? item.parentId : undefined,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error creating marker\", error);\r\n    }\r\n  }\r\n\r\n  // Abstract methods to be implemented by subclasses\r\n  protected abstract createMarker(\r\n    element: HTMLElement,\r\n    coords: { lon: number; lat: number },\r\n    item: ClusterDisplayItem,\r\n    isPrimaryType: boolean,\r\n    isSelected: boolean\r\n  ): TMarker | null;\r\n\r\n  protected abstract removeMarkerFromMap(marker: TMarker): void;\r\n\r\n  protected abstract updateMarkerPosition(\r\n    marker: TMarker,\r\n    coords: { lon: number; lat: number }\r\n  ): void;\r\n\r\n  protected abstract getMarkerElement(marker: TMarker): HTMLElement | null;\r\n\r\n  protected updateMarkerZIndex(\r\n    marker: TMarker,\r\n    item: ClusterDisplayItem,\r\n    isPrimaryType: boolean,\r\n    isSelected: boolean\r\n  ): void {\r\n    // Default implementation does nothing (override in subclasses that support zIndex)\r\n  }\r\n}\r\n\r\nfunction safeLatLon(location?: { lon?: number; lat?: number }) {\r\n  if (typeof location?.lon !== \"number\" || typeof location?.lat !== \"number\") {\r\n    return null;\r\n  }\r\n  if (Number.isNaN(location.lon) || Number.isNaN(location.lat)) {\r\n    return null;\r\n  }\r\n  return { lon: location.lon, lat: location.lat };\r\n}\r\n","import type { Property } from \"../../types\";\r\nimport { BaseMarkerManager } from \"../markermanager\";\r\nimport { ClusterDisplayItem } from \"../../utils/clustering\";\r\n\r\nexport type MapLibreMarkerHandle = {\r\n  setLngLat(lngLat: [number, number]): MapLibreMarkerHandle;\r\n  addTo(map: any): MapLibreMarkerHandle;\r\n  remove(): void;\r\n  getElement(): HTMLElement;\r\n};\r\n\r\nexport type MapLibreNamespace = {\r\n  Marker: new (options?: {\r\n    element?: HTMLElement;\r\n    anchor?: string;\r\n  }) => MapLibreMarkerHandle;\r\n};\r\n\r\ntype MapLibreMarkerManagerOptions = {\r\n  mapInstance: any;\r\n  maplibregl: MapLibreNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\nexport class MapLibreMarkerManager extends BaseMarkerManager<MapLibreMarkerHandle> {\r\n  private readonly MarkerCtor?: MapLibreNamespace[\"Marker\"];\r\n\r\n  constructor(options: MapLibreMarkerManagerOptions) {\r\n    super(options.mapInstance, options.onMarkerClick);\r\n    this.MarkerCtor = options.maplibregl?.Marker;\r\n  }\r\n\r\n  render(\r\n    items: ClusterDisplayItem[],\r\n    primaryType?: string,\r\n    selectedMarkerId?: number | null\r\n  ) {\r\n    if (!this.MarkerCtor) {\r\n      return;\r\n    }\r\n    super.render(items, primaryType, selectedMarkerId);\r\n  }\r\n\r\n  protected createMarker(\r\n    element: HTMLElement,\r\n    coords: { lon: number; lat: number },\r\n    item: ClusterDisplayItem\r\n  ): MapLibreMarkerHandle | null {\r\n    if (!this.MarkerCtor) return null;\r\n\r\n    return new this.MarkerCtor({\r\n      element,\r\n      anchor: item.kind === \"primary\" ? \"bottom\" : \"center\",\r\n    })\r\n      .setLngLat([coords.lon, coords.lat])\r\n      .addTo(this.mapInstance);\r\n  }\r\n\r\n  protected removeMarkerFromMap(marker: MapLibreMarkerHandle): void {\r\n    try {\r\n      marker.remove();\r\n    } catch {\r\n      // swallow removal errors\r\n    }\r\n  }\r\n\r\n  protected updateMarkerPosition(\r\n    marker: MapLibreMarkerHandle,\r\n    coords: { lon: number; lat: number }\r\n  ): void {\r\n    marker.setLngLat([coords.lon, coords.lat]);\r\n  }\r\n\r\n  protected getMarkerElement(marker: MapLibreMarkerHandle): HTMLElement | null {\r\n    return marker.getElement();\r\n  }\r\n}\r\n","import type { Property } from \"../../types\";\r\nimport { BaseMarkerManager } from \"../markermanager\";\r\nimport { ClusterDisplayItem } from \"../../utils/clustering\";\r\n\r\nexport type GoogleMapsMarkerHandle = any; // google.maps.marker.AdvancedMarkerElement\r\n\r\nexport type GoogleMapsNamespace = any; // typeof google.maps\r\n\r\ntype GoogleMapsMarkerManagerOptions = {\r\n  mapInstance: any; // google.maps.Map\r\n  google: GoogleMapsNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\nexport class GoogleMapsMarkerManager extends BaseMarkerManager<GoogleMapsMarkerHandle> {\r\n  private readonly google: GoogleMapsNamespace;\r\n\r\n  constructor(options: GoogleMapsMarkerManagerOptions) {\r\n    super(options.mapInstance, options.onMarkerClick);\r\n    this.google = options.google;\r\n  }\r\n\r\n  render(\r\n    items: ClusterDisplayItem[],\r\n    primaryType?: string,\r\n    selectedMarkerId?: number | null\r\n  ) {\r\n    if (!this.google?.marker?.AdvancedMarkerElement) {\r\n      console.warn(\"AdvancedMarkerElement not available\");\r\n      return;\r\n    }\r\n    super.render(items, primaryType, selectedMarkerId);\r\n  }\r\n\r\n  protected createMarker(\r\n    element: HTMLElement,\r\n    coords: { lon: number; lat: number },\r\n    item: ClusterDisplayItem,\r\n    isPrimaryType: boolean,\r\n    isSelected: boolean\r\n  ): GoogleMapsMarkerHandle | null {\r\n    if (!this.google?.marker?.AdvancedMarkerElement) return null;\r\n\r\n    const zIndex =\r\n      item.kind === \"primary\"\r\n        ? isSelected\r\n          ? 20\r\n          : isPrimaryType\r\n          ? 12\r\n          : 11\r\n        : isSelected\r\n        ? 20\r\n        : isPrimaryType\r\n        ? 3\r\n        : 1;\r\n\r\n    return new this.google.marker.AdvancedMarkerElement({\r\n      map: this.mapInstance,\r\n      position: { lat: coords.lat, lng: coords.lon },\r\n      content: element,\r\n      zIndex,\r\n    });\r\n  }\r\n\r\n  protected removeMarkerFromMap(marker: GoogleMapsMarkerHandle): void {\r\n    try {\r\n      marker.map = null;\r\n    } catch (error) {\r\n      console.error(\"Error removing marker\", error);\r\n    }\r\n  }\r\n\r\n  protected updateMarkerPosition(\r\n    marker: GoogleMapsMarkerHandle,\r\n    coords: { lon: number; lat: number }\r\n  ): void {\r\n    marker.position = { lat: coords.lat, lng: coords.lon };\r\n  }\r\n\r\n  protected getMarkerElement(\r\n    marker: GoogleMapsMarkerHandle\r\n  ): HTMLElement | null {\r\n    const element = marker.content;\r\n    return element instanceof HTMLElement ? element : null;\r\n  }\r\n\r\n  protected updateMarkerZIndex(\r\n    marker: GoogleMapsMarkerHandle,\r\n    item: ClusterDisplayItem,\r\n    isPrimaryType: boolean,\r\n    isSelected: boolean\r\n  ): void {\r\n    const zIndex =\r\n      item.kind === \"primary\"\r\n        ? isSelected\r\n          ? 20\r\n          : isPrimaryType\r\n          ? 12\r\n          : 11\r\n        : isSelected\r\n        ? 20\r\n        : isPrimaryType\r\n        ? 3\r\n        : 1;\r\n    marker.zIndex = zIndex;\r\n  }\r\n}\r\n","import type { Property } from \"../../types\";\r\nimport { BaseMarkerManager } from \"../markermanager\";\r\nimport { ClusterDisplayItem } from \"../../utils/clustering\";\r\n\r\nexport type MapboxMarkerHandle = {\r\n  setLngLat(lngLat: [number, number]): MapboxMarkerHandle;\r\n  addTo(map: any): MapboxMarkerHandle;\r\n  remove(): void;\r\n  getElement(): HTMLElement;\r\n};\r\n\r\nexport type MapboxNamespace = {\r\n  Marker: new (options?: {\r\n    element?: HTMLElement;\r\n    anchor?: string;\r\n  }) => MapboxMarkerHandle;\r\n};\r\n\r\ntype MapboxMarkerManagerOptions = {\r\n  mapInstance: any;\r\n  mapboxgl: MapboxNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\nexport class MapboxMarkerManager extends BaseMarkerManager<MapboxMarkerHandle> {\r\n  private readonly MarkerCtor?: MapboxNamespace[\"Marker\"];\r\n\r\n  constructor(options: MapboxMarkerManagerOptions) {\r\n    super(options.mapInstance, options.onMarkerClick);\r\n    this.MarkerCtor = options.mapboxgl?.Marker;\r\n  }\r\n\r\n  render(\r\n    items: ClusterDisplayItem[],\r\n    primaryType?: string,\r\n    selectedMarkerId?: number | null\r\n  ) {\r\n    if (!this.MarkerCtor) {\r\n      return;\r\n    }\r\n    super.render(items, primaryType, selectedMarkerId);\r\n  }\r\n\r\n  protected createMarker(\r\n    element: HTMLElement,\r\n    coords: { lon: number; lat: number },\r\n    item: ClusterDisplayItem\r\n  ): MapboxMarkerHandle | null {\r\n    if (!this.MarkerCtor) return null;\r\n\r\n    return new this.MarkerCtor({\r\n      element,\r\n      anchor: item.kind === \"primary\" ? \"bottom\" : \"center\",\r\n    })\r\n      .setLngLat([coords.lon, coords.lat])\r\n      .addTo(this.mapInstance);\r\n  }\r\n\r\n  protected removeMarkerFromMap(marker: MapboxMarkerHandle): void {\r\n    try {\r\n      marker.remove();\r\n    } catch {\r\n      // swallow removal errors\r\n    }\r\n  }\r\n\r\n  protected updateMarkerPosition(\r\n    marker: MapboxMarkerHandle,\r\n    coords: { lon: number; lat: number }\r\n  ): void {\r\n    marker.setLngLat([coords.lon, coords.lat]);\r\n  }\r\n\r\n  protected getMarkerElement(marker: MapboxMarkerHandle): HTMLElement | null {\r\n    return marker.getElement();\r\n  }\r\n}\r\n","export {\r\n  MapLibreMarkerManager,\r\n  type MapLibreMarkerHandle,\r\n  type MapLibreNamespace,\r\n} from \"./maplibre/markermanager\";\r\n\r\nexport {\r\n  GoogleMapsMarkerManager,\r\n  type GoogleMapsMarkerHandle,\r\n  type GoogleMapsNamespace,\r\n} from \"./google/markermanager\";\r\n\r\nexport {\r\n  MapboxMarkerManager,\r\n  type MapboxMarkerHandle,\r\n  type MapboxNamespace,\r\n} from \"./mapbox/markermanager\";\r\n\r\n/**\r\n * Abstract base class for map adapters supporting different map libraries\r\n */\r\nexport abstract class MapAdapter {\r\n  protected map: any;\r\n\r\n  constructor(map: any) {\r\n    this.map = map;\r\n  }\r\n\r\n  /**\r\n   * Get the underlying map instance\r\n   * @returns {any} The native map instance\r\n   */\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n\r\n  /**\r\n   * Initialize the adapter with platform-specific configuration\r\n   * @param {any} options Platform-specific initialization options\r\n   * @returns {any} The marker manager instance\r\n   */\r\n  abstract initialize(options: any): any;\r\n\r\n  /**\r\n   * Get the marker manager instance\r\n   * @returns {any} The marker manager\r\n   */\r\n  abstract getMarkerManager(): any;\r\n\r\n  /**\r\n   * Clean up event listeners and resources\r\n   */\r\n  abstract cleanup(): void;\r\n\r\n  /**\r\n   * Get the current center coordinates of the map\r\n   * @returns {{ lng: number; lat: number }} [longitude, latitude]\r\n   */\r\n  abstract getCenter(): { lng: number; lat: number };\r\n\r\n  /**\r\n   * Get the current zoom level of the map\r\n   * @returns {number} Current zoom level\r\n   */\r\n  abstract getZoom(): number;\r\n\r\n  /**\r\n   * Get the current bearing (rotation) of the map\r\n   * @returns {number} Bearing in degrees\r\n   */\r\n  abstract getBearing(): number;\r\n\r\n  /**\r\n   * Get the current pitch (tilt) of the map\r\n   * @returns {number} Pitch in degrees\r\n   */\r\n  abstract getPitch(): number;\r\n\r\n  /**\r\n   * Get the current bounds of the map viewport\r\n   * @returns {MapBounds} Map bounds with southwest and northeast corners\r\n   */\r\n  abstract getMapBounds(): MapBounds;\r\n\r\n  /**\r\n   * Project a geographical coordinate to screen space\r\n   * @param {[number, number]} lngLat [longitude, latitude]\r\n   * @returns {{ x: number; y: number }} Screen coordinates\r\n   */\r\n  abstract project(lngLat: [number, number]): { x: number; y: number };\r\n}\r\n\r\nexport type LngLat = { lng: number; lat: number };\r\n\r\nexport type MapBounds = {\r\n  sw: { lat: number; lng: number };\r\n  ne: { lat: number; lng: number };\r\n};\r\n","import { MapAdapter, type LngLat, type MapBounds } from \"../index\";\nimport { MapLibreMarkerManager, type MapLibreNamespace } from \"./markermanager\";\nimport type { Property } from \"../../types\";\n\nexport class MapLibreAdapter extends MapAdapter {\n  private markerManager?: MapLibreMarkerManager;\n  private cleanupFns: Array<() => void> = [];\n\n  constructor(map: any) {\n    super(map);\n  }\n\n  initialize(options: {\n    maplibregl: MapLibreNamespace;\n    onMarkerClick?: (marker: Property) => void;\n    onRefresh?: () => void;\n  }) {\n    this.markerManager = new MapLibreMarkerManager({\n      mapInstance: this.map,\n      maplibregl: options.maplibregl,\n      onMarkerClick: options.onMarkerClick,\n    });\n\n    if (options.onRefresh) {\n      this.attachEventListeners(options.onRefresh);\n    }\n\n    return this.markerManager;\n  }\n\n  private attachEventListeners(onRefresh: () => void) {\n    if (!this.map || typeof this.map.on !== \"function\") {\n      return;\n    }\n    const events = [\"move\", \"zoom\", \"dragend\", \"pitch\", \"rotate\"];\n    events.forEach((eventName) => {\n      this.map.on(eventName, onRefresh);\n      this.cleanupFns.push(() => {\n        if (typeof this.map.off === \"function\") {\n          this.map.off(eventName, onRefresh);\n        }\n      });\n    });\n  }\n\n  getMarkerManager() {\n    return this.markerManager;\n  }\n\n  cleanup() {\n    for (const cleanup of this.cleanupFns) {\n      try {\n        cleanup();\n      } catch {\n        // ignore\n      }\n    }\n    this.cleanupFns.length = 0;\n  }\n\n  getMap(): any {\n    return this.map;\n  }\n\n  getCenter(): LngLat {\n    const center = this.map.getCenter();\n    return { lng: center.lng, lat: center.lat };\n  }\n\n  getZoom(): number {\n    return this.map.getZoom();\n  }\n\n  getBearing(): number {\n    return this.map.getBearing();\n  }\n\n  getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  getMapBounds(): MapBounds {\n    const bounds = this.map.getBounds();\n    const sw = bounds.getSouthWest();\n    const ne = bounds.getNorthEast();\n    return {\n      sw: { lat: sw.lat, lng: sw.lng },\n      ne: { lat: ne.lat, lng: ne.lng },\n    };\n  }\n\n  project(lngLat: [number, number]) {\n    return this.map.project({ lng: lngLat[0], lat: lngLat[1] });\n  }\n\n  on(event: string, handler: (...args: any[]) => void): void {\n    this.map.on(event, handler);\n  }\n\n  off(event: string, handler: (...args: any[]) => void): void {\n    this.map.off(event, handler);\n  }\n\n  resize(): void {\n    this.map.resize();\n  }\n\n  remove(): void {\n    this.cleanup();\n    this.map.remove();\n  }\n}\n","import { MapAdapter, type LngLat, type MapBounds } from \"../index\";\r\nimport {\r\n  GoogleMapsMarkerManager,\r\n  type GoogleMapsNamespace,\r\n} from \"./markermanager\";\r\nimport type { Property } from \"../../types\";\r\n\r\nexport class GoogleMapsAdapter extends MapAdapter {\r\n  private overlayView: any;\r\n  private markerManager?: GoogleMapsMarkerManager;\r\n  private cleanupFns: Array<() => void> = [];\r\n\r\n  constructor(map: any) {\r\n    super(map);\r\n    this.initializeOverlayView();\r\n  }\r\n\r\n  initialize(options: {\r\n    google: GoogleMapsNamespace;\r\n    onMarkerClick?: (marker: Property) => void;\r\n    onRefresh?: () => void;\r\n  }) {\r\n    this.markerManager = new GoogleMapsMarkerManager({\r\n      mapInstance: this.map,\r\n      google: options.google,\r\n      onMarkerClick: options.onMarkerClick,\r\n    });\r\n\r\n    if (options.onRefresh) {\r\n      this.attachEventListeners(options.onRefresh);\r\n    }\r\n\r\n    return this.markerManager;\r\n  }\r\n\r\n  private attachEventListeners(onRefresh: () => void) {\r\n    const events = [\r\n      \"center_changed\",\r\n      \"zoom_changed\",\r\n      \"drag\",\r\n      \"heading_changed\",\r\n      \"tilt_changed\",\r\n    ];\r\n    const listeners: any[] = [];\r\n\r\n    events.forEach((eventName) => {\r\n      const listener = this.map.addListener(eventName, onRefresh);\r\n      listeners.push(listener);\r\n    });\r\n\r\n    this.cleanupFns.push(() => {\r\n      listeners.forEach((listener) => {\r\n        try {\r\n          listener.remove();\r\n        } catch {\r\n          // ignore\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  getMarkerManager() {\r\n    return this.markerManager;\r\n  }\r\n\r\n  cleanup() {\r\n    for (const cleanup of this.cleanupFns) {\r\n      try {\r\n        cleanup();\r\n      } catch {\r\n        // ignore\r\n      }\r\n    }\r\n    this.cleanupFns.length = 0;\r\n  }\r\n\r\n  private initializeOverlayView() {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (!googleMaps) return;\r\n\r\n    // Create a custom overlay to access the projection\r\n    const OverlayView = googleMaps.OverlayView;\r\n    if (!OverlayView) return;\r\n\r\n    this.overlayView = new OverlayView();\r\n    this.overlayView.draw = function () {}; // Required method\r\n    this.overlayView.setMap(this.map);\r\n  }\r\n\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n\r\n  getCenter(): LngLat {\r\n    const center = this.map.getCenter();\r\n    if (!center) {\r\n      return { lng: 0, lat: 0 };\r\n    }\r\n    return { lng: center.lng(), lat: center.lat() };\r\n  }\r\n\r\n  getZoom(): number {\r\n    return this.map.getZoom() ?? 0;\r\n  }\r\n\r\n  getBearing(): number {\r\n    return this.map.getHeading() ?? 0;\r\n  }\r\n\r\n  getPitch(): number {\r\n    return this.map.getTilt() ?? 0;\r\n  }\r\n\r\n  getMapBounds(): MapBounds {\r\n    const bounds = this.map.getBounds();\r\n    if (!bounds) {\r\n      return {\r\n        sw: { lat: 0, lng: 0 },\r\n        ne: { lat: 0, lng: 0 },\r\n      };\r\n    }\r\n    const sw = bounds.getSouthWest();\r\n    const ne = bounds.getNorthEast();\r\n    return {\r\n      sw: { lat: sw.lat(), lng: sw.lng() },\r\n      ne: { lat: ne.lat(), lng: ne.lng() },\r\n    };\r\n  }\r\n\r\n  project(lngLat: [number, number]): { x: number; y: number } {\r\n    if (!this.overlayView) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const projection = this.overlayView.getProjection();\r\n    if (!projection) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (!googleMaps) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const latLng = new googleMaps.LatLng(lngLat[1], lngLat[0]);\r\n    const point = projection.fromLatLngToContainerPixel(latLng);\r\n\r\n    if (!point) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    return {\r\n      x: point.x,\r\n      y: point.y,\r\n    };\r\n  }\r\n\r\n  on(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.addListener(event, handler);\r\n  }\r\n\r\n  off(event: string, handler: (...args: any[]) => void): void {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (googleMaps?.event) {\r\n      googleMaps.event.clearListeners(this.map, event);\r\n    }\r\n  }\r\n\r\n  resize(): void {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (googleMaps?.event) {\r\n      googleMaps.event.trigger(this.map, \"resize\");\r\n    }\r\n  }\r\n\r\n  remove(): void {\r\n    this.cleanup();\r\n    // Clean up overlay view\r\n    if (this.overlayView) {\r\n      this.overlayView.setMap(null);\r\n      this.overlayView = null;\r\n    }\r\n    // Google Maps doesn't have a remove method\r\n    // Users should handle cleanup themselves\r\n  }\r\n}\r\n","import { MapAdapter, type LngLat, type MapBounds } from \"../index\";\r\nimport { MapboxMarkerManager, type MapboxNamespace } from \"./markermanager\";\r\nimport type { Property } from \"../../types\";\r\n\r\nexport class MapboxAdapter extends MapAdapter {\r\n  private markerManager?: MapboxMarkerManager;\r\n  private cleanupFns: Array<() => void> = [];\r\n\r\n  constructor(map: any) {\r\n    super(map);\r\n  }\r\n\r\n  initialize(options: {\r\n    mapboxgl: MapboxNamespace;\r\n    onMarkerClick?: (marker: Property) => void;\r\n    onRefresh?: () => void;\r\n  }) {\r\n    this.markerManager = new MapboxMarkerManager({\r\n      mapInstance: this.map,\r\n      mapboxgl: options.mapboxgl,\r\n      onMarkerClick: options.onMarkerClick,\r\n    });\r\n\r\n    if (options.onRefresh) {\r\n      this.attachEventListeners(options.onRefresh);\r\n    }\r\n\r\n    return this.markerManager;\r\n  }\r\n\r\n  private attachEventListeners(onRefresh: () => void) {\r\n    if (!this.map || typeof this.map.on !== \"function\") {\r\n      return;\r\n    }\r\n    const events = [\"move\", \"zoom\", \"dragend\", \"pitch\", \"rotate\"];\r\n    events.forEach((eventName) => {\r\n      this.map.on(eventName, onRefresh);\r\n      this.cleanupFns.push(() => {\r\n        if (typeof this.map.off === \"function\") {\r\n          this.map.off(eventName, onRefresh);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  getMarkerManager() {\r\n    return this.markerManager;\r\n  }\r\n\r\n  cleanup() {\r\n    for (const cleanup of this.cleanupFns) {\r\n      try {\r\n        cleanup();\r\n      } catch {\r\n        // ignore\r\n      }\r\n    }\r\n    this.cleanupFns.length = 0;\r\n  }\r\n\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n\r\n  getCenter(): LngLat {\r\n    const center = this.map.getCenter();\r\n    return { lng: center.lng, lat: center.lat };\r\n  }\r\n\r\n  getZoom(): number {\r\n    return this.map.getZoom();\r\n  }\r\n\r\n  getBearing(): number {\r\n    return this.map.getBearing();\r\n  }\r\n\r\n  getPitch(): number {\r\n    return this.map.getPitch();\r\n  }\r\n\r\n  getMapBounds(): MapBounds {\r\n    const bounds = this.map.getBounds();\r\n    const sw = bounds.getSouthWest();\r\n    const ne = bounds.getNorthEast();\r\n    return {\r\n      sw: { lat: sw.lat, lng: sw.lng },\r\n      ne: { lat: ne.lat, lng: ne.lng },\r\n    };\r\n  }\r\n\r\n  project(lngLat: [number, number]) {\r\n    return this.map.project({ lng: lngLat[0], lat: lngLat[1] });\r\n  }\r\n\r\n  on(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.on(event, handler);\r\n  }\r\n\r\n  off(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.off(event, handler);\r\n  }\r\n\r\n  resize(): void {\r\n    this.map.resize();\r\n  }\r\n\r\n  remove(): void {\r\n    this.cleanup();\r\n    this.map.remove();\r\n  }\r\n}\r\n","import { MapAdapter } from \"../adapters\";\r\nimport { Property, PropertyType } from \"../types\";\r\n\r\nexport type ClusterDisplayItem =\r\n  | {\r\n      kind: \"primary\";\r\n      marker: Property;\r\n      key: string;\r\n    }\r\n  | {\r\n      kind: \"dot\";\r\n      marker: Property;\r\n      key: string;\r\n      parentId: number;\r\n    };\r\n\r\nexport type ViewStateSnapshot = {\r\n  longitude: number;\r\n  latitude: number;\r\n  zoom: number;\r\n  bearing: number;\r\n  pitch: number;\r\n};\r\n\r\nexport type ClusterParams = {\r\n  primaryType: PropertyType;\r\n  markers: Property[];\r\n  map: MapAdapter | null;\r\n  selectedMarkerId: number | null;\r\n  zoom: number;\r\n  collisionThresholdPx?: number;\r\n  dotCollisionThresholdPx?: number;\r\n};\r\n\r\nexport type ProjectedMarker = {\r\n  marker: Property;\r\n  index: number;\r\n  x: number;\r\n  y: number;\r\n};\r\n\r\nexport function extractViewState(mapInstance: MapAdapter): ViewStateSnapshot {\r\n  const center = mapInstance.getCenter();\r\n  return {\r\n    longitude: center.lng,\r\n    latitude: center.lat,\r\n    zoom: mapInstance.getZoom(),\r\n    bearing: mapInstance.getBearing(),\r\n    pitch: mapInstance.getPitch(),\r\n  };\r\n}\r\n\r\nconst COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS: Array<{\r\n  zoom: number;\r\n  threshold: number;\r\n}> = [\r\n  { zoom: 6, threshold: 120 },\r\n  { zoom: 8, threshold: 108 },\r\n  { zoom: 10, threshold: 92 },\r\n  { zoom: 12, threshold: 80 },\r\n  { zoom: 14, threshold: 68 },\r\n  { zoom: 16, threshold: 56 },\r\n];\r\n\r\nfunction resolveCollisionThreshold(zoom: number) {\r\n  for (const breakpoint of COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS) {\r\n    if (zoom <= breakpoint.zoom) {\r\n      return breakpoint.threshold;\r\n    }\r\n  }\r\n  return 48;\r\n}\r\n\r\nexport function clusterMarkers({\r\n  primaryType,\r\n  markers,\r\n  map,\r\n  selectedMarkerId,\r\n  zoom,\r\n  collisionThresholdPx,\r\n  dotCollisionThresholdPx,\r\n}: ClusterParams): ClusterDisplayItem[] {\r\n  if (!markers.length) return [];\r\n  if (!map) {\r\n    return markers.map((marker) => ({\r\n      kind: \"primary\" as const,\r\n      marker,\r\n      key: `primary-${marker.tripadvisor_id}`,\r\n    }));\r\n  }\r\n\r\n  const projected: ProjectedMarker[] = markers\r\n    .map((marker, index) => {\r\n      const location = marker.location as { lon?: number; lat?: number };\r\n      if (\r\n        typeof location?.lon !== \"number\" ||\r\n        typeof location?.lat !== \"number\"\r\n      ) {\r\n        return null;\r\n      }\r\n      const { x, y } = map.project([location.lon, location.lat]);\r\n      return { marker, index, x, y };\r\n    })\r\n    .filter((value): value is ProjectedMarker => Boolean(value));\r\n\r\n  if (!projected.length) {\r\n    return [];\r\n  }\r\n\r\n  const threshold = resolveCollisionThreshold(zoom);\r\n  const dotThreshold = resolveDotCollisionThreshold(zoom);\r\n  const parent = projected.map((_, idx) => idx);\r\n\r\n  const find = (i: number): number => {\r\n    if (parent[i] === i) return i;\r\n    parent[i] = find(parent[i]);\r\n    return parent[i];\r\n  };\r\n\r\n  const union = (a: number, b: number) => {\r\n    const rootA = find(a);\r\n    const rootB = find(b);\r\n    if (rootA === rootB) return;\r\n    parent[rootB] = rootA;\r\n  };\r\n\r\n  for (let i = 0; i < projected.length; i += 1) {\r\n    for (let j = i + 1; j < projected.length; j += 1) {\r\n      const dx = projected[i].x - projected[j].x;\r\n      const dy = projected[i].y - projected[j].y;\r\n      if (Math.hypot(dx, dy) <= threshold) {\r\n        union(i, j);\r\n      }\r\n    }\r\n  }\r\n\r\n  const groups = new Map<number, ProjectedMarker[]>();\r\n  for (const item of projected) {\r\n    const root = find(item.index);\r\n    const group = groups.get(root);\r\n    if (group) {\r\n      group.push(item);\r\n    } else {\r\n      groups.set(root, [item]);\r\n    }\r\n  }\r\n\r\n  const clustered: ClusterDisplayItem[] = [];\r\n\r\n  groups.forEach((groupItems) => {\r\n    if (groupItems.length === 1) {\r\n      const [{ marker }] = groupItems;\r\n      const isPrimary = marker.type === primaryType;\r\n      const isSelected = selectedMarkerId === marker.tripadvisor_id;\r\n      clustered.push({\r\n        kind: \"primary\",\r\n        marker,\r\n        key: `primary-${marker.tripadvisor_id}-p${isPrimary ? 1 : 0}-s${\r\n          isSelected ? 1 : 0\r\n        }-${marker.pricing?.availability}`,\r\n      });\r\n      return;\r\n    }\r\n\r\n    const sorted = [...groupItems].sort((a, b) =>\r\n      compareMarkers(b.marker, a.marker, primaryType)\r\n    );\r\n    const [primary, ...rest] = sorted;\r\n    const isPrimaryPrimary = primary.marker.type === primaryType;\r\n    const isSelectedPrimary =\r\n      selectedMarkerId === primary.marker.tripadvisor_id;\r\n    clustered.push({\r\n      kind: \"primary\",\r\n      marker: primary.marker,\r\n      key: `primary-${primary.marker.tripadvisor_id}-p${\r\n        isPrimaryPrimary ? 1 : 0\r\n      }-s${isSelectedPrimary ? 1 : 0}-${primary.marker.pricing?.availability}`,\r\n    });\r\n\r\n    if (!rest.length) return;\r\n\r\n    const dotCandidates: ProjectedMarker[] = [];\r\n    const remainder: ProjectedMarker[] = [];\r\n\r\n    rest.forEach((item) => {\r\n      if (selectedMarkerId && item.marker.tripadvisor_id === selectedMarkerId) {\r\n        const isPrimary = item.marker.type === primaryType;\r\n        clustered.push({\r\n          kind: \"primary\",\r\n          marker: item.marker,\r\n          key: `primary-${item.marker.tripadvisor_id}-p${\r\n            isPrimary ? 1 : 0\r\n          }-s1-${item.marker.pricing?.availability}`,\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (distancePx(primary, item) <= dotThreshold) {\r\n        dotCandidates.push(item);\r\n      } else {\r\n        remainder.push(item);\r\n      }\r\n    });\r\n\r\n    dotCandidates.forEach((item) => {\r\n      const isPrimary = item.marker.type === primaryType;\r\n      clustered.push({\r\n        kind: \"dot\",\r\n        marker: item.marker,\r\n        key: `dot-${item.marker.tripadvisor_id}-p${isPrimary ? 1 : 0}-s0-${\r\n          item.marker.pricing?.availability\r\n        }`,\r\n        parentId: primary.marker.tripadvisor_id,\r\n      });\r\n    });\r\n\r\n    if (remainder.length) {\r\n      const followUp = clusterMarkers({\r\n        markers: remainder.map((item) => item.marker),\r\n        map,\r\n        selectedMarkerId,\r\n        zoom,\r\n        primaryType,\r\n        collisionThresholdPx,\r\n        dotCollisionThresholdPx,\r\n      });\r\n      clustered.push(...followUp);\r\n    }\r\n  });\r\n\r\n  return clustered;\r\n}\r\n\r\nfunction distancePx(a: ProjectedMarker, b: ProjectedMarker) {\r\n  return Math.hypot(a.x - b.x, a.y - b.y);\r\n}\r\n\r\nfunction resolveDotCollisionThreshold(zoom: number) {\r\n  const base = resolveCollisionThreshold(zoom);\r\n  return Math.max(48, base);\r\n}\r\n\r\nfunction compareMarkers(a: Property, b: Property, primaryType: PropertyType) {\r\n  const aIsPrimary = a.type === primaryType;\r\n  const bIsPrimary = b.type === primaryType;\r\n  if (aIsPrimary && !bIsPrimary) return 1;\r\n  if (!aIsPrimary && bIsPrimary) return -1;\r\n\r\n  const ratingDiff = resolveRating(a) - resolveRating(b);\r\n  if (ratingDiff !== 0) return ratingDiff;\r\n\r\n  const priceDiff = resolvePrice(a) - resolvePrice(b);\r\n  if (priceDiff !== 0) return priceDiff;\r\n\r\n  const reviewsDiff = (a.reviews ?? 0) - (b.reviews ?? 0);\r\n  if (reviewsDiff !== 0) return reviewsDiff;\r\n\r\n  return a.tripadvisor_id - b.tripadvisor_id;\r\n}\r\n\r\nfunction resolveRating(marker: Property) {\r\n  if (typeof marker.rating === \"number\") return marker.rating;\r\n  if (marker.rating === undefined || marker.rating === null) return -Infinity;\r\n  const parsed = Number(marker.rating);\r\n  return Number.isNaN(parsed) ? -Infinity : parsed;\r\n}\r\n\r\nfunction resolvePrice(marker: Property) {\r\n  if (!marker.pricing?.offer?.price) return -Infinity;\r\n  const numeric = Number(\r\n    (marker.pricing.offer.displayPrice ?? \"0\")\r\n      .replace(/[^0-9.,-]+/g, \"\")\r\n      .replace(/,/g, \"\")\r\n  );\r\n  return Number.isNaN(numeric) ? -Infinity : numeric;\r\n}\r\n\r\nexport function metersToPixels(meters: number, latitude: number, zoom: number) {\r\n  const metersPerPixel =\r\n    (Math.cos((latitude * Math.PI) / 180) * 2 * Math.PI * 6378137) /\r\n    (256 * 2 ** zoom);\r\n  if (!Number.isFinite(metersPerPixel) || metersPerPixel <= 0) {\r\n    return meters;\r\n  }\r\n  return meters / metersPerPixel;\r\n}\r\n"],"mappings":"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","names":["index_exports","__export","MapFirstCore","PropertiesFetchError","fetchProperties","__toCommonJS","styleInject","css","insertAt","head","style","styleInject","createDotMarkerElement","item","primaryType","selectedMarkerId","onMarkerClick","_a","_b","_c","marker","isPrimaryType","isSelected","isPending","container","button","evt","AWARD_SVG","AWARD_BACK_SVG","EAT_DRINK_SVG","ATTRACTION_SVG","createPrimaryMarkerElement","item","primaryType","selectedMarkerId","onMarkerClick","_a","_b","_c","_d","_e","_f","_g","_h","marker","isPrimaryType","isSelected","isAccommodation","hasPrice","isPending","ratingLabel","numeric","root","pill","badge","awardContainer","backLayer","colorDot","frontLayer","content","evt","updatePrimaryMarkerElement","element","isPrimaryType","isSelected","isPending","root","pill","badge","updateDotMarkerElement","container","button","extractMarkerIdFromKey","key","match","BaseMarkerManager","mapInstance","onMarkerClick","items","primaryType","selectedMarkerId","_a","_b","_c","_d","newKeys","item","key","entry","coords","safeLatLon","existing","markerId","existingEntry","existingKey","extractMarkerIdFromKey","isPrimaryType","isSelected","isAccommodation","isPending","element","updatePrimaryMarkerElement","updateDotMarkerElement","createPrimaryMarkerElement","createDotMarkerElement","marker","error","location","MapLibreMarkerManager","BaseMarkerManager","options","_a","items","primaryType","selectedMarkerId","element","coords","item","marker","GoogleMapsMarkerManager","BaseMarkerManager","options","items","primaryType","selectedMarkerId","_a","_b","element","coords","item","isPrimaryType","isSelected","zIndex","marker","error","MapboxMarkerManager","BaseMarkerManager","options","_a","items","primaryType","selectedMarkerId","element","coords","item","marker","MapAdapter","map","MapLibreAdapter","MapAdapter","map","options","MapLibreMarkerManager","onRefresh","eventName","cleanup","center","bounds","sw","ne","lngLat","event","handler","GoogleMapsAdapter","MapAdapter","map","options","GoogleMapsMarkerManager","onRefresh","events","listeners","eventName","listener","cleanup","_a","googleMaps","OverlayView","center","bounds","sw","ne","lngLat","projection","latLng","point","event","handler","MapboxAdapter","MapAdapter","map","options","MapboxMarkerManager","onRefresh","eventName","cleanup","center","bounds","sw","ne","lngLat","event","handler","extractViewState","mapInstance","center","COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS","resolveCollisionThreshold","zoom","breakpoint","clusterMarkers","primaryType","markers","map","selectedMarkerId","collisionThresholdPx","dotCollisionThresholdPx","marker","projected","index","location","x","y","value","threshold","dotThreshold","resolveDotCollisionThreshold","parent","_","idx","find","i","union","a","b","rootA","rootB","j","dx","dy","groups","item","root","group","clustered","groupItems","_a","_b","isPrimary","isSelected","sorted","compareMarkers","primary","rest","isPrimaryPrimary","isSelectedPrimary","dotCandidates","remainder","distancePx","followUp","base","aIsPrimary","bIsPrimary","ratingDiff","resolveRating","priceDiff","resolvePrice","reviewsDiff","parsed","_c","numeric","API_URLS","PropertiesFetchError","message","status","code","fetchProperties","url","body","signal","_a","_b","response","errorBody","toISO","date","DEFAULT_PRIMARY_TYPE","getDefaultDates","base","daysUntilSaturday","checkIn","startDay","daysUntilWeekend","checkOut","MapFirstCore","options","_c","_d","_e","_f","_g","_h","_i","_j","_k","_l","_m","_n","_o","_p","isGoogleMaps","isGoogleMapsOptions","defaultDates","locationData","city","country","query","currency","requestBody","geoResponse","geoData","finalCity","finalCountry","error","defaultRequestBody","mapInstance","config","markerManager","adapterConfig","isMapLibreOptions","MapLibreAdapter","GoogleMapsAdapter","isMapboxOptions","MapboxAdapter","adapter","shouldAutoSelect","marker","properties","x","property","primary","markerId","p","context","errorMessage","errorObj","update","newState","prevState","filters","location","bounds","loading","searching","animating","longitude","latitude","zoom","animation","pois","type","animate","points","h","poi","LatLngBounds","fetchFn","onSuccess","onError","typeCounts","counts","mostCommonType","a","b","pollingLink","maxAttempts","delayMs","isCancelled","price","limit","completed","pollData","attempt","pollResp","results","prev","resultIds","updatedProperties","existingIndex","resolve","updater","beforeApplyProperties","smartFiltersClearable","data","primary_type","result","flown","newLocationId","newCity","newCountry","newCoordinates","currentLocation","onProcessFilters","filterPayload","state","amenities","hotelStyle","minRating","starRating","transformed_query","selected_restaurant_price_levels","filter","viewState","primaryType","clusterMarkers","extractViewState"]}