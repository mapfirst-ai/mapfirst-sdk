{"version":3,"sources":["../src/index.ts","#style-inject:#style-inject","../src/markers.css","../src/dotmarket.ts","../src/marker.ts","../src/adapters/maplibre/markermanager.ts","../src/adapters/google/markermanager.ts","../src/adapters/mapbox/markermanager.ts","../src/adapters/index.ts","../src/adapters/maplibre.ts","../src/adapters/google.ts","../src/adapters/mapbox.ts"],"sourcesContent":["import type { MapAdapter } from \"./adapters\";\nimport { MapLibreAdapter } from \"./adapters/maplibre\";\nimport { GoogleMapsAdapter } from \"./adapters/google\";\nimport { MapboxAdapter } from \"./adapters/mapbox\";\nimport type { Property, PropertyType } from \"./types\";\nimport {\n  MapLibreMarkerManager,\n  type MapLibreMarkerHandle,\n  type MapLibreNamespace,\n} from \"./adapters/maplibre/markermanager\";\nimport {\n  GoogleMapsMarkerManager,\n  type GoogleMapsMarkerHandle,\n  type GoogleMapsNamespace,\n} from \"./adapters/google/markermanager\";\nimport {\n  MapboxMarkerManager,\n  type MapboxMarkerHandle,\n  type MapboxNamespace,\n} from \"./adapters/mapbox/markermanager\";\n\nexport type { Property, PropertyType } from \"./types\";\n\nexport type {\n  MapLibreMarkerHandle,\n  MapLibreNamespace,\n} from \"./adapters/maplibre/markermanager\";\n\nexport type {\n  GoogleMapsMarkerHandle,\n  GoogleMapsNamespace,\n} from \"./adapters/google/markermanager\";\n\nexport type {\n  MapboxMarkerHandle,\n  MapboxNamespace,\n} from \"./adapters/mapbox/markermanager\";\n\ntype BaseMapFirstOptions = {\n  markers?: Property[];\n  primaryType?: PropertyType;\n  selectedMarkerId?: number | null;\n  clusterRadiusMeters?: number;\n  autoSelectOnClick?: boolean;\n  onClusterUpdate?: (\n    clusters: ClusterDisplayItem[],\n    viewState: ViewStateSnapshot | null\n  ) => void;\n};\n\ntype AdapterDrivenOptions = BaseMapFirstOptions & {\n  adapter: MapAdapter;\n  platform?: undefined;\n};\n\ntype MapLibreOptions = BaseMapFirstOptions & {\n  platform: \"maplibre\";\n  mapInstance: any;\n  maplibregl: MapLibreNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\ntype GoogleMapsOptions = BaseMapFirstOptions & {\n  platform: \"google\";\n  mapInstance: any; // google.maps.Map\n  google: GoogleMapsNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\ntype MapboxOptions = BaseMapFirstOptions & {\n  platform: \"mapbox\";\n  mapInstance: any;\n  mapboxgl: MapboxNamespace;\n  onMarkerClick?: (marker: Property) => void;\n};\n\nexport type MapFirstOptions =\n  | AdapterDrivenOptions\n  | MapLibreOptions\n  | GoogleMapsOptions\n  | MapboxOptions;\n\nconst DEFAULT_PRIMARY_TYPE: PropertyType = \"Accommodation\";\n\nexport type ClusterDisplayItem =\n  | {\n      kind: \"primary\";\n      marker: Property;\n      key: string;\n    }\n  | {\n      kind: \"dot\";\n      marker: Property;\n      key: string;\n      parentId: number;\n    };\n\nexport class MapFirstCore {\n  private readonly adapter: MapAdapter;\n  private readonly cleanupFns: Array<() => void> = [];\n  private readonly markerRenderer?:\n    | MapLibreMarkerManager\n    | GoogleMapsMarkerManager\n    | MapboxMarkerManager;\n  private markers: Property[] = [];\n  private primaryType?: PropertyType;\n  private selectedMarkerId: number | null = null;\n  private destroyed = false;\n  private clusterItems: ClusterDisplayItem[] = [];\n\n  constructor(private readonly options: MapFirstOptions) {\n    this.markers = [...(options.markers ?? [])];\n    this.primaryType = options.primaryType;\n    this.selectedMarkerId = options.selectedMarkerId ?? null;\n\n    if (isMapLibreOptions(options)) {\n      const shouldAutoSelect = options.autoSelectOnClick ?? true;\n      this.adapter = new MapLibreAdapter(options.mapInstance);\n      this.markerRenderer = new MapLibreMarkerManager({\n        mapInstance: options.mapInstance,\n        maplibregl: options.maplibregl,\n        onMarkerClick: (marker) => {\n          if (shouldAutoSelect) {\n            this.setSelectedMarker(marker.tripadvisor_id);\n          }\n          options.onMarkerClick?.(marker);\n        },\n      });\n      this.attachMapLibreListeners(options.mapInstance);\n    } else if (isGoogleMapsOptions(options)) {\n      const shouldAutoSelect = options.autoSelectOnClick ?? true;\n      this.adapter = new GoogleMapsAdapter(options.mapInstance);\n      this.markerRenderer = new GoogleMapsMarkerManager({\n        mapInstance: options.mapInstance,\n        google: options.google,\n        onMarkerClick: (marker) => {\n          if (shouldAutoSelect) {\n            this.setSelectedMarker(marker.tripadvisor_id);\n          }\n          options.onMarkerClick?.(marker);\n        },\n      });\n      this.attachGoogleMapsListeners(options.mapInstance);\n    } else if (isMapboxOptions(options)) {\n      const shouldAutoSelect = options.autoSelectOnClick ?? true;\n      this.adapter = new MapboxAdapter(options.mapInstance);\n      this.markerRenderer = new MapboxMarkerManager({\n        mapInstance: options.mapInstance,\n        mapboxgl: options.mapboxgl,\n        onMarkerClick: (marker) => {\n          if (shouldAutoSelect) {\n            this.setSelectedMarker(marker.tripadvisor_id);\n          }\n          options.onMarkerClick?.(marker);\n        },\n      });\n      this.attachMapboxListeners(options.mapInstance);\n    } else {\n      this.adapter = options.adapter;\n    }\n\n    this.refresh();\n  }\n\n  setMarkers(markers: Property[]) {\n    this.ensureAlive();\n    this.markers = [...markers];\n    this.refresh();\n  }\n\n  addMarker(marker: Property) {\n    this.ensureAlive();\n    this.markers = [...this.markers, marker];\n    this.refresh();\n  }\n\n  clearMarkers() {\n    this.ensureAlive();\n    this.markers = [];\n    this.refresh();\n  }\n\n  setPrimaryType(primary: PropertyType) {\n    this.ensureAlive();\n    if (this.primaryType === primary) return;\n    this.primaryType = primary;\n    this.refresh();\n  }\n\n  setSelectedMarker(markerId: number | null) {\n    this.ensureAlive();\n    if (this.selectedMarkerId === markerId) return;\n    this.selectedMarkerId = markerId;\n    this.refresh();\n  }\n\n  getClusters(): ClusterDisplayItem[] {\n    this.ensureAlive();\n    return [...this.clusterItems];\n  }\n\n  refresh() {\n    this.ensureAlive();\n    const viewState = this.safeExtractViewState();\n    const primaryType = this.resolvePrimaryType();\n\n    const { collisionPx, dotPx } = this.resolveCollisionOverrides(viewState);\n\n    this.clusterItems = clusterMarkers({\n      primaryType,\n      markers: this.markers,\n      map: this.adapter,\n      selectedMarkerId: this.selectedMarkerId,\n      zoom: viewState?.zoom ?? 0,\n      collisionThresholdPx: collisionPx,\n      dotCollisionThresholdPx: dotPx,\n    });\n\n    this.markerRenderer?.render(this.clusterItems);\n\n    this.options.onClusterUpdate?.(this.clusterItems, viewState);\n  }\n\n  destroy() {\n    if (this.destroyed) {\n      return;\n    }\n    this.markerRenderer?.destroy();\n    for (const cleanup of this.cleanupFns) {\n      try {\n        cleanup();\n      } catch {\n        // ignore listener failures on teardown\n      }\n    }\n    this.cleanupFns.length = 0;\n    this.clusterItems = [];\n    this.markers = [];\n    this.destroyed = true;\n  }\n\n  private resolvePrimaryType(): PropertyType {\n    return (\n      this.primaryType ??\n      this.markers.find((marker) => marker.type)?.type ??\n      DEFAULT_PRIMARY_TYPE\n    );\n  }\n\n  private safeExtractViewState(): ViewStateSnapshot | null {\n    try {\n      return extractViewState(this.adapter);\n    } catch {\n      return null;\n    }\n  }\n\n  private resolveCollisionOverrides(viewState: ViewStateSnapshot | null) {\n    if (!viewState) {\n      return { collisionPx: undefined, dotPx: undefined };\n    }\n    const radiusMeters = this.options.clusterRadiusMeters;\n    if (!radiusMeters || !Number.isFinite(radiusMeters) || radiusMeters <= 0) {\n      return { collisionPx: undefined, dotPx: undefined };\n    }\n    const collisionPx = metersToPixels(\n      radiusMeters,\n      viewState.latitude,\n      viewState.zoom\n    );\n    if (!Number.isFinite(collisionPx) || collisionPx <= 0) {\n      return { collisionPx: undefined, dotPx: undefined };\n    }\n    const normalized = Math.max(32, Math.round(collisionPx));\n    const dotPx = Math.max(48, normalized);\n    return { collisionPx: normalized, dotPx };\n  }\n\n  private attachMapLibreListeners(mapInstance: any) {\n    if (!mapInstance || typeof mapInstance.on !== \"function\") {\n      return;\n    }\n    const rerender = () => this.refresh();\n    const events = [\"move\", \"zoom\", \"dragend\", \"pitch\", \"rotate\"];\n    events.forEach((eventName) => {\n      mapInstance.on(eventName, rerender);\n      this.cleanupFns.push(() => {\n        if (typeof mapInstance.off === \"function\") {\n          mapInstance.off(eventName, rerender);\n        }\n      });\n    });\n  }\n\n  private attachGoogleMapsListeners(mapInstance: any) {\n    const rerender = () => this.refresh();\n    const events = [\n      \"center_changed\",\n      \"zoom_changed\",\n      \"drag\",\n      \"heading_changed\",\n      \"tilt_changed\",\n    ];\n    const listeners: any[] = [];\n\n    events.forEach((eventName) => {\n      const listener = mapInstance.addListener(eventName, rerender);\n      listeners.push(listener);\n    });\n\n    this.cleanupFns.push(() => {\n      listeners.forEach((listener) => {\n        try {\n          listener.remove();\n        } catch {\n          // ignore\n        }\n      });\n    });\n  }\n\n  private attachMapboxListeners(mapInstance: any) {\n    if (!mapInstance || typeof mapInstance.on !== \"function\") {\n      return;\n    }\n    const rerender = () => this.refresh();\n    const events = [\"move\", \"zoom\", \"dragend\", \"pitch\", \"rotate\"];\n    events.forEach((eventName) => {\n      mapInstance.on(eventName, rerender);\n      this.cleanupFns.push(() => {\n        if (typeof mapInstance.off === \"function\") {\n          mapInstance.off(eventName, rerender);\n        }\n      });\n    });\n  }\n\n  private ensureAlive() {\n    if (this.destroyed) {\n      throw new Error(\"MapFirstCore instance has been destroyed\");\n    }\n  }\n}\n\ntype ViewStateSnapshot = {\n  longitude: number;\n  latitude: number;\n  zoom: number;\n  bearing: number;\n  pitch: number;\n};\n\ntype ClusterParams = {\n  primaryType: PropertyType;\n  markers: Property[];\n  map: MapAdapter | null;\n  selectedMarkerId: number | null;\n  zoom: number;\n  collisionThresholdPx?: number;\n  dotCollisionThresholdPx?: number;\n};\n\ntype ProjectedMarker = {\n  marker: Property;\n  index: number;\n  x: number;\n  y: number;\n};\n\nfunction isMapLibreOptions(\n  options: MapFirstOptions\n): options is MapLibreOptions {\n  return (options as MapLibreOptions).platform === \"maplibre\";\n}\n\nfunction isGoogleMapsOptions(\n  options: MapFirstOptions\n): options is GoogleMapsOptions {\n  return (options as GoogleMapsOptions).platform === \"google\";\n}\n\nfunction isMapboxOptions(options: MapFirstOptions): options is MapboxOptions {\n  return (options as MapboxOptions).platform === \"mapbox\";\n}\n\nfunction extractViewState(mapInstance: MapAdapter): ViewStateSnapshot {\n  const center = mapInstance.getCenter();\n  return {\n    longitude: center.lng,\n    latitude: center.lat,\n    zoom: mapInstance.getZoom(),\n    bearing: mapInstance.getBearing(),\n    pitch: mapInstance.getPitch(),\n  };\n}\n\nconst COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS: Array<{\n  zoom: number;\n  threshold: number;\n}> = [\n  { zoom: 6, threshold: 120 },\n  { zoom: 8, threshold: 108 },\n  { zoom: 10, threshold: 92 },\n  { zoom: 12, threshold: 80 },\n  { zoom: 14, threshold: 68 },\n  { zoom: 16, threshold: 56 },\n];\n\nfunction resolveCollisionThreshold(zoom: number) {\n  for (const breakpoint of COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS) {\n    if (zoom <= breakpoint.zoom) {\n      return breakpoint.threshold;\n    }\n  }\n  return 48;\n}\n\nfunction clusterMarkers({\n  primaryType,\n  markers,\n  map,\n  selectedMarkerId,\n  zoom,\n  collisionThresholdPx,\n  dotCollisionThresholdPx,\n}: ClusterParams): ClusterDisplayItem[] {\n  if (!markers.length) return [];\n  if (!map) {\n    return markers.map((marker) => ({\n      kind: \"primary\" as const,\n      marker,\n      key: `primary-${marker.tripadvisor_id}`,\n    }));\n  }\n\n  const projected: ProjectedMarker[] = markers\n    .map((marker, index) => {\n      const location = marker.location as { lon?: number; lat?: number };\n      if (\n        typeof location?.lon !== \"number\" ||\n        typeof location?.lat !== \"number\"\n      ) {\n        return null;\n      }\n      const { x, y } = map.project([location.lon, location.lat]);\n      return { marker, index, x, y };\n    })\n    .filter((value): value is ProjectedMarker => Boolean(value));\n\n  if (!projected.length) {\n    return [];\n  }\n\n  const threshold = resolveCollisionThreshold(zoom);\n  const dotThreshold = resolveDotCollisionThreshold(zoom);\n  const parent = projected.map((_, idx) => idx);\n\n  const find = (i: number): number => {\n    if (parent[i] === i) return i;\n    parent[i] = find(parent[i]);\n    return parent[i];\n  };\n\n  const union = (a: number, b: number) => {\n    const rootA = find(a);\n    const rootB = find(b);\n    if (rootA === rootB) return;\n    parent[rootB] = rootA;\n  };\n\n  for (let i = 0; i < projected.length; i += 1) {\n    for (let j = i + 1; j < projected.length; j += 1) {\n      const dx = projected[i].x - projected[j].x;\n      const dy = projected[i].y - projected[j].y;\n      if (Math.hypot(dx, dy) <= threshold) {\n        union(i, j);\n      }\n    }\n  }\n\n  const groups = new Map<number, ProjectedMarker[]>();\n  for (const item of projected) {\n    const root = find(item.index);\n    const group = groups.get(root);\n    if (group) {\n      group.push(item);\n    } else {\n      groups.set(root, [item]);\n    }\n  }\n\n  const clustered: ClusterDisplayItem[] = [];\n\n  groups.forEach((groupItems) => {\n    if (groupItems.length === 1) {\n      const [{ marker }] = groupItems;\n      clustered.push({\n        kind: \"primary\",\n        marker,\n        key: `primary-${marker.tripadvisor_id}`,\n      });\n      return;\n    }\n\n    const sorted = [...groupItems].sort((a, b) =>\n      compareMarkers(b.marker, a.marker, primaryType)\n    );\n    const [primary, ...rest] = sorted;\n    clustered.push({\n      kind: \"primary\",\n      marker: primary.marker,\n      key: `primary-${primary.marker.tripadvisor_id}`,\n    });\n\n    if (!rest.length) return;\n\n    const dotCandidates: ProjectedMarker[] = [];\n    const remainder: ProjectedMarker[] = [];\n\n    rest.forEach((item) => {\n      if (selectedMarkerId && item.marker.tripadvisor_id === selectedMarkerId) {\n        clustered.push({\n          kind: \"primary\",\n          marker: item.marker,\n          key: `primary-${item.marker.tripadvisor_id}`,\n        });\n        return;\n      }\n\n      if (distancePx(primary, item) <= dotThreshold) {\n        dotCandidates.push(item);\n      } else {\n        remainder.push(item);\n      }\n    });\n\n    dotCandidates.forEach((item) => {\n      clustered.push({\n        kind: \"dot\",\n        marker: item.marker,\n        key: `dot-${item.marker.tripadvisor_id}`,\n        parentId: primary.marker.tripadvisor_id,\n      });\n    });\n\n    if (remainder.length) {\n      const followUp = clusterMarkers({\n        markers: remainder.map((item) => item.marker),\n        map,\n        selectedMarkerId,\n        zoom,\n        primaryType,\n        collisionThresholdPx,\n        dotCollisionThresholdPx,\n      });\n      clustered.push(...followUp);\n    }\n  });\n\n  return clustered;\n}\n\nfunction distancePx(a: ProjectedMarker, b: ProjectedMarker) {\n  return Math.hypot(a.x - b.x, a.y - b.y);\n}\n\nfunction resolveDotCollisionThreshold(zoom: number) {\n  const base = resolveCollisionThreshold(zoom);\n  return Math.max(48, base);\n}\n\nfunction compareMarkers(a: Property, b: Property, primaryType: PropertyType) {\n  const aIsPrimary = a.type === primaryType;\n  const bIsPrimary = b.type === primaryType;\n  if (aIsPrimary && !bIsPrimary) return 1;\n  if (!aIsPrimary && bIsPrimary) return -1;\n\n  const ratingDiff = resolveRating(a) - resolveRating(b);\n  if (ratingDiff !== 0) return ratingDiff;\n\n  const priceDiff = resolvePrice(a) - resolvePrice(b);\n  if (priceDiff !== 0) return priceDiff;\n\n  const reviewsDiff = (a.reviews ?? 0) - (b.reviews ?? 0);\n  if (reviewsDiff !== 0) return reviewsDiff;\n\n  return a.tripadvisor_id - b.tripadvisor_id;\n}\n\nfunction resolveRating(marker: Property) {\n  if (typeof marker.rating === \"number\") return marker.rating;\n  if (marker.rating === undefined || marker.rating === null) return -Infinity;\n  const parsed = Number(marker.rating);\n  return Number.isNaN(parsed) ? -Infinity : parsed;\n}\n\nfunction resolvePrice(marker: Property) {\n  if (!marker.pricing?.offer?.price) return -Infinity;\n  const numeric = Number(\n    (marker.pricing.offer.displayPrice ?? \"0\")\n      .replace(/[^0-9.,-]+/g, \"\")\n      .replace(/,/g, \"\")\n  );\n  return Number.isNaN(numeric) ? -Infinity : numeric;\n}\n\nfunction metersToPixels(meters: number, latitude: number, zoom: number) {\n  const metersPerPixel =\n    (Math.cos((latitude * Math.PI) / 180) * 2 * Math.PI * 6378137) /\n    (256 * 2 ** zoom);\n  if (!Number.isFinite(metersPerPixel) || metersPerPixel <= 0) {\n    return meters;\n  }\n  return meters / metersPerPixel;\n}\n","\n          export default function styleInject(css, { insertAt } = {}) {\n            if (!css || typeof document === 'undefined') return\n          \n            const head = document.head || document.getElementsByTagName('head')[0]\n            const style = document.createElement('style')\n            style.type = 'text/css'\n          \n            if (insertAt === 'top') {\n              if (head.firstChild) {\n                head.insertBefore(style, head.firstChild)\n              } else {\n                head.appendChild(style)\n              }\n            } else {\n              head.appendChild(style)\n            }\n          \n            if (style.styleSheet) {\n              style.styleSheet.cssText = css\n            } else {\n              style.appendChild(document.createTextNode(css))\n            }\n          }\n          ","import styleInject from '#style-inject';styleInject(\".mapfirst-marker-root{display:flex;z-index:20;flex-direction:column;align-items:center;pointer-events:auto}.mapfirst-marker-pill{border:2px solid;border-radius:999px;padding:8px;font-size:16px;font-weight:600;font-family:system-ui,-apple-system,sans-serif;box-shadow:0 4px 6px #6b728080;display:flex;align-items:center;justify-content:center;position:relative;transition:transform .2s;transform-origin:center bottom}.mapfirst-marker-pill-pending{background:#ffffff80;backdrop-filter:blur(4px);border-color:transparent;cursor:default}.mapfirst-marker-pill-active{background:#012b11;border-color:#fff;color:#fff;cursor:pointer}.mapfirst-marker-pill-active:hover{transform:scale(1.2)}.mapfirst-marker-badge{position:absolute;top:-12px;right:-20px}.mapfirst-marker-award-container{position:relative;width:32px;height:32px}.mapfirst-marker-award-back{position:absolute;stroke:#f5f5f5;stroke-width:2px}.mapfirst-marker-award-dot{position:absolute;top:6.2px;left:6.3px;width:18.5px;height:18.5px;border-radius:50%;z-index:1}.mapfirst-marker-award-dot-type-0{background:#ffef0e}.mapfirst-marker-award-dot-type-1{background:#01ea5b}.mapfirst-marker-award-front{position:relative;z-index:2;color:#012b11}.mapfirst-marker-rating-badge{display:flex;align-items:center;justify-content:center;border-radius:999px;background:#03852e;color:#fff;font-size:12px;line-height:1;box-shadow:0 2px 4px #0003;padding:2px 6px;border:2px solid #ffffff;font-weight:400}.mapfirst-marker-content{display:flex;align-items:center}.mapfirst-dot-marker-container{display:flex;z-index:10;align-items:center;justify-content:center;pointer-events:auto}.mapfirst-dot-marker-button{width:20px;height:20px;border-radius:999px;border:2px solid #ffffff;box-shadow:0 2px 4px #6b728066;transition:transform .2s;outline:none;transform-origin:center center}.mapfirst-dot-marker-button-pending{background:#d1d5db;cursor:default}.mapfirst-dot-marker-button-active{background:#012b11;cursor:pointer}.mapfirst-dot-marker-button-active:hover{transform:scale(1.2)}.mapfirst-dot-marker-button-active:focus{outline:2px solid #ffffff;outline-offset:2px}\\n\")","import type { ClusterDisplayItem, Property } from \".\";\r\nimport \"./markers.css\";\r\n\r\nexport function createDotMarkerElement(\r\n  item: Extract<ClusterDisplayItem, { kind: \"dot\" }>,\r\n  onMarkerClick?: (marker: Property) => void\r\n) {\r\n  if (typeof document === \"undefined\") {\r\n    return null;\r\n  }\r\n\r\n  const marker = item.marker;\r\n  const isAccommodation = marker.type === \"Accommodation\";\r\n  const isPending =\r\n    isAccommodation && marker.pricing?.offer?.availability !== \"available\";\r\n\r\n  // Create container div to match primary marker structure\r\n  const container = document.createElement(\"div\");\r\n  container.className = \"mapfirst-dot-marker-container\";\r\n\r\n  const button = document.createElement(\"button\");\r\n  button.type = \"button\";\r\n  button.className = isPending\r\n    ? \"mapfirst-dot-marker-button mapfirst-dot-marker-button-pending\"\r\n    : \"mapfirst-dot-marker-button mapfirst-dot-marker-button-active\";\r\n  button.title = marker.name ?? String(marker.tripadvisor_id);\r\n\r\n  button.addEventListener(\"click\", (evt) => {\r\n    evt.stopPropagation();\r\n    if (!isPending) {\r\n      onMarkerClick?.(marker);\r\n    }\r\n  });\r\n\r\n  container.appendChild(button);\r\n  return container;\r\n}\r\n","import type { ClusterDisplayItem, Property } from \".\";\r\nimport \"./markers.css\";\r\n\r\nconst AWARD_SVG = `<svg viewBox=\"0 0 24 24\" width=\"32\" height=\"32\" fill=\"currentColor\"><path d=\"M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014\"></path><path d=\"M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827\"></path></svg>`;\r\n\r\nconst AWARD_BACK_SVG = `<svg viewBox=\"0 0 24 24\" width=\"32\" height=\"32\"><path d=\"M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014\"></path><path d=\"M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827\"></path></svg>`;\r\n\r\nconst EAT_DRINK_SVG = `<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"currentColor\"><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M14.051 6.549v.003l1.134 1.14 3.241-3.25.003-.002 1.134 1.136-3.243 3.252 1.134 1.14a1 1 0 0 0 .09-.008c.293-.05.573-.324.72-.474l.005-.006 2.596-2.603L22 8.016l-2.597 2.604a3.73 3.73 0 0 1-1.982 1.015 4.3 4.3 0 0 1-3.162-.657l-.023-.016-.026-.018-1.366 1.407 8.509 8.512L20.219 22l-.002-.002-6.654-6.663-2.597 2.76-7.3-7.315C1.967 8.948 1.531 6.274 2.524 4.198c.241-.504.566-.973.978-1.386l8.154 8.416 1.418-1.423-.039-.045c-.858-1.002-1.048-2.368-.62-3.595a4.15 4.15 0 0 1 .983-1.561L16 2l1.135 1.138-2.598 2.602-.047.045c-.16.151-.394.374-.433.678zM3.809 5.523c-.362 1.319-.037 2.905 1.06 4.103L10.93 15.7l1.408-1.496zM2.205 20.697 3.34 21.84l4.543-4.552-1.135-1.143z\"/></svg>`;\r\n\r\nconst ATTRACTION_SVG = `<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"currentColor\"><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M7.56 7.5H3.75a.25.25 0 0 0-.25.25v10c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25v-10a.25.25 0 0 0-.25-.25h-3.81l-2-2H9.56zM8.94 4h6.12l2 2h3.19c.966 0 1.75.784 1.75 1.75v10a1.75 1.75 0 0 1-1.75 1.75H3.75A1.75 1.75 0 0 1 2 17.75v-10C2 6.784 2.784 6 3.75 6h3.19z\"/><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M12 9.25a2.75 2.75 0 1 0 0 5.5 2.75 2.75 0 0 0 0-5.5M7.75 12a4.25 4.25 0 1 1 8.5 0 4.25 4.25 0 0 1-8.5 0\"/></svg>`;\r\n\r\nexport function createPrimaryMarkerElement(\r\n  item: Extract<ClusterDisplayItem, { kind: \"primary\" }>,\r\n  onMarkerClick?: (marker: Property) => void\r\n) {\r\n  if (typeof document === \"undefined\") {\r\n    return null;\r\n  }\r\n\r\n  const marker = item.marker;\r\n  const isAccommodation = marker.type === \"Accommodation\";\r\n  const hasPrice = marker.pricing?.offer?.displayPrice;\r\n  const isPending = isAccommodation && !hasPrice;\r\n\r\n  // Rating\r\n  const ratingLabel = (() => {\r\n    if (marker.rating === undefined || marker.rating === null) return null;\r\n    const numeric =\r\n      typeof marker.rating === \"number\" ? marker.rating : Number(marker.rating);\r\n    if (Number.isNaN(numeric) || numeric <= 0) return null;\r\n    return numeric.toFixed(1);\r\n  })();\r\n\r\n  const root = document.createElement(\"div\");\r\n  root.className = \"mapfirst-marker-root\";\r\n\r\n  const pill = document.createElement(\"button\");\r\n  pill.type = \"button\";\r\n  pill.className = isPending\r\n    ? \"mapfirst-marker-pill mapfirst-marker-pill-pending\"\r\n    : \"mapfirst-marker-pill mapfirst-marker-pill-active\";\r\n  pill.title = marker.name ?? String(marker.tripadvisor_id);\r\n\r\n  // Awards or Rating badge\r\n  if (!isPending && (marker.awards?.length || ratingLabel)) {\r\n    const badge = document.createElement(\"div\");\r\n    badge.className = \"mapfirst-marker-badge\";\r\n\r\n    if (marker.awards?.length && marker.awards[0].type) {\r\n      const awardContainer = document.createElement(\"div\");\r\n      awardContainer.className = \"mapfirst-marker-award-container\";\r\n\r\n      const backLayer = document.createElement(\"div\");\r\n      backLayer.className = \"mapfirst-marker-award-back\";\r\n      backLayer.innerHTML = AWARD_BACK_SVG;\r\n\r\n      const colorDot = document.createElement(\"div\");\r\n      colorDot.className = `mapfirst-marker-award-dot mapfirst-marker-award-dot-type-${marker.awards[0].type}`;\r\n\r\n      const frontLayer = document.createElement(\"div\");\r\n      frontLayer.className = \"mapfirst-marker-award-front\";\r\n      frontLayer.innerHTML = AWARD_SVG;\r\n\r\n      awardContainer.appendChild(backLayer);\r\n      awardContainer.appendChild(colorDot);\r\n      awardContainer.appendChild(frontLayer);\r\n      badge.appendChild(awardContainer);\r\n    } else if (ratingLabel) {\r\n      badge.className = \"mapfirst-marker-badge mapfirst-marker-rating-badge\";\r\n      badge.textContent = ratingLabel;\r\n    }\r\n\r\n    pill.appendChild(badge);\r\n  }\r\n\r\n  // Content\r\n  const content = document.createElement(\"span\");\r\n  content.className = \"mapfirst-marker-content\";\r\n  if (isAccommodation) {\r\n    content.textContent = marker.pricing?.offer?.displayPrice ?? \"â€”\";\r\n  } else if (marker.type === \"Eat & Drink\") {\r\n    content.innerHTML = EAT_DRINK_SVG;\r\n  } else if (marker.type === \"Attraction\") {\r\n    content.innerHTML = ATTRACTION_SVG;\r\n  }\r\n  pill.appendChild(content);\r\n\r\n  pill.addEventListener(\"click\", (evt) => {\r\n    evt.stopPropagation();\r\n    if (!isPending) {\r\n      onMarkerClick?.(marker);\r\n    }\r\n  });\r\n\r\n  root.appendChild(pill);\r\n  return root;\r\n}\r\n","import type { ClusterDisplayItem } from \"../../index\";\r\nimport type { Property } from \"../../types\";\r\nimport { createDotMarkerElement } from \"../../dotmarket\";\r\nimport { createPrimaryMarkerElement } from \"../../marker\";\r\n\r\nexport type MapLibreMarkerHandle = {\r\n  setLngLat(lngLat: [number, number]): MapLibreMarkerHandle;\r\n  addTo(map: any): MapLibreMarkerHandle;\r\n  remove(): void;\r\n  getElement(): HTMLElement;\r\n};\r\n\r\nexport type MapLibreNamespace = {\r\n  Marker: new (options?: {\r\n    element?: HTMLElement;\r\n    anchor?: string;\r\n  }) => MapLibreMarkerHandle;\r\n};\r\n\r\ntype MapLibreMarkerManagerOptions = {\r\n  mapInstance: any;\r\n  maplibregl: MapLibreNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\ntype MarkerEntry = {\r\n  key: string;\r\n  marker: MapLibreMarkerHandle;\r\n  kind: \"primary\" | \"dot\";\r\n  parentId?: number;\r\n};\r\n\r\nexport class MapLibreMarkerManager {\r\n  private readonly mapInstance: any;\r\n  private readonly MarkerCtor?: MapLibreNamespace[\"Marker\"];\r\n  private readonly onMarkerClick?: (marker: Property) => void;\r\n  private markerCache = new Map<string, MarkerEntry>();\r\n\r\n  constructor(options: MapLibreMarkerManagerOptions) {\r\n    this.mapInstance = options.mapInstance;\r\n    this.MarkerCtor = options.maplibregl?.Marker;\r\n    this.onMarkerClick = options.onMarkerClick;\r\n  }\r\n\r\n  render(items: ClusterDisplayItem[]) {\r\n    if (!this.MarkerCtor) {\r\n      return;\r\n    }\r\n\r\n    // Create a set of keys for the new items\r\n    const newKeys = new Set(items.map((item) => item.key));\r\n\r\n    // Remove markers that are no longer needed\r\n    for (const [key, entry] of this.markerCache.entries()) {\r\n      if (!newKeys.has(key)) {\r\n        try {\r\n          entry.marker.remove();\r\n        } catch {\r\n          // swallow removal errors\r\n        }\r\n        this.markerCache.delete(key);\r\n      }\r\n    }\r\n\r\n    // Add or update markers\r\n    for (const item of items) {\r\n      const coords = safeLatLon(item.marker.location);\r\n      if (!coords) continue;\r\n\r\n      const existing = this.markerCache.get(item.key);\r\n\r\n      if (existing) {\r\n        // Update existing marker position if needed\r\n        try {\r\n          existing.marker.setLngLat([coords.lon, coords.lat]);\r\n        } catch {\r\n          // If update fails, remove and recreate\r\n          try {\r\n            existing.marker.remove();\r\n          } catch {\r\n            // swallow\r\n          }\r\n          this.markerCache.delete(item.key);\r\n          this.createAndAddMarker(item, coords);\r\n        }\r\n      } else {\r\n        // Create new marker\r\n        this.createAndAddMarker(item, coords);\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const entry of this.markerCache.values()) {\r\n      try {\r\n        entry.marker.remove();\r\n      } catch {\r\n        // swallow removal errors\r\n      }\r\n    }\r\n    this.markerCache.clear();\r\n  }\r\n\r\n  private createAndAddMarker(\r\n    item: ClusterDisplayItem,\r\n    coords: { lon: number; lat: number }\r\n  ) {\r\n    if (!this.MarkerCtor) return;\r\n\r\n    const element =\r\n      item.kind === \"primary\"\r\n        ? createPrimaryMarkerElement(item, this.onMarkerClick)\r\n        : createDotMarkerElement(item, this.onMarkerClick);\r\n\r\n    if (!element) return;\r\n\r\n    try {\r\n      const marker = new this.MarkerCtor({\r\n        element,\r\n        anchor: item.kind === \"primary\" ? \"bottom\" : \"center\",\r\n      })\r\n        .setLngLat([coords.lon, coords.lat])\r\n        .addTo(this.mapInstance);\r\n\r\n      this.markerCache.set(item.key, {\r\n        key: item.key,\r\n        marker,\r\n        kind: item.kind,\r\n        parentId: item.kind === \"dot\" ? item.parentId : undefined,\r\n      });\r\n    } catch {\r\n      // swallow marker creation errors\r\n    }\r\n  }\r\n}\r\n\r\nfunction safeLatLon(location?: { lon?: number; lat?: number }) {\r\n  if (typeof location?.lon !== \"number\" || typeof location?.lat !== \"number\") {\r\n    return null;\r\n  }\r\n  if (Number.isNaN(location.lon) || Number.isNaN(location.lat)) {\r\n    return null;\r\n  }\r\n  return { lon: location.lon, lat: location.lat };\r\n}\r\n","import type { ClusterDisplayItem } from \"../../index\";\r\nimport type { Property } from \"../../types\";\r\nimport { createDotMarkerElement } from \"../../dotmarket\";\r\nimport { createPrimaryMarkerElement } from \"../../marker\";\r\n\r\nexport type GoogleMapsMarkerHandle = any; // google.maps.marker.AdvancedMarkerElement\r\n\r\nexport type GoogleMapsNamespace = any; // typeof google.maps\r\n\r\ntype GoogleMapsMarkerManagerOptions = {\r\n  mapInstance: any; // google.maps.Map\r\n  google: GoogleMapsNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\ntype MarkerEntry = {\r\n  key: string;\r\n  marker: GoogleMapsMarkerHandle;\r\n  kind: \"primary\" | \"dot\";\r\n  parentId?: number;\r\n};\r\n\r\nexport class GoogleMapsMarkerManager {\r\n  private readonly mapInstance: any; // google.maps.Map\r\n  private readonly google: GoogleMapsNamespace;\r\n  private readonly onMarkerClick?: (marker: Property) => void;\r\n  private markerCache = new Map<string, MarkerEntry>();\r\n\r\n  constructor(options: GoogleMapsMarkerManagerOptions) {\r\n    this.mapInstance = options.mapInstance;\r\n    this.google = options.google;\r\n    this.onMarkerClick = options.onMarkerClick;\r\n  }\r\n\r\n  render(items: ClusterDisplayItem[]) {\r\n    if (!this.google?.marker?.AdvancedMarkerElement) {\r\n      console.warn(\"AdvancedMarkerElement not available\");\r\n      return;\r\n    }\r\n\r\n    // Create a set of keys for the new items\r\n    const newKeys = new Set(items.map((item) => item.key));\r\n\r\n    // Remove markers that are no longer needed\r\n    for (const [key, entry] of this.markerCache.entries()) {\r\n      if (!newKeys.has(key)) {\r\n        try {\r\n          entry.marker.map = null;\r\n        } catch (error) {\r\n          console.error(\"Error removing marker\", error);\r\n        }\r\n        this.markerCache.delete(key);\r\n      }\r\n    }\r\n\r\n    // Add or update markers\r\n    for (const item of items) {\r\n      const coords = safeLatLon(item.marker.location);\r\n      if (!coords) continue;\r\n\r\n      const existing = this.markerCache.get(item.key);\r\n\r\n      if (existing) {\r\n        // Update existing marker position if needed\r\n        try {\r\n          existing.marker.position = { lat: coords.lat, lng: coords.lon };\r\n        } catch {\r\n          // If update fails, remove and recreate\r\n          try {\r\n            existing.marker.map = null;\r\n          } catch (error) {\r\n            console.error(\"Error removing marker\", error);\r\n          }\r\n          this.markerCache.delete(item.key);\r\n          this.createAndAddMarker(item, coords);\r\n        }\r\n      } else {\r\n        // Create new marker\r\n        this.createAndAddMarker(item, coords);\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const entry of this.markerCache.values()) {\r\n      try {\r\n        entry.marker.map = null;\r\n      } catch (error) {\r\n        console.error(\"Error removing marker\", error);\r\n      }\r\n    }\r\n    this.markerCache.clear();\r\n  }\r\n\r\n  private createAndAddMarker(\r\n    item: ClusterDisplayItem,\r\n    coords: { lon: number; lat: number }\r\n  ) {\r\n    if (!this.google?.marker?.AdvancedMarkerElement) return;\r\n\r\n    const element =\r\n      item.kind === \"primary\"\r\n        ? createPrimaryMarkerElement(item, this.onMarkerClick)\r\n        : createDotMarkerElement(item, this.onMarkerClick);\r\n\r\n    if (!element) return;\r\n\r\n    try {\r\n      const marker = new this.google.marker.AdvancedMarkerElement({\r\n        map: this.mapInstance,\r\n        position: { lat: coords.lat, lng: coords.lon },\r\n        content: element,\r\n        zIndex: item.kind === \"primary\" ? 20 : 10,\r\n      });\r\n\r\n      this.markerCache.set(item.key, {\r\n        key: item.key,\r\n        marker,\r\n        kind: item.kind,\r\n        parentId: item.kind === \"dot\" ? item.parentId : undefined,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error creating marker\", error);\r\n    }\r\n  }\r\n}\r\n\r\nfunction safeLatLon(location?: { lon?: number; lat?: number }) {\r\n  if (typeof location?.lon !== \"number\" || typeof location?.lat !== \"number\") {\r\n    return null;\r\n  }\r\n  if (Number.isNaN(location.lon) || Number.isNaN(location.lat)) {\r\n    return null;\r\n  }\r\n  return { lon: location.lon, lat: location.lat };\r\n}\r\n","import type { ClusterDisplayItem } from \"../../index\";\r\nimport type { Property } from \"../../types\";\r\nimport { createDotMarkerElement } from \"../../dotmarket\";\r\nimport { createPrimaryMarkerElement } from \"../../marker\";\r\n\r\nexport type MapboxMarkerHandle = {\r\n  setLngLat(lngLat: [number, number]): MapboxMarkerHandle;\r\n  addTo(map: any): MapboxMarkerHandle;\r\n  remove(): void;\r\n  getElement(): HTMLElement;\r\n};\r\n\r\nexport type MapboxNamespace = {\r\n  Marker: new (options?: {\r\n    element?: HTMLElement;\r\n    anchor?: string;\r\n  }) => MapboxMarkerHandle;\r\n};\r\n\r\ntype MapboxMarkerManagerOptions = {\r\n  mapInstance: any;\r\n  mapboxgl: MapboxNamespace;\r\n  onMarkerClick?: (marker: Property) => void;\r\n};\r\n\r\ntype MarkerEntry = {\r\n  key: string;\r\n  marker: MapboxMarkerHandle;\r\n  kind: \"primary\" | \"dot\";\r\n  parentId?: number;\r\n};\r\n\r\nexport class MapboxMarkerManager {\r\n  private readonly mapInstance: any;\r\n  private readonly MarkerCtor?: MapboxNamespace[\"Marker\"];\r\n  private readonly onMarkerClick?: (marker: Property) => void;\r\n  private markerCache = new Map<string, MarkerEntry>();\r\n\r\n  constructor(options: MapboxMarkerManagerOptions) {\r\n    this.mapInstance = options.mapInstance;\r\n    this.MarkerCtor = options.mapboxgl?.Marker;\r\n    this.onMarkerClick = options.onMarkerClick;\r\n  }\r\n\r\n  render(items: ClusterDisplayItem[]) {\r\n    if (!this.MarkerCtor) {\r\n      return;\r\n    }\r\n\r\n    // Create a set of keys for the new items\r\n    const newKeys = new Set(items.map((item) => item.key));\r\n\r\n    // Remove markers that are no longer needed\r\n    for (const [key, entry] of this.markerCache.entries()) {\r\n      if (!newKeys.has(key)) {\r\n        try {\r\n          entry.marker.remove();\r\n        } catch {\r\n          // swallow removal errors\r\n        }\r\n        this.markerCache.delete(key);\r\n      }\r\n    }\r\n\r\n    // Add or update markers\r\n    for (const item of items) {\r\n      const coords = safeLatLon(item.marker.location);\r\n      if (!coords) continue;\r\n\r\n      const existing = this.markerCache.get(item.key);\r\n\r\n      if (existing) {\r\n        // Update existing marker position if needed\r\n        try {\r\n          existing.marker.setLngLat([coords.lon, coords.lat]);\r\n        } catch {\r\n          // If update fails, remove and recreate\r\n          try {\r\n            existing.marker.remove();\r\n          } catch {\r\n            // swallow\r\n          }\r\n          this.markerCache.delete(item.key);\r\n          this.createAndAddMarker(item, coords);\r\n        }\r\n      } else {\r\n        // Create new marker\r\n        this.createAndAddMarker(item, coords);\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const entry of this.markerCache.values()) {\r\n      try {\r\n        entry.marker.remove();\r\n      } catch {\r\n        // swallow removal errors\r\n      }\r\n    }\r\n    this.markerCache.clear();\r\n  }\r\n\r\n  private createAndAddMarker(\r\n    item: ClusterDisplayItem,\r\n    coords: { lon: number; lat: number }\r\n  ) {\r\n    if (!this.MarkerCtor) return;\r\n\r\n    const element =\r\n      item.kind === \"primary\"\r\n        ? createPrimaryMarkerElement(item, this.onMarkerClick)\r\n        : createDotMarkerElement(item, this.onMarkerClick);\r\n\r\n    if (!element) return;\r\n\r\n    try {\r\n      const marker = new this.MarkerCtor({\r\n        element,\r\n        anchor: item.kind === \"primary\" ? \"bottom\" : \"center\",\r\n      })\r\n        .setLngLat([coords.lon, coords.lat])\r\n        .addTo(this.mapInstance);\r\n\r\n      this.markerCache.set(item.key, {\r\n        key: item.key,\r\n        marker,\r\n        kind: item.kind,\r\n        parentId: item.kind === \"dot\" ? item.parentId : undefined,\r\n      });\r\n    } catch {\r\n      // swallow marker creation errors\r\n    }\r\n  }\r\n}\r\n\r\nfunction safeLatLon(location?: { lon?: number; lat?: number }) {\r\n  if (typeof location?.lon !== \"number\" || typeof location?.lat !== \"number\") {\r\n    return null;\r\n  }\r\n  if (Number.isNaN(location.lon) || Number.isNaN(location.lat)) {\r\n    return null;\r\n  }\r\n  return { lon: location.lon, lat: location.lat };\r\n}\r\n","export {\r\n  MapLibreMarkerManager,\r\n  type MapLibreMarkerHandle,\r\n  type MapLibreNamespace,\r\n} from \"./maplibre/markermanager\";\r\n\r\nexport {\r\n  GoogleMapsMarkerManager,\r\n  type GoogleMapsMarkerHandle,\r\n  type GoogleMapsNamespace,\r\n} from \"./google/markermanager\";\r\n\r\nexport {\r\n  MapboxMarkerManager,\r\n  type MapboxMarkerHandle,\r\n  type MapboxNamespace,\r\n} from \"./mapbox/markermanager\";\r\n\r\n/**\r\n * Abstract base class for map adapters supporting different map libraries\r\n */\r\nexport abstract class MapAdapter {\r\n  protected map: any;\r\n\r\n  constructor(map: any) {\r\n    this.map = map;\r\n  }\r\n\r\n  /**\r\n   * Get the underlying map instance\r\n   * @returns {any} The native map instance\r\n   */\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n  /**\r\n   * Get the current center coordinates of the map\r\n   * @returns {{ lng: number; lat: number }} [longitude, latitude]\r\n   */\r\n  abstract getCenter(): { lng: number; lat: number };\r\n\r\n  /**\r\n   * Get the current zoom level of the map\r\n   * @returns {number} Current zoom level\r\n   */\r\n  abstract getZoom(): number;\r\n\r\n  /**\r\n   * Get the current bearing (rotation) of the map\r\n   * @returns {number} Bearing in degrees\r\n   */\r\n  abstract getBearing(): number;\r\n\r\n  /**\r\n   * Get the current pitch (tilt) of the map\r\n   * @returns {number} Pitch in degrees\r\n   */\r\n  abstract getPitch(): number;\r\n\r\n  /**\r\n   * Get the current bounds of the map viewport\r\n   * @returns {MapBounds} Map bounds with southwest and northeast corners\r\n   */\r\n  abstract getMapBounds(): MapBounds;\r\n\r\n  /**\r\n   * Project a geographical coordinate to screen space\r\n   * @param {[number, number]} lngLat [longitude, latitude]\r\n   * @returns {{ x: number; y: number }} Screen coordinates\r\n   */\r\n  abstract project(lngLat: [number, number]): { x: number; y: number };\r\n}\r\n\r\nexport type LngLat = { lng: number; lat: number };\r\n\r\nexport type MapBounds = {\r\n  sw: { lat: number; lng: number };\r\n  ne: { lat: number; lng: number };\r\n};\r\n","import { MapAdapter, type LngLat, type MapBounds } from \"./index\";\n\nexport class MapLibreAdapter extends MapAdapter {\n  constructor(map: any) {\n    super(map);\n  }\n\n  getMap(): any {\n    return this.map;\n  }\n\n  getCenter(): LngLat {\n    const center = this.map.getCenter();\n    return { lng: center.lng, lat: center.lat };\n  }\n\n  getZoom(): number {\n    return this.map.getZoom();\n  }\n\n  getBearing(): number {\n    return this.map.getBearing();\n  }\n\n  getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  getMapBounds(): MapBounds {\n    const bounds = this.map.getBounds();\n    const sw = bounds.getSouthWest();\n    const ne = bounds.getNorthEast();\n    return {\n      sw: { lat: sw.lat, lng: sw.lng },\n      ne: { lat: ne.lat, lng: ne.lng },\n    };\n  }\n\n  project(lngLat: [number, number]) {\n    return this.map.project({ lng: lngLat[0], lat: lngLat[1] });\n  }\n\n  on(event: string, handler: (...args: any[]) => void): void {\n    this.map.on(event, handler);\n  }\n\n  off(event: string, handler: (...args: any[]) => void): void {\n    this.map.off(event, handler);\n  }\n\n  resize(): void {\n    this.map.resize();\n  }\n\n  remove(): void {\n    this.map.remove();\n  }\n}\n","import { MapAdapter, type LngLat, type MapBounds } from \"./index\";\r\n\r\nexport class GoogleMapsAdapter extends MapAdapter {\r\n  private overlayView: any;\r\n\r\n  constructor(map: any) {\r\n    super(map);\r\n    this.initializeOverlayView();\r\n  }\r\n\r\n  private initializeOverlayView() {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (!googleMaps) return;\r\n\r\n    // Create a custom overlay to access the projection\r\n    const OverlayView = googleMaps.OverlayView;\r\n    if (!OverlayView) return;\r\n\r\n    this.overlayView = new OverlayView();\r\n    this.overlayView.draw = function () {}; // Required method\r\n    this.overlayView.setMap(this.map);\r\n  }\r\n\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n\r\n  getCenter(): LngLat {\r\n    const center = this.map.getCenter();\r\n    if (!center) {\r\n      return { lng: 0, lat: 0 };\r\n    }\r\n    return { lng: center.lng(), lat: center.lat() };\r\n  }\r\n\r\n  getZoom(): number {\r\n    return this.map.getZoom() ?? 0;\r\n  }\r\n\r\n  getBearing(): number {\r\n    return this.map.getHeading() ?? 0;\r\n  }\r\n\r\n  getPitch(): number {\r\n    return this.map.getTilt() ?? 0;\r\n  }\r\n\r\n  getMapBounds(): MapBounds {\r\n    const bounds = this.map.getBounds();\r\n    if (!bounds) {\r\n      return {\r\n        sw: { lat: 0, lng: 0 },\r\n        ne: { lat: 0, lng: 0 },\r\n      };\r\n    }\r\n    const sw = bounds.getSouthWest();\r\n    const ne = bounds.getNorthEast();\r\n    return {\r\n      sw: { lat: sw.lat(), lng: sw.lng() },\r\n      ne: { lat: ne.lat(), lng: ne.lng() },\r\n    };\r\n  }\r\n\r\n  project(lngLat: [number, number]): { x: number; y: number } {\r\n    if (!this.overlayView) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const projection = this.overlayView.getProjection();\r\n    if (!projection) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (!googleMaps) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    const latLng = new googleMaps.LatLng(lngLat[1], lngLat[0]);\r\n    const point = projection.fromLatLngToContainerPixel(latLng);\r\n\r\n    if (!point) {\r\n      return { x: 0, y: 0 };\r\n    }\r\n\r\n    return {\r\n      x: point.x,\r\n      y: point.y,\r\n    };\r\n  }\r\n\r\n  on(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.addListener(event, handler);\r\n  }\r\n\r\n  off(event: string, handler: (...args: any[]) => void): void {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (googleMaps?.event) {\r\n      googleMaps.event.clearListeners(this.map, event);\r\n    }\r\n  }\r\n\r\n  resize(): void {\r\n    const googleMaps = (globalThis as any).google?.maps;\r\n    if (googleMaps?.event) {\r\n      googleMaps.event.trigger(this.map, \"resize\");\r\n    }\r\n  }\r\n\r\n  remove(): void {\r\n    // Clean up overlay view\r\n    if (this.overlayView) {\r\n      this.overlayView.setMap(null);\r\n      this.overlayView = null;\r\n    }\r\n    // Google Maps doesn't have a remove method\r\n    // Users should handle cleanup themselves\r\n  }\r\n}\r\n","import { MapAdapter, type LngLat, type MapBounds } from \"./index\";\r\n\r\nexport class MapboxAdapter extends MapAdapter {\r\n  constructor(map: any) {\r\n    super(map);\r\n  }\r\n\r\n  getMap(): any {\r\n    return this.map;\r\n  }\r\n\r\n  getCenter(): LngLat {\r\n    const center = this.map.getCenter();\r\n    return { lng: center.lng, lat: center.lat };\r\n  }\r\n\r\n  getZoom(): number {\r\n    return this.map.getZoom();\r\n  }\r\n\r\n  getBearing(): number {\r\n    return this.map.getBearing();\r\n  }\r\n\r\n  getPitch(): number {\r\n    return this.map.getPitch();\r\n  }\r\n\r\n  getMapBounds(): MapBounds {\r\n    const bounds = this.map.getBounds();\r\n    const sw = bounds.getSouthWest();\r\n    const ne = bounds.getNorthEast();\r\n    return {\r\n      sw: { lat: sw.lat, lng: sw.lng },\r\n      ne: { lat: ne.lat, lng: ne.lng },\r\n    };\r\n  }\r\n\r\n  project(lngLat: [number, number]) {\r\n    return this.map.project({ lng: lngLat[0], lat: lngLat[1] });\r\n  }\r\n\r\n  on(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.on(event, handler);\r\n  }\r\n\r\n  off(event: string, handler: (...args: any[]) => void): void {\r\n    this.map.off(event, handler);\r\n  }\r\n\r\n  resize(): void {\r\n    this.map.resize();\r\n  }\r\n\r\n  remove(): void {\r\n    this.map.remove();\r\n  }\r\n}\r\n"],"mappings":"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","names":["index_exports","__export","MapFirstCore","__toCommonJS","styleInject","css","insertAt","head","style","styleInject","createDotMarkerElement","item","onMarkerClick","_a","_b","_c","marker","isPending","container","button","evt","AWARD_SVG","AWARD_BACK_SVG","EAT_DRINK_SVG","ATTRACTION_SVG","createPrimaryMarkerElement","item","onMarkerClick","_a","_b","_c","_d","_e","_f","_g","_h","marker","isAccommodation","hasPrice","isPending","ratingLabel","numeric","root","pill","badge","awardContainer","backLayer","colorDot","frontLayer","content","evt","MapLibreMarkerManager","options","_a","items","newKeys","item","key","entry","coords","safeLatLon","existing","element","createPrimaryMarkerElement","createDotMarkerElement","marker","location","GoogleMapsMarkerManager","options","items","_a","_b","newKeys","item","key","entry","error","coords","safeLatLon","existing","element","createPrimaryMarkerElement","createDotMarkerElement","marker","location","MapboxMarkerManager","options","_a","items","newKeys","item","key","entry","coords","safeLatLon","existing","element","createPrimaryMarkerElement","createDotMarkerElement","marker","location","MapAdapter","map","MapLibreAdapter","MapAdapter","map","center","bounds","sw","ne","lngLat","event","handler","GoogleMapsAdapter","MapAdapter","map","_a","googleMaps","OverlayView","center","bounds","sw","ne","lngLat","projection","latLng","point","event","handler","MapboxAdapter","MapAdapter","map","center","bounds","sw","ne","lngLat","event","handler","DEFAULT_PRIMARY_TYPE","MapFirstCore","options","_a","_b","_c","_d","_e","isMapLibreOptions","shouldAutoSelect","MapLibreAdapter","MapLibreMarkerManager","marker","isGoogleMapsOptions","GoogleMapsAdapter","GoogleMapsMarkerManager","isMapboxOptions","MapboxAdapter","MapboxMarkerManager","markers","primary","markerId","viewState","primaryType","collisionPx","dotPx","clusterMarkers","cleanup","extractViewState","radiusMeters","metersToPixels","normalized","mapInstance","rerender","eventName","events","listeners","listener","center","COLLISION_THRESHOLD_PX_ZOOM_BREAKPOINTS","resolveCollisionThreshold","zoom","breakpoint","map","selectedMarkerId","collisionThresholdPx","dotCollisionThresholdPx","projected","index","location","x","value","threshold","dotThreshold","resolveDotCollisionThreshold","parent","_","idx","find","union","a","b","rootA","rootB","j","dx","dy","groups","item","root","group","clustered","groupItems","sorted","compareMarkers","rest","dotCandidates","remainder","distancePx","followUp","base","aIsPrimary","bIsPrimary","ratingDiff","resolveRating","priceDiff","resolvePrice","reviewsDiff","parsed","numeric","meters","latitude","metersPerPixel"]}