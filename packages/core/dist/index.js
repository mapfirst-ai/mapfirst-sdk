"use strict";var L=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var B=(t,e)=>{for(var r in e)L(t,r,{get:e[r],enumerable:!0})},F=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of _(e))!z.call(t,s)&&s!==r&&L(t,s,{get:()=>e[s],enumerable:!(n=N(e,s))||n.enumerable});return t};var j=t=>F(L({},"__esModule",{value:!0}),t);var X={};B(X,{MapFirstCore:()=>C});module.exports=j(X);var g=class{constructor(e){this.map=e}getMap(){return this.map}};var M=class extends g{constructor(e){super(e)}getMap(){return this.map}getCenter(){let e=this.map.getCenter();return{lng:e.lng,lat:e.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let e=this.map.getBounds(),r=e.getSouthWest(),n=e.getNorthEast();return{sw:{lat:r.lat,lng:r.lng},ne:{lat:n.lat,lng:n.lng}}}project(e){return this.map.project}on(e,r){this.map.on(e,r)}off(e,r){this.map.off(e,r)}resize(){this.map.resize()}remove(){this.map.remove()}};function T(t,e){var n;if(typeof document=="undefined")return null;let r=document.createElement("button");return r.type="button",r.style.width="14px",r.style.height="14px",r.style.borderRadius="999px",r.style.border="2px solid #ffffff",r.style.background="#012b11",r.style.boxShadow="0 6px 16px rgba(15, 23, 42, 0.4)",r.style.cursor="pointer",r.title=(n=t.marker.name)!=null?n:String(t.marker.tripadvisor_id),r.addEventListener("click",s=>{s.stopPropagation(),e==null||e(t.marker)}),r}function E(t,e){var d,o;if(typeof document=="undefined")return null;let r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.pointerEvents="auto";let n=document.createElement("button");n.type="button",n.style.background="#012b11",n.style.color="#ffffff",n.style.border="none",n.style.borderRadius="999px",n.style.padding="6px 12px",n.style.fontSize="12px",n.style.fontWeight="600",n.style.fontFamily="system-ui, -apple-system, sans-serif",n.style.boxShadow="0 15px 30px rgba(15, 23, 42, 0.45)",n.style.cursor="pointer",n.style.display="flex",n.style.flexDirection="column",n.style.gap="2px",n.style.minWidth="140px",n.style.maxWidth="220px",n.style.whiteSpace="nowrap",n.style.overflow="hidden",n.style.textOverflow="ellipsis",n.title=(d=t.marker.name)!=null?d:String(t.marker.tripadvisor_id);let s=document.createElement("span");s.textContent=(o=t.marker.name)!=null?o:`#${t.marker.tripadvisor_id}`,s.style.textAlign="left",n.appendChild(s),n.addEventListener("click",m=>{m.stopPropagation(),e==null||e(t.marker)});let i=document.createElement("span");return i.style.width="0",i.style.height="0",i.style.borderLeft="6px solid transparent",i.style.borderRight="6px solid transparent",i.style.borderTop="8px solid #012b11",i.style.marginTop="4px",r.appendChild(n),r.appendChild(i),r}var R="Accommodation",C=class{constructor(e){this.options=e;this.cleanupFns=[];this.markers=[];this.selectedMarkerId=null;this.destroyed=!1;this.clusterItems=[];var r,n,s;if(this.markers=[...(r=e.markers)!=null?r:[]],this.primaryType=e.primaryType,this.selectedMarkerId=(n=e.selectedMarkerId)!=null?n:null,H(e)){let i=(s=e.autoSelectOnClick)!=null?s:!0;this.adapter=new M(e.mapInstance),this.markerRenderer=new I({mapInstance:e.mapInstance,maplibregl:e.maplibregl,onMarkerClick:d=>{var o;i&&this.setSelectedMarker(d.tripadvisor_id),(o=e.onMarkerClick)==null||o.call(e,d)}}),this.attachMapLibreListeners(e.mapInstance)}else this.adapter=e.adapter;this.refresh()}setMarkers(e){this.ensureAlive(),this.markers=[...e],this.refresh()}addMarker(e){this.ensureAlive(),this.markers=[...this.markers,e],this.refresh()}clearMarkers(){this.ensureAlive(),this.markers=[],this.refresh()}setPrimaryType(e){this.ensureAlive(),this.primaryType!==e&&(this.primaryType=e,this.refresh())}setSelectedMarker(e){this.ensureAlive(),this.selectedMarkerId!==e&&(this.selectedMarkerId=e,this.refresh())}getClusters(){return this.ensureAlive(),[...this.clusterItems]}refresh(){var i,d,o,m;this.ensureAlive();let e=this.safeExtractViewState(),r=this.resolvePrimaryType(),{collisionPx:n,dotPx:s}=this.resolveCollisionOverrides(e);this.clusterItems=A({primaryType:r,markers:this.markers,map:this.adapter.getMap(),selectedMarkerId:this.selectedMarkerId,zoom:(i=e==null?void 0:e.zoom)!=null?i:0,collisionThresholdPx:n,dotCollisionThresholdPx:s}),(d=this.markerRenderer)==null||d.render(this.clusterItems),(m=(o=this.options).onClusterUpdate)==null||m.call(o,this.clusterItems,e)}destroy(){var e;if(!this.destroyed){(e=this.markerRenderer)==null||e.destroy();for(let r of this.cleanupFns)try{r()}catch{}this.cleanupFns.length=0,this.clusterItems=[],this.markers=[],this.destroyed=!0}}resolvePrimaryType(){var e,r,n;return(n=(r=this.primaryType)!=null?r:(e=this.markers.find(s=>s.type))==null?void 0:e.type)!=null?n:R}safeExtractViewState(){try{return V(this.adapter)}catch{return null}}resolveCollisionOverrides(e){if(!e)return{collisionPx:void 0,dotPx:void 0};let r=this.options.clusterRadiusMeters;if(!r||!Number.isFinite(r)||r<=0)return{collisionPx:void 0,dotPx:void 0};let n=K(r,e.latitude,e.zoom);if(!Number.isFinite(n)||n<=0)return{collisionPx:void 0,dotPx:void 0};let s=Math.max(32,Math.round(n)),i=Math.max(48,s);return{collisionPx:s,dotPx:i}}attachMapLibreListeners(e){if(!e||typeof e.on!="function")return;let r=()=>this.refresh();["move","zoom","dragend","pitch","rotate"].forEach(s=>{e.on(s,r),this.cleanupFns.push(()=>{typeof e.off=="function"&&e.off(s,r)})})}ensureAlive(){if(this.destroyed)throw new Error("MapFirstCore instance has been destroyed")}};function H(t){return t.platform==="maplibre"}function V(t){let e=t.getCenter();return{longitude:e.lng,latitude:e.lat,zoom:t.getZoom(),bearing:t.getBearing(),pitch:t.getPitch()}}var $=[{zoom:6,threshold:120},{zoom:8,threshold:108},{zoom:10,threshold:92},{zoom:12,threshold:80},{zoom:14,threshold:68},{zoom:16,threshold:56}];function S(t){for(let e of $)if(t<=e.zoom)return e.threshold;return 48}function A({primaryType:t,markers:e,map:r,selectedMarkerId:n,zoom:s,collisionThresholdPx:i,dotCollisionThresholdPx:d}){if(!e.length)return[];if(!r)return e.map(a=>({kind:"primary",marker:a,key:`primary-${a.tripadvisor_id}`}));let o=e.map((a,l)=>{let p=a.location;if(typeof(p==null?void 0:p.lon)!="number"||typeof(p==null?void 0:p.lat)!="number")return null;let{x:c,y:k}=r.project([p.lon,p.lat]);return{marker:a,index:l,x:c,y:k}}).filter(a=>!!a);if(!o.length)return[];let m=S(s),f=U(s),h=o.map((a,l)=>l),b=a=>h[a]===a?a:(h[a]=b(h[a]),h[a]),D=(a,l)=>{let p=b(a),c=b(l);p!==c&&(h[c]=p)};for(let a=0;a<o.length;a+=1)for(let l=a+1;l<o.length;l+=1){let p=o[a].x-o[l].x,c=o[a].y-o[l].y;Math.hypot(p,c)<=m&&D(a,l)}let v=new Map;for(let a of o){let l=b(a.index),p=v.get(l);p?p.push(a):v.set(l,[a])}let y=[];return v.forEach(a=>{if(a.length===1){let[{marker:u}]=a;y.push({kind:"primary",marker:u,key:`primary-${u.tripadvisor_id}`});return}let l=[...a].sort((u,x)=>W(x.marker,u.marker,t)),[p,...c]=l;if(y.push({kind:"primary",marker:p.marker,key:`primary-${p.marker.tripadvisor_id}`}),!c.length)return;let k=[],P=[];if(c.forEach(u=>{if(n&&u.marker.tripadvisor_id===n){y.push({kind:"primary",marker:u.marker,key:`primary-${u.marker.tripadvisor_id}`});return}Z(p,u)<=f?k.push(u):P.push(u)}),k.forEach(u=>{y.push({kind:"dot",marker:u.marker,key:`dot-${u.marker.tripadvisor_id}`,parentId:p.marker.tripadvisor_id})}),P.length){let u=A({markers:P.map(x=>x.marker),map:r,selectedMarkerId:n,zoom:s,primaryType:t,collisionThresholdPx:i,dotCollisionThresholdPx:d});y.push(...u)}}),y}function Z(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}function U(t){let e=S(t);return Math.max(48,e)}function W(t,e,r){var m,f;let n=t.type===r,s=e.type===r;if(n&&!s)return 1;if(!n&&s)return-1;let i=w(t)-w(e);if(i!==0)return i;let d=O(t)-O(e);if(d!==0)return d;let o=((m=t.reviews)!=null?m:0)-((f=e.reviews)!=null?f:0);return o!==0?o:t.tripadvisor_id-e.tripadvisor_id}function w(t){if(typeof t.rating=="number")return t.rating;if(t.rating===void 0||t.rating===null)return-1/0;let e=Number(t.rating);return Number.isNaN(e)?-1/0:e}function O(t){var r,n,s;if(!((n=(r=t.pricing)==null?void 0:r.offer)!=null&&n.price))return-1/0;let e=Number(((s=t.pricing.offer.displayPrice)!=null?s:"0").replace(/[^0-9.,-]+/g,"").replace(/,/g,""));return Number.isNaN(e)?-1/0:e}var I=class{constructor(e){this.activeMarkers=[];var r;this.mapInstance=e.mapInstance,this.MarkerCtor=(r=e.maplibregl)==null?void 0:r.Marker,this.onMarkerClick=e.onMarkerClick}render(e){if(this.clear(),!!this.MarkerCtor)for(let r of e){let n=Y(r.marker.location);if(!n)continue;let s=r.kind==="primary"?E(r,this.onMarkerClick):T(r,this.onMarkerClick);if(!s)continue;let i=new this.MarkerCtor({element:s,anchor:r.kind==="primary"?"bottom":"center"}).setLngLat([n.lon,n.lat]).addTo(this.mapInstance);this.activeMarkers.push(i)}}destroy(){this.clear()}clear(){for(let e of this.activeMarkers)try{e.remove()}catch{}this.activeMarkers=[]}};function Y(t){return typeof(t==null?void 0:t.lon)!="number"||typeof(t==null?void 0:t.lat)!="number"||Number.isNaN(t.lon)||Number.isNaN(t.lat)?null:{lon:t.lon,lat:t.lat}}function K(t,e,r){let n=Math.cos(e*Math.PI/180)*2*Math.PI*6378137/(256*2**r);return!Number.isFinite(n)||n<=0?t:t/n}0&&(module.exports={MapFirstCore});
//# sourceMappingURL=index.js.map