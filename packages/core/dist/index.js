"use strict";var C=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var _=(r,e)=>{for(var t in e)C(r,t,{get:e[t],enumerable:!0})},F=(r,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of R(e))!D.call(r,n)&&n!==t&&C(r,n,{get:()=>e[n],enumerable:!(a=N(e,n))||a.enumerable});return r};var z=r=>F(C({},"__esModule",{value:!0}),r);var Q={};_(Q,{MapFirstCore:()=>I});module.exports=z(Q);var g=class{constructor(e){this.map=e}};var v=class extends g{constructor(e){super(e)}getMap(){return this.map}getCenter(){let e=this.map.getCenter();return{lng:e.lng,lat:e.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let e=this.map.getBounds(),t=e.getSouthWest(),a=e.getNorthEast();return{sw:{lat:t.lat,lng:t.lng},ne:{lat:a.lat,lng:a.lng}}}project(e){let t=this.map.project(e);return{x:t.x,y:t.y}}on(e,t){this.map.on(e,t)}off(e,t){this.map.off(e,t)}resize(){this.map.resize()}remove(){this.map.remove()}};var B="Accommodation",I=class{constructor(e){this.options=e;this.cleanupFns=[];this.markers=[];this.selectedMarkerId=null;this.destroyed=!1;this.clusterItems=[];var t,a,n;if(this.markers=[...(t=e.markers)!=null?t:[]],this.primaryType=e.primaryType,this.selectedMarkerId=(a=e.selectedMarkerId)!=null?a:null,j(e)){let o=(n=e.autoSelectOnClick)!=null?n:!0;this.adapter=new v(e.mapInstance),this.markerRenderer=new E({mapInstance:e.mapInstance,maplibregl:e.maplibregl,onMarkerClick:s=>{var p;o&&this.setSelectedMarker(s.tripadvisor_id),(p=e.onMarkerClick)==null||p.call(e,s)}}),this.attachMapLibreListeners(e.mapInstance)}else this.adapter=e.adapter;this.refresh()}setMarkers(e){this.ensureAlive(),this.markers=[...e],this.refresh()}addMarker(e){this.ensureAlive(),this.markers=[...this.markers,e],this.refresh()}clearMarkers(){this.ensureAlive(),this.markers=[],this.refresh()}setPrimaryType(e){this.ensureAlive(),this.primaryType!==e&&(this.primaryType=e,this.refresh())}setSelectedMarker(e){this.ensureAlive(),this.selectedMarkerId!==e&&(this.selectedMarkerId=e,this.refresh())}getClusters(){return this.ensureAlive(),[...this.clusterItems]}refresh(){var o,s,p,c;this.ensureAlive();let e=this.safeExtractViewState(),t=this.resolvePrimaryType(),{collisionPx:a,dotPx:n}=this.resolveCollisionOverrides(e);this.clusterItems=O({primaryType:t,markers:this.markers,map:this.adapter,selectedMarkerId:this.selectedMarkerId,zoom:(o=e==null?void 0:e.zoom)!=null?o:0,collisionThresholdPx:a,dotCollisionThresholdPx:n}),(s=this.markerRenderer)==null||s.render(this.clusterItems,{primaryType:t,selectedMarkerId:this.selectedMarkerId}),(c=(p=this.options).onClusterUpdate)==null||c.call(p,this.clusterItems,e)}destroy(){var e;if(!this.destroyed){(e=this.markerRenderer)==null||e.destroy();for(let t of this.cleanupFns)try{t()}catch{}this.cleanupFns.length=0,this.clusterItems=[],this.markers=[],this.destroyed=!0}}resolvePrimaryType(){var e,t,a;return(a=(t=this.primaryType)!=null?t:(e=this.markers.find(n=>n.type))==null?void 0:e.type)!=null?a:B}safeExtractViewState(){try{return H(this.adapter)}catch{return null}}resolveCollisionOverrides(e){if(!e)return{collisionPx:void 0,dotPx:void 0};let t=this.options.clusterRadiusMeters;if(!t||!Number.isFinite(t)||t<=0)return{collisionPx:void 0,dotPx:void 0};let a=U(t,e.latitude,e.zoom);if(!Number.isFinite(a)||a<=0)return{collisionPx:void 0,dotPx:void 0};let n=Math.max(32,Math.round(a)),o=Math.max(48,n);return{collisionPx:n,dotPx:o}}attachMapLibreListeners(e){if(!e||typeof e.on!="function")return;let t=()=>this.refresh();["move","zoom","dragend","pitch","rotate"].forEach(n=>{e.on(n,t),this.cleanupFns.push(()=>{typeof e.off=="function"&&e.off(n,t)})})}ensureAlive(){if(this.destroyed)throw new Error("MapFirstCore instance has been destroyed")}};function j(r){return r.platform==="maplibre"}function H(r){let e=r.getCenter();return{longitude:e.lng,latitude:e.lat,zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}}var $=[{zoom:6,threshold:120},{zoom:8,threshold:108},{zoom:10,threshold:92},{zoom:12,threshold:80},{zoom:14,threshold:68},{zoom:16,threshold:56}];function w(r){for(let e of $)if(r<=e.zoom)return e.threshold;return 48}function O({primaryType:r,markers:e,map:t,selectedMarkerId:a,zoom:n,collisionThresholdPx:o,dotCollisionThresholdPx:s}){if(!e.length)return[];if(!t)return e.map(i=>({kind:"primary",marker:i,key:`primary-${i.tripadvisor_id}`}));let p=e.map((i,u)=>{let l=i.location;if(typeof(l==null?void 0:l.lon)!="number"||typeof(l==null?void 0:l.lat)!="number")return null;let{x:f,y:M}=t.project([l.lon,l.lat]);return{marker:i,index:u,x:f,y:M}}).filter(i=>!!i);if(!p.length)return[];let c=typeof o=="number"&&Number.isFinite(o)&&o>0?o:w(n),m=typeof s=="number"&&Number.isFinite(s)&&s>0?s:W(n,c),h=p.map((i,u)=>u),b=i=>h[i]===i?i:(h[i]=b(h[i]),h[i]),y=(i,u)=>{let l=b(i),f=b(u);l!==f&&(h[f]=l)};for(let i=0;i<p.length;i+=1)for(let u=i+1;u<p.length;u+=1){let l=p[i].x-p[u].x,f=p[i].y-p[u].y;Math.hypot(l,f)<=c&&y(i,u)}let x=new Map;for(let i of p){let u=b(i.index),l=x.get(u);l?l.push(i):x.set(u,[i])}let k=[];return x.forEach(i=>{if(i.length===1){let[{marker:d}]=i;k.push({kind:"primary",marker:d,key:`primary-${d.tripadvisor_id}`});return}let u=[...i].sort((d,L)=>Z(L.marker,d.marker,r)),[l,...f]=u;if(k.push({kind:"primary",marker:l.marker,key:`primary-${l.marker.tripadvisor_id}`}),!f.length)return;let M=[],P=[];if(f.forEach(d=>{if(a&&d.marker.tripadvisor_id===a){k.push({kind:"primary",marker:d.marker,key:`primary-${d.marker.tripadvisor_id}`});return}V(l,d)<=m?M.push(d):P.push(d)}),M.forEach(d=>{k.push({kind:"dot",marker:d.marker,key:`dot-${d.marker.tripadvisor_id}`,parentId:l.marker.tripadvisor_id})}),P.length){let d=O({markers:P.map(L=>L.marker),map:t,selectedMarkerId:a,zoom:n,primaryType:r,collisionThresholdPx:o,dotCollisionThresholdPx:s});k.push(...d)}}),k}function V(r,e){return Math.hypot(r.x-e.x,r.y-e.y)}function W(r,e){let t=typeof e=="number"&&Number.isFinite(e)&&e>0?e:w(r);return Math.max(48,t)}function Z(r,e,t){var c,m;let a=r.type===t,n=e.type===t;if(a&&!n)return 1;if(!a&&n)return-1;let o=T(r)-T(e);if(o!==0)return o;let s=S(r)-S(e);if(s!==0)return s;let p=((c=r.reviews)!=null?c:0)-((m=e.reviews)!=null?m:0);return p!==0?p:r.tripadvisor_id-e.tripadvisor_id}function T(r){if(typeof r.rating=="number")return r.rating;if(r.rating===void 0||r.rating===null)return-1/0;let e=Number(r.rating);return Number.isNaN(e)?-1/0:e}function S(r){var t,a,n;if(!((a=(t=r.pricing)==null?void 0:t.offer)!=null&&a.price))return-1/0;let e=Number(((n=r.pricing.offer.displayPrice)!=null?n:"0").replace(/[^0-9.,-]+/g,"").replace(/,/g,""));return Number.isNaN(e)?-1/0:e}function U(r,e,t){let a=Math.cos(e*Math.PI/180)*2*Math.PI*6378137/(256*2**t);return!Number.isFinite(a)||a<=0?r:r/a}var E=class{constructor(e){this.activeMarkers=[];var t;this.mapInstance=e.mapInstance,this.MarkerCtor=(t=e.maplibregl)==null?void 0:t.Marker,this.onMarkerClick=e.onMarkerClick}render(e,t){if(this.clear(),!!this.MarkerCtor)for(let a of e){let n=this.createMarker(a,t);n&&this.activeMarkers.push(n)}}destroy(){this.clear()}clear(){for(let e of this.activeMarkers)try{e.remove()}catch{}this.activeMarkers=[]}createMarker(e,t){if(typeof document=="undefined"||!this.MarkerCtor)return null;let a=G(e.marker.location);if(!a)return null;let n=e.kind==="primary"?Y(e,t,this.onMarkerClick):K(e,t,this.onMarkerClick);return n?new this.MarkerCtor({element:n,anchor:e.kind==="primary"?"bottom":"center"}).setLngLat([a.lon,a.lat]).addTo(this.mapInstance):null}};function Y(r,e,t){var h,b;if(typeof document=="undefined")return null;let{background:a,text:n}=A(r.marker,e),o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.pointerEvents="auto";let s=document.createElement("button");s.type="button",s.style.background=a,s.style.color=n,s.style.border="none",s.style.borderRadius="999px",s.style.padding="6px 12px",s.style.fontSize="12px",s.style.fontWeight="600",s.style.fontFamily="system-ui, -apple-system, sans-serif",s.style.boxShadow="0 15px 30px rgba(15, 23, 42, 0.45)",s.style.cursor="pointer",s.style.display="flex",s.style.flexDirection="column",s.style.gap="2px",s.style.minWidth="140px",s.style.maxWidth="220px",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.title=(h=r.marker.name)!=null?h:String(r.marker.tripadvisor_id);let p=document.createElement("span");p.textContent=(b=r.marker.name)!=null?b:`#${r.marker.tripadvisor_id}`,p.style.textAlign="left",s.appendChild(p);let c=q(r.marker);if(c){let y=document.createElement("span");y.textContent=c,y.style.fontSize="11px",y.style.fontWeight="500",y.style.opacity="0.85",y.style.textAlign="left",s.appendChild(y)}s.addEventListener("click",y=>{y.stopPropagation(),t==null||t(r.marker)});let m=document.createElement("span");return m.style.width="0",m.style.height="0",m.style.borderLeft="6px solid transparent",m.style.borderRight="6px solid transparent",m.style.borderTop=`8px solid ${a}`,m.style.marginTop="4px",o.appendChild(s),o.appendChild(m),o}function K(r,e,t){var o;if(typeof document=="undefined")return null;let{background:a}=A(r.marker,e),n=document.createElement("button");return n.type="button",n.style.width="14px",n.style.height="14px",n.style.borderRadius="999px",n.style.border="2px solid #ffffff",n.style.background=a,n.style.boxShadow="0 6px 16px rgba(15, 23, 42, 0.4)",n.style.cursor="pointer",n.title=(o=r.marker.name)!=null?o:String(r.marker.tripadvisor_id),n.addEventListener("click",s=>{s.stopPropagation(),t==null||t(r.marker)}),n}var X={Accommodation:"#2563eb","Eat & Drink":"#db2777",Attraction:"#0f766e"};function A(r,e){var a;let t=(a=X[r.type])!=null?a:"#475569";return e.selectedMarkerId===r.tripadvisor_id?{background:"#f97316",text:"#0f172a"}:e.primaryType&&r.type!==e.primaryType?{background:"#1f2937",text:"#f8fafc"}:{background:t,text:"#ffffff"}}function q(r){var a,n,o,s;let e=(n=(a=r.pricing)==null?void 0:a.offer)==null?void 0:n.displayPrice,t=J(r);return e&&t?`${t} \xB7 ${e}`:(s=(o=e!=null?e:t)!=null?o:r.city)!=null?s:r.type}function G(r){return typeof(r==null?void 0:r.lon)!="number"||typeof(r==null?void 0:r.lat)!="number"||Number.isNaN(r.lon)||Number.isNaN(r.lat)?null:{lon:r.lon,lat:r.lat}}function J(r){let e=T(r);return!Number.isFinite(e)||e<=0?null:`${e.toFixed(1)}\u2605`}0&&(module.exports={MapFirstCore});
//# sourceMappingURL=index.js.map