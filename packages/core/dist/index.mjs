var g=class{constructor(e){this.map=e}getMap(){return this.map}};var M=class extends g{constructor(e){super(e)}getMap(){return this.map}getCenter(){let e=this.map.getCenter();return{lng:e.lng,lat:e.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let e=this.map.getBounds(),r=e.getSouthWest(),t=e.getNorthEast();return{sw:{lat:r.lat,lng:r.lng},ne:{lat:t.lat,lng:t.lng}}}project(e){return this.map.project}on(e,r){this.map.on(e,r)}off(e,r){this.map.off(e,r)}resize(){this.map.resize()}remove(){this.map.remove()}};function C(n,e){var t;if(typeof document=="undefined")return null;let r=document.createElement("button");return r.type="button",r.style.width="14px",r.style.height="14px",r.style.borderRadius="999px",r.style.border="2px solid #ffffff",r.style.background="#012b11",r.style.boxShadow="0 6px 16px rgba(15, 23, 42, 0.4)",r.style.cursor="pointer",r.title=(t=n.marker.name)!=null?t:String(n.marker.tripadvisor_id),r.addEventListener("click",a=>{a.stopPropagation(),e==null||e(n.marker)}),r}function I(n,e){var d,o;if(typeof document=="undefined")return null;let r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.pointerEvents="auto";let t=document.createElement("button");t.type="button",t.style.background="#012b11",t.style.color="#ffffff",t.style.border="none",t.style.borderRadius="999px",t.style.padding="6px 12px",t.style.fontSize="12px",t.style.fontWeight="600",t.style.fontFamily="system-ui, -apple-system, sans-serif",t.style.boxShadow="0 15px 30px rgba(15, 23, 42, 0.45)",t.style.cursor="pointer",t.style.display="flex",t.style.flexDirection="column",t.style.gap="2px",t.style.minWidth="140px",t.style.maxWidth="220px",t.style.whiteSpace="nowrap",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.title=(d=n.marker.name)!=null?d:String(n.marker.tripadvisor_id);let a=document.createElement("span");a.textContent=(o=n.marker.name)!=null?o:`#${n.marker.tripadvisor_id}`,a.style.textAlign="left",t.appendChild(a),t.addEventListener("click",m=>{m.stopPropagation(),e==null||e(n.marker)});let i=document.createElement("span");return i.style.width="0",i.style.height="0",i.style.borderLeft="6px solid transparent",i.style.borderRight="6px solid transparent",i.style.borderTop="8px solid #012b11",i.style.marginTop="4px",r.appendChild(t),r.appendChild(i),r}var D="Accommodation",T=class{constructor(e){this.options=e;this.cleanupFns=[];this.markers=[];this.selectedMarkerId=null;this.destroyed=!1;this.clusterItems=[];var r,t,a;if(this.markers=[...(r=e.markers)!=null?r:[]],this.primaryType=e.primaryType,this.selectedMarkerId=(t=e.selectedMarkerId)!=null?t:null,N(e)){let i=(a=e.autoSelectOnClick)!=null?a:!0;this.adapter=new M(e.mapInstance),this.markerRenderer=new L({mapInstance:e.mapInstance,maplibregl:e.maplibregl,onMarkerClick:d=>{var o;i&&this.setSelectedMarker(d.tripadvisor_id),(o=e.onMarkerClick)==null||o.call(e,d)}}),this.attachMapLibreListeners(e.mapInstance)}else this.adapter=e.adapter;this.refresh()}setMarkers(e){this.ensureAlive(),this.markers=[...e],this.refresh()}addMarker(e){this.ensureAlive(),this.markers=[...this.markers,e],this.refresh()}clearMarkers(){this.ensureAlive(),this.markers=[],this.refresh()}setPrimaryType(e){this.ensureAlive(),this.primaryType!==e&&(this.primaryType=e,this.refresh())}setSelectedMarker(e){this.ensureAlive(),this.selectedMarkerId!==e&&(this.selectedMarkerId=e,this.refresh())}getClusters(){return this.ensureAlive(),[...this.clusterItems]}refresh(){var i,d,o,m;this.ensureAlive();let e=this.safeExtractViewState(),r=this.resolvePrimaryType(),{collisionPx:t,dotPx:a}=this.resolveCollisionOverrides(e);this.clusterItems=S({primaryType:r,markers:this.markers,map:this.adapter.getMap(),selectedMarkerId:this.selectedMarkerId,zoom:(i=e==null?void 0:e.zoom)!=null?i:0,collisionThresholdPx:t,dotCollisionThresholdPx:a}),(d=this.markerRenderer)==null||d.render(this.clusterItems),(m=(o=this.options).onClusterUpdate)==null||m.call(o,this.clusterItems,e)}destroy(){var e;if(!this.destroyed){(e=this.markerRenderer)==null||e.destroy();for(let r of this.cleanupFns)try{r()}catch{}this.cleanupFns.length=0,this.clusterItems=[],this.markers=[],this.destroyed=!0}}resolvePrimaryType(){var e,r,t;return(t=(r=this.primaryType)!=null?r:(e=this.markers.find(a=>a.type))==null?void 0:e.type)!=null?t:D}safeExtractViewState(){try{return _(this.adapter)}catch{return null}}resolveCollisionOverrides(e){if(!e)return{collisionPx:void 0,dotPx:void 0};let r=this.options.clusterRadiusMeters;if(!r||!Number.isFinite(r)||r<=0)return{collisionPx:void 0,dotPx:void 0};let t=H(r,e.latitude,e.zoom);if(!Number.isFinite(t)||t<=0)return{collisionPx:void 0,dotPx:void 0};let a=Math.max(32,Math.round(t)),i=Math.max(48,a);return{collisionPx:a,dotPx:i}}attachMapLibreListeners(e){if(!e||typeof e.on!="function")return;let r=()=>this.refresh();["move","zoom","dragend","pitch","rotate"].forEach(a=>{e.on(a,r),this.cleanupFns.push(()=>{typeof e.off=="function"&&e.off(a,r)})})}ensureAlive(){if(this.destroyed)throw new Error("MapFirstCore instance has been destroyed")}};function N(n){return n.platform==="maplibre"}function _(n){let e=n.getCenter();return{longitude:e.lng,latitude:e.lat,zoom:n.getZoom(),bearing:n.getBearing(),pitch:n.getPitch()}}var z=[{zoom:6,threshold:120},{zoom:8,threshold:108},{zoom:10,threshold:92},{zoom:12,threshold:80},{zoom:14,threshold:68},{zoom:16,threshold:56}];function O(n){for(let e of z)if(n<=e.zoom)return e.threshold;return 48}function S({primaryType:n,markers:e,map:r,selectedMarkerId:t,zoom:a,collisionThresholdPx:i,dotCollisionThresholdPx:d}){if(!e.length)return[];if(!r)return e.map(s=>({kind:"primary",marker:s,key:`primary-${s.tripadvisor_id}`}));let o=e.map((s,l)=>{let p=s.location;if(typeof(p==null?void 0:p.lon)!="number"||typeof(p==null?void 0:p.lat)!="number")return null;let{x:c,y:k}=r.project([p.lon,p.lat]);return{marker:s,index:l,x:c,y:k}}).filter(s=>!!s);if(!o.length)return[];let m=O(a),f=F(a),h=o.map((s,l)=>l),b=s=>h[s]===s?s:(h[s]=b(h[s]),h[s]),A=(s,l)=>{let p=b(s),c=b(l);p!==c&&(h[c]=p)};for(let s=0;s<o.length;s+=1)for(let l=s+1;l<o.length;l+=1){let p=o[s].x-o[l].x,c=o[s].y-o[l].y;Math.hypot(p,c)<=m&&A(s,l)}let v=new Map;for(let s of o){let l=b(s.index),p=v.get(l);p?p.push(s):v.set(l,[s])}let y=[];return v.forEach(s=>{if(s.length===1){let[{marker:u}]=s;y.push({kind:"primary",marker:u,key:`primary-${u.tripadvisor_id}`});return}let l=[...s].sort((u,x)=>j(x.marker,u.marker,n)),[p,...c]=l;if(y.push({kind:"primary",marker:p.marker,key:`primary-${p.marker.tripadvisor_id}`}),!c.length)return;let k=[],P=[];if(c.forEach(u=>{if(t&&u.marker.tripadvisor_id===t){y.push({kind:"primary",marker:u.marker,key:`primary-${u.marker.tripadvisor_id}`});return}B(p,u)<=f?k.push(u):P.push(u)}),k.forEach(u=>{y.push({kind:"dot",marker:u.marker,key:`dot-${u.marker.tripadvisor_id}`,parentId:p.marker.tripadvisor_id})}),P.length){let u=S({markers:P.map(x=>x.marker),map:r,selectedMarkerId:t,zoom:a,primaryType:n,collisionThresholdPx:i,dotCollisionThresholdPx:d});y.push(...u)}}),y}function B(n,e){return Math.hypot(n.x-e.x,n.y-e.y)}function F(n){let e=O(n);return Math.max(48,e)}function j(n,e,r){var m,f;let t=n.type===r,a=e.type===r;if(t&&!a)return 1;if(!t&&a)return-1;let i=E(n)-E(e);if(i!==0)return i;let d=w(n)-w(e);if(d!==0)return d;let o=((m=n.reviews)!=null?m:0)-((f=e.reviews)!=null?f:0);return o!==0?o:n.tripadvisor_id-e.tripadvisor_id}function E(n){if(typeof n.rating=="number")return n.rating;if(n.rating===void 0||n.rating===null)return-1/0;let e=Number(n.rating);return Number.isNaN(e)?-1/0:e}function w(n){var r,t,a;if(!((t=(r=n.pricing)==null?void 0:r.offer)!=null&&t.price))return-1/0;let e=Number(((a=n.pricing.offer.displayPrice)!=null?a:"0").replace(/[^0-9.,-]+/g,"").replace(/,/g,""));return Number.isNaN(e)?-1/0:e}var L=class{constructor(e){this.activeMarkers=[];var r;this.mapInstance=e.mapInstance,this.MarkerCtor=(r=e.maplibregl)==null?void 0:r.Marker,this.onMarkerClick=e.onMarkerClick}render(e){if(this.clear(),!!this.MarkerCtor)for(let r of e){let t=R(r.marker.location);if(!t)continue;let a=r.kind==="primary"?I(r,this.onMarkerClick):C(r,this.onMarkerClick);if(!a)continue;let i=new this.MarkerCtor({element:a,anchor:r.kind==="primary"?"bottom":"center"}).setLngLat([t.lon,t.lat]).addTo(this.mapInstance);this.activeMarkers.push(i)}}destroy(){this.clear()}clear(){for(let e of this.activeMarkers)try{e.remove()}catch{}this.activeMarkers=[]}};function R(n){return typeof(n==null?void 0:n.lon)!="number"||typeof(n==null?void 0:n.lat)!="number"||Number.isNaN(n.lon)||Number.isNaN(n.lat)?null:{lon:n.lon,lat:n.lat}}function H(n,e,r){let t=Math.cos(e*Math.PI/180)*2*Math.PI*6378137/(256*2**r);return!Number.isFinite(t)||t<=0?n:n/t}export{T as MapFirstCore};
//# sourceMappingURL=index.mjs.map