var g=class{constructor(e){this.map=e}};var v=class extends g{constructor(e){super(e)}getMap(){return this.map}getCenter(){let e=this.map.getCenter();return{lng:e.lng,lat:e.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let e=this.map.getBounds(),t=e.getSouthWest(),n=e.getNorthEast();return{sw:{lat:t.lat,lng:t.lng},ne:{lat:n.lat,lng:n.lng}}}project(e){let t=this.map.project(e);return{x:t.x,y:t.y}}on(e,t){this.map.on(e,t)}off(e,t){this.map.off(e,t)}resize(){this.map.resize()}remove(){this.map.remove()}};var A="Accommodation",T=class{constructor(e){this.options=e;this.cleanupFns=[];this.markers=[];this.selectedMarkerId=null;this.destroyed=!1;this.clusterItems=[];var t,n,a;if(this.markers=[...(t=e.markers)!=null?t:[]],this.primaryType=e.primaryType,this.selectedMarkerId=(n=e.selectedMarkerId)!=null?n:null,N(e)){let o=(a=e.autoSelectOnClick)!=null?a:!0;this.adapter=new v(e.mapInstance),this.markerRenderer=new I({mapInstance:e.mapInstance,maplibregl:e.maplibregl,onMarkerClick:s=>{var p;o&&this.setSelectedMarker(s.tripadvisor_id),(p=e.onMarkerClick)==null||p.call(e,s)}}),this.attachMapLibreListeners(e.mapInstance)}else this.adapter=e.adapter;this.refresh()}setMarkers(e){this.ensureAlive(),this.markers=[...e],this.refresh()}addMarker(e){this.ensureAlive(),this.markers=[...this.markers,e],this.refresh()}clearMarkers(){this.ensureAlive(),this.markers=[],this.refresh()}setPrimaryType(e){this.ensureAlive(),this.primaryType!==e&&(this.primaryType=e,this.refresh())}setSelectedMarker(e){this.ensureAlive(),this.selectedMarkerId!==e&&(this.selectedMarkerId=e,this.refresh())}getClusters(){return this.ensureAlive(),[...this.clusterItems]}refresh(){var o,s,p,c;this.ensureAlive();let e=this.safeExtractViewState(),t=this.resolvePrimaryType(),{collisionPx:n,dotPx:a}=this.resolveCollisionOverrides(e);this.clusterItems=w({primaryType:t,markers:this.markers,map:this.adapter,selectedMarkerId:this.selectedMarkerId,zoom:(o=e==null?void 0:e.zoom)!=null?o:0,collisionThresholdPx:n,dotCollisionThresholdPx:a}),(s=this.markerRenderer)==null||s.render(this.clusterItems,{primaryType:t,selectedMarkerId:this.selectedMarkerId}),(c=(p=this.options).onClusterUpdate)==null||c.call(p,this.clusterItems,e)}destroy(){var e;if(!this.destroyed){(e=this.markerRenderer)==null||e.destroy();for(let t of this.cleanupFns)try{t()}catch{}this.cleanupFns.length=0,this.clusterItems=[],this.markers=[],this.destroyed=!0}}resolvePrimaryType(){var e,t,n;return(n=(t=this.primaryType)!=null?t:(e=this.markers.find(a=>a.type))==null?void 0:e.type)!=null?n:A}safeExtractViewState(){try{return R(this.adapter)}catch{return null}}resolveCollisionOverrides(e){if(!e)return{collisionPx:void 0,dotPx:void 0};let t=this.options.clusterRadiusMeters;if(!t||!Number.isFinite(t)||t<=0)return{collisionPx:void 0,dotPx:void 0};let n=B(t,e.latitude,e.zoom);if(!Number.isFinite(n)||n<=0)return{collisionPx:void 0,dotPx:void 0};let a=Math.max(32,Math.round(n)),o=Math.max(48,a);return{collisionPx:a,dotPx:o}}attachMapLibreListeners(e){if(!e||typeof e.on!="function")return;let t=()=>this.refresh();["move","zoom","dragend","pitch","rotate"].forEach(a=>{e.on(a,t),this.cleanupFns.push(()=>{typeof e.off=="function"&&e.off(a,t)})})}ensureAlive(){if(this.destroyed)throw new Error("MapFirstCore instance has been destroyed")}};function N(r){return r.platform==="maplibre"}function R(r){let e=r.getCenter();return{longitude:e.lng,latitude:e.lat,zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch()}}var D=[{zoom:6,threshold:120},{zoom:8,threshold:108},{zoom:10,threshold:92},{zoom:12,threshold:80},{zoom:14,threshold:68},{zoom:16,threshold:56}];function S(r){for(let e of D)if(r<=e.zoom)return e.threshold;return 48}function w({primaryType:r,markers:e,map:t,selectedMarkerId:n,zoom:a,collisionThresholdPx:o,dotCollisionThresholdPx:s}){if(!e.length)return[];if(!t)return e.map(i=>({kind:"primary",marker:i,key:`primary-${i.tripadvisor_id}`}));let p=e.map((i,u)=>{let l=i.location;if(typeof(l==null?void 0:l.lon)!="number"||typeof(l==null?void 0:l.lat)!="number")return null;let{x:f,y:M}=t.project([l.lon,l.lat]);return{marker:i,index:u,x:f,y:M}}).filter(i=>!!i);if(!p.length)return[];let c=typeof o=="number"&&Number.isFinite(o)&&o>0?o:S(a),m=typeof s=="number"&&Number.isFinite(s)&&s>0?s:F(a,c),h=p.map((i,u)=>u),b=i=>h[i]===i?i:(h[i]=b(h[i]),h[i]),y=(i,u)=>{let l=b(i),f=b(u);l!==f&&(h[f]=l)};for(let i=0;i<p.length;i+=1)for(let u=i+1;u<p.length;u+=1){let l=p[i].x-p[u].x,f=p[i].y-p[u].y;Math.hypot(l,f)<=c&&y(i,u)}let x=new Map;for(let i of p){let u=b(i.index),l=x.get(u);l?l.push(i):x.set(u,[i])}let k=[];return x.forEach(i=>{if(i.length===1){let[{marker:d}]=i;k.push({kind:"primary",marker:d,key:`primary-${d.tripadvisor_id}`});return}let u=[...i].sort((d,L)=>z(L.marker,d.marker,r)),[l,...f]=u;if(k.push({kind:"primary",marker:l.marker,key:`primary-${l.marker.tripadvisor_id}`}),!f.length)return;let M=[],P=[];if(f.forEach(d=>{if(n&&d.marker.tripadvisor_id===n){k.push({kind:"primary",marker:d.marker,key:`primary-${d.marker.tripadvisor_id}`});return}_(l,d)<=m?M.push(d):P.push(d)}),M.forEach(d=>{k.push({kind:"dot",marker:d.marker,key:`dot-${d.marker.tripadvisor_id}`,parentId:l.marker.tripadvisor_id})}),P.length){let d=w({markers:P.map(L=>L.marker),map:t,selectedMarkerId:n,zoom:a,primaryType:r,collisionThresholdPx:o,dotCollisionThresholdPx:s});k.push(...d)}}),k}function _(r,e){return Math.hypot(r.x-e.x,r.y-e.y)}function F(r,e){let t=typeof e=="number"&&Number.isFinite(e)&&e>0?e:S(r);return Math.max(48,t)}function z(r,e,t){var c,m;let n=r.type===t,a=e.type===t;if(n&&!a)return 1;if(!n&&a)return-1;let o=C(r)-C(e);if(o!==0)return o;let s=E(r)-E(e);if(s!==0)return s;let p=((c=r.reviews)!=null?c:0)-((m=e.reviews)!=null?m:0);return p!==0?p:r.tripadvisor_id-e.tripadvisor_id}function C(r){if(typeof r.rating=="number")return r.rating;if(r.rating===void 0||r.rating===null)return-1/0;let e=Number(r.rating);return Number.isNaN(e)?-1/0:e}function E(r){var t,n,a;if(!((n=(t=r.pricing)==null?void 0:t.offer)!=null&&n.price))return-1/0;let e=Number(((a=r.pricing.offer.displayPrice)!=null?a:"0").replace(/[^0-9.,-]+/g,"").replace(/,/g,""));return Number.isNaN(e)?-1/0:e}function B(r,e,t){let n=Math.cos(e*Math.PI/180)*2*Math.PI*6378137/(256*2**t);return!Number.isFinite(n)||n<=0?r:r/n}var I=class{constructor(e){this.activeMarkers=[];var t;this.mapInstance=e.mapInstance,this.MarkerCtor=(t=e.maplibregl)==null?void 0:t.Marker,this.onMarkerClick=e.onMarkerClick}render(e,t){if(this.clear(),!!this.MarkerCtor)for(let n of e){let a=this.createMarker(n,t);a&&this.activeMarkers.push(a)}}destroy(){this.clear()}clear(){for(let e of this.activeMarkers)try{e.remove()}catch{}this.activeMarkers=[]}createMarker(e,t){if(typeof document=="undefined"||!this.MarkerCtor)return null;let n=W(e.marker.location);if(!n)return null;let a=e.kind==="primary"?j(e,t,this.onMarkerClick):H(e,t,this.onMarkerClick);return a?new this.MarkerCtor({element:a,anchor:e.kind==="primary"?"bottom":"center"}).setLngLat([n.lon,n.lat]).addTo(this.mapInstance):null}};function j(r,e,t){var h,b;if(typeof document=="undefined")return null;let{background:n,text:a}=O(r.marker,e),o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.pointerEvents="auto";let s=document.createElement("button");s.type="button",s.style.background=n,s.style.color=a,s.style.border="none",s.style.borderRadius="999px",s.style.padding="6px 12px",s.style.fontSize="12px",s.style.fontWeight="600",s.style.fontFamily="system-ui, -apple-system, sans-serif",s.style.boxShadow="0 15px 30px rgba(15, 23, 42, 0.45)",s.style.cursor="pointer",s.style.display="flex",s.style.flexDirection="column",s.style.gap="2px",s.style.minWidth="140px",s.style.maxWidth="220px",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.title=(h=r.marker.name)!=null?h:String(r.marker.tripadvisor_id);let p=document.createElement("span");p.textContent=(b=r.marker.name)!=null?b:`#${r.marker.tripadvisor_id}`,p.style.textAlign="left",s.appendChild(p);let c=V(r.marker);if(c){let y=document.createElement("span");y.textContent=c,y.style.fontSize="11px",y.style.fontWeight="500",y.style.opacity="0.85",y.style.textAlign="left",s.appendChild(y)}s.addEventListener("click",y=>{y.stopPropagation(),t==null||t(r.marker)});let m=document.createElement("span");return m.style.width="0",m.style.height="0",m.style.borderLeft="6px solid transparent",m.style.borderRight="6px solid transparent",m.style.borderTop=`8px solid ${n}`,m.style.marginTop="4px",o.appendChild(s),o.appendChild(m),o}function H(r,e,t){var o;if(typeof document=="undefined")return null;let{background:n}=O(r.marker,e),a=document.createElement("button");return a.type="button",a.style.width="14px",a.style.height="14px",a.style.borderRadius="999px",a.style.border="2px solid #ffffff",a.style.background=n,a.style.boxShadow="0 6px 16px rgba(15, 23, 42, 0.4)",a.style.cursor="pointer",a.title=(o=r.marker.name)!=null?o:String(r.marker.tripadvisor_id),a.addEventListener("click",s=>{s.stopPropagation(),t==null||t(r.marker)}),a}var $={Accommodation:"#2563eb","Eat & Drink":"#db2777",Attraction:"#0f766e"};function O(r,e){var n;let t=(n=$[r.type])!=null?n:"#475569";return e.selectedMarkerId===r.tripadvisor_id?{background:"#f97316",text:"#0f172a"}:e.primaryType&&r.type!==e.primaryType?{background:"#1f2937",text:"#f8fafc"}:{background:t,text:"#ffffff"}}function V(r){var n,a,o,s;let e=(a=(n=r.pricing)==null?void 0:n.offer)==null?void 0:a.displayPrice,t=Z(r);return e&&t?`${t} \xB7 ${e}`:(s=(o=e!=null?e:t)!=null?o:r.city)!=null?s:r.type}function W(r){return typeof(r==null?void 0:r.lon)!="number"||typeof(r==null?void 0:r.lat)!="number"||Number.isNaN(r.lon)||Number.isNaN(r.lat)?null:{lon:r.lon,lat:r.lat}}function Z(r){let e=C(r);return!Number.isFinite(e)||e<=0?null:`${e.toFixed(1)}\u2605`}export{T as MapFirstCore};
//# sourceMappingURL=index.mjs.map