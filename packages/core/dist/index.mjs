function x(a,e){var r;if(typeof document=="undefined")return null;let t=document.createElement("button");return t.type="button",t.style.width="14px",t.style.height="14px",t.style.borderRadius="999px",t.style.border="2px solid #ffffff",t.style.background="#012b11",t.style.boxShadow="0 6px 16px rgba(15, 23, 42, 0.4)",t.style.cursor="pointer",t.title=(r=a.marker.name)!=null?r:String(a.marker.tripadvisor_id),t.addEventListener("click",n=>{n.stopPropagation(),e==null||e(a.marker)}),t}function P(a,e){var i,p,m,y;if(typeof document=="undefined")return null;let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.pointerEvents="auto";let r=document.createElement("button");r.type="button",r.style.background="#012b11",r.style.color="#ffffff",r.style.border="none",r.style.borderRadius="999px",r.style.padding="6px 12px",r.style.fontSize="12px",r.style.fontWeight="600",r.style.fontFamily="system-ui, -apple-system, sans-serif",r.style.boxShadow="0 15px 30px rgba(15, 23, 42, 0.45)",r.style.cursor="pointer",r.style.display="flex",r.style.flexDirection="column",r.style.gap="2px",r.style.whiteSpace="nowrap",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.zIndex="2",r.title=(i=a.marker.name)!=null?i:String(a.marker.tripadvisor_id);let n=document.createElement("span");n.textContent=(y=(m=(p=a.marker.pricing)==null?void 0:p.offer)==null?void 0:m.displayPrice)!=null?y:"No Price",n.style.textAlign="left",r.appendChild(n),r.addEventListener("click",h=>{h.stopPropagation(),e==null||e(a.marker)});let s=document.createElement("span");return s.style.width="0",s.style.height="0",s.style.borderLeft="6px solid transparent",s.style.borderRight="6px solid transparent",s.style.borderTop="8px solid #012b11",s.style.marginTop="4px",t.appendChild(r),t.appendChild(s),t}var k=class{constructor(e){this.markerCache=new Map;var t;this.mapInstance=e.mapInstance,this.MarkerCtor=(t=e.maplibregl)==null?void 0:t.Marker,this.onMarkerClick=e.onMarkerClick}render(e){if(!this.MarkerCtor)return;let t=new Set(e.map(r=>r.key));for(let[r,n]of this.markerCache.entries())if(!t.has(r)){try{n.marker.remove()}catch{}this.markerCache.delete(r)}for(let r of e){let n=_(r.marker.location);if(!n)continue;let s=this.markerCache.get(r.key);if(s)try{s.marker.setLngLat([n.lon,n.lat])}catch{try{s.marker.remove()}catch{}this.markerCache.delete(r.key),this.createAndAddMarker(r,n)}else this.createAndAddMarker(r,n)}}destroy(){for(let e of this.markerCache.values())try{e.marker.remove()}catch{}this.markerCache.clear()}createAndAddMarker(e,t){if(!this.MarkerCtor)return;let r=e.kind==="primary"?P(e,this.onMarkerClick):x(e,this.onMarkerClick);if(r)try{let n=new this.MarkerCtor({element:r,anchor:e.kind==="primary"?"bottom":"center"}).setLngLat([t.lon,t.lat]).addTo(this.mapInstance);this.markerCache.set(e.key,{key:e.key,marker:n,kind:e.kind,parentId:e.kind==="dot"?e.parentId:void 0})}catch{}}};function _(a){return typeof(a==null?void 0:a.lon)!="number"||typeof(a==null?void 0:a.lat)!="number"||Number.isNaN(a.lon)||Number.isNaN(a.lat)?null:{lon:a.lon,lat:a.lat}}var M=class{constructor(e){this.markerCache=new Map;this.mapInstance=e.mapInstance,this.google=e.google,this.onMarkerClick=e.onMarkerClick}render(e){var r,n;if(!((n=(r=this.google)==null?void 0:r.marker)!=null&&n.AdvancedMarkerElement)){console.warn("AdvancedMarkerElement not available");return}let t=new Set(e.map(s=>s.key));for(let[s,i]of this.markerCache.entries())if(!t.has(s)){try{i.marker.map=null}catch(p){console.error("Error removing marker",p)}this.markerCache.delete(s)}for(let s of e){let i=z(s.marker.location);if(!i)continue;let p=this.markerCache.get(s.key);if(p)try{p.marker.position={lat:i.lat,lng:i.lon}}catch{try{p.marker.map=null}catch(m){console.error("Error removing marker",m)}this.markerCache.delete(s.key),this.createAndAddMarker(s,i)}else this.createAndAddMarker(s,i)}}destroy(){for(let e of this.markerCache.values())try{e.marker.map=null}catch(t){console.error("Error removing marker",t)}this.markerCache.clear()}createAndAddMarker(e,t){var n,s;if(!((s=(n=this.google)==null?void 0:n.marker)!=null&&s.AdvancedMarkerElement))return;let r=e.kind==="primary"?P(e,this.onMarkerClick):x(e,this.onMarkerClick);if(r)try{let i=new this.google.marker.AdvancedMarkerElement({map:this.mapInstance,position:{lat:t.lat,lng:t.lon},content:r});this.markerCache.set(e.key,{key:e.key,marker:i,kind:e.kind,parentId:e.kind==="dot"?e.parentId:void 0})}catch(i){console.error("Error creating marker",i)}}};function z(a){return typeof(a==null?void 0:a.lon)!="number"||typeof(a==null?void 0:a.lat)!="number"||Number.isNaN(a.lon)||Number.isNaN(a.lat)?null:{lon:a.lon,lat:a.lat}}var g=class{constructor(e){this.map=e}getMap(){return this.map}};var C=class extends g{constructor(e){super(e)}getMap(){return this.map}getCenter(){let e=this.map.getCenter();return{lng:e.lng,lat:e.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let e=this.map.getBounds(),t=e.getSouthWest(),r=e.getNorthEast();return{sw:{lat:t.lat,lng:t.lng},ne:{lat:r.lat,lng:r.lng}}}project(e){return this.map.project({lng:e[0],lat:e[1]})}on(e,t){this.map.on(e,t)}off(e,t){this.map.off(e,t)}resize(){this.map.resize()}remove(){this.map.remove()}};var L=class extends g{constructor(e){super(e),this.initializeOverlayView()}initializeOverlayView(){var r;let e=(r=globalThis.google)==null?void 0:r.maps;if(!e)return;let t=e.OverlayView;t&&(this.overlayView=new t,this.overlayView.draw=function(){},this.overlayView.setMap(this.map))}getMap(){return this.map}getCenter(){let e=this.map.getCenter();return e?{lng:e.lng(),lat:e.lat()}:{lng:0,lat:0}}getZoom(){var e;return(e=this.map.getZoom())!=null?e:0}getBearing(){var e;return(e=this.map.getHeading())!=null?e:0}getPitch(){var e;return(e=this.map.getTilt())!=null?e:0}getMapBounds(){let e=this.map.getBounds();if(!e)return{sw:{lat:0,lng:0},ne:{lat:0,lng:0}};let t=e.getSouthWest(),r=e.getNorthEast();return{sw:{lat:t.lat(),lng:t.lng()},ne:{lat:r.lat(),lng:r.lng()}}}project(e){var i;if(!this.overlayView)return{x:0,y:0};let t=this.overlayView.getProjection();if(!t)return{x:0,y:0};let r=(i=globalThis.google)==null?void 0:i.maps;if(!r)return{x:0,y:0};let n=new r.LatLng(e[1],e[0]),s=t.fromLatLngToContainerPixel(n);return s?{x:s.x,y:s.y}:{x:0,y:0}}on(e,t){this.map.addListener(e,t)}off(e,t){var n;let r=(n=globalThis.google)==null?void 0:n.maps;r!=null&&r.event&&r.event.clearListeners(this.map,e)}resize(){var t;let e=(t=globalThis.google)==null?void 0:t.maps;e!=null&&e.event&&e.event.trigger(this.map,"resize")}remove(){this.overlayView&&(this.overlayView.setMap(null),this.overlayView=null)}};var B="Accommodation",T=class{constructor(e){this.options=e;this.cleanupFns=[];this.markers=[];this.selectedMarkerId=null;this.destroyed=!1;this.clusterItems=[];var t,r,n,s;if(this.markers=[...(t=e.markers)!=null?t:[]],this.primaryType=e.primaryType,this.selectedMarkerId=(r=e.selectedMarkerId)!=null?r:null,G(e)){let i=(n=e.autoSelectOnClick)!=null?n:!0;this.adapter=new C(e.mapInstance),this.markerRenderer=new k({mapInstance:e.mapInstance,maplibregl:e.maplibregl,onMarkerClick:p=>{var m;i&&this.setSelectedMarker(p.tripadvisor_id),(m=e.onMarkerClick)==null||m.call(e,p)}}),this.attachMapLibreListeners(e.mapInstance)}else if(V(e)){let i=(s=e.autoSelectOnClick)!=null?s:!0;this.adapter=new L(e.mapInstance),this.markerRenderer=new M({mapInstance:e.mapInstance,google:e.google,onMarkerClick:p=>{var m;i&&this.setSelectedMarker(p.tripadvisor_id),(m=e.onMarkerClick)==null||m.call(e,p)}}),this.attachGoogleMapsListeners(e.mapInstance)}else this.adapter=e.adapter;this.refresh()}setMarkers(e){this.ensureAlive(),this.markers=[...e],this.refresh()}addMarker(e){this.ensureAlive(),this.markers=[...this.markers,e],this.refresh()}clearMarkers(){this.ensureAlive(),this.markers=[],this.refresh()}setPrimaryType(e){this.ensureAlive(),this.primaryType!==e&&(this.primaryType=e,this.refresh())}setSelectedMarker(e){this.ensureAlive(),this.selectedMarkerId!==e&&(this.selectedMarkerId=e,this.refresh())}getClusters(){return this.ensureAlive(),[...this.clusterItems]}refresh(){var s,i,p,m;this.ensureAlive();let e=this.safeExtractViewState(),t=this.resolvePrimaryType(),{collisionPx:r,dotPx:n}=this.resolveCollisionOverrides(e);this.clusterItems=S({primaryType:t,markers:this.markers,map:this.adapter,selectedMarkerId:this.selectedMarkerId,zoom:(s=e==null?void 0:e.zoom)!=null?s:0,collisionThresholdPx:r,dotCollisionThresholdPx:n}),(i=this.markerRenderer)==null||i.render(this.clusterItems),(m=(p=this.options).onClusterUpdate)==null||m.call(p,this.clusterItems,e)}destroy(){var e;if(!this.destroyed){(e=this.markerRenderer)==null||e.destroy();for(let t of this.cleanupFns)try{t()}catch{}this.cleanupFns.length=0,this.clusterItems=[],this.markers=[],this.destroyed=!0}}resolvePrimaryType(){var e,t,r;return(r=(t=this.primaryType)!=null?t:(e=this.markers.find(n=>n.type))==null?void 0:e.type)!=null?r:B}safeExtractViewState(){try{return F(this.adapter)}catch{return null}}resolveCollisionOverrides(e){if(!e)return{collisionPx:void 0,dotPx:void 0};let t=this.options.clusterRadiusMeters;if(!t||!Number.isFinite(t)||t<=0)return{collisionPx:void 0,dotPx:void 0};let r=$(t,e.latitude,e.zoom);if(!Number.isFinite(r)||r<=0)return{collisionPx:void 0,dotPx:void 0};let n=Math.max(32,Math.round(r)),s=Math.max(48,n);return{collisionPx:n,dotPx:s}}attachMapLibreListeners(e){if(!e||typeof e.on!="function")return;let t=()=>this.refresh();["move","zoom","dragend","pitch","rotate"].forEach(n=>{e.on(n,t),this.cleanupFns.push(()=>{typeof e.off=="function"&&e.off(n,t)})})}attachGoogleMapsListeners(e){let t=()=>this.refresh(),r=["center_changed","zoom_changed","drag","heading_changed","tilt_changed"],n=[];r.forEach(s=>{let i=e.addListener(s,t);n.push(i)}),this.cleanupFns.push(()=>{n.forEach(s=>{try{s.remove()}catch{}})})}ensureAlive(){if(this.destroyed)throw new Error("MapFirstCore instance has been destroyed")}};function G(a){return a.platform==="maplibre"}function V(a){return a.platform==="google"}function F(a){let e=a.getCenter();return{longitude:e.lng,latitude:e.lat,zoom:a.getZoom(),bearing:a.getBearing(),pitch:a.getPitch()}}var H=[{zoom:6,threshold:120},{zoom:8,threshold:108},{zoom:10,threshold:92},{zoom:12,threshold:80},{zoom:14,threshold:68},{zoom:16,threshold:56}];function O(a){for(let e of H)if(a<=e.zoom)return e.threshold;return 48}function S({primaryType:a,markers:e,map:t,selectedMarkerId:r,zoom:n,collisionThresholdPx:s,dotCollisionThresholdPx:i}){if(!e.length)return[];if(!t)return e.map(o=>({kind:"primary",marker:o,key:`primary-${o.tripadvisor_id}`}));let p=e.map((o,d)=>{let l=o.location;if(typeof(l==null?void 0:l.lon)!="number"||typeof(l==null?void 0:l.lat)!="number")return null;let{x:u,y:v}=t.project([l.lon,l.lat]);return{marker:o,index:d,x:u,y:v}}).filter(o=>!!o);if(!p.length)return[];let m=O(n),y=R(n),h=p.map((o,d)=>d),b=o=>h[o]===o?o:(h[o]=b(h[o]),h[o]),D=(o,d)=>{let l=b(o),u=b(d);l!==u&&(h[u]=l)};for(let o=0;o<p.length;o+=1)for(let d=o+1;d<p.length;d+=1){let l=p[o].x-p[d].x,u=p[o].y-p[d].y;Math.hypot(l,u)<=m&&D(o,d)}let I=new Map;for(let o of p){let d=b(o.index),l=I.get(d);l?l.push(o):I.set(d,[o])}let f=[];return I.forEach(o=>{if(o.length===1){let[{marker:c}]=o;f.push({kind:"primary",marker:c,key:`primary-${c.tripadvisor_id}`});return}let d=[...o].sort((c,E)=>Z(E.marker,c.marker,a)),[l,...u]=d;if(f.push({kind:"primary",marker:l.marker,key:`primary-${l.marker.tripadvisor_id}`}),!u.length)return;let v=[],w=[];if(u.forEach(c=>{if(r&&c.marker.tripadvisor_id===r){f.push({kind:"primary",marker:c.marker,key:`primary-${c.marker.tripadvisor_id}`});return}j(l,c)<=y?v.push(c):w.push(c)}),v.forEach(c=>{f.push({kind:"dot",marker:c.marker,key:`dot-${c.marker.tripadvisor_id}`,parentId:l.marker.tripadvisor_id})}),w.length){let c=S({markers:w.map(E=>E.marker),map:t,selectedMarkerId:r,zoom:n,primaryType:a,collisionThresholdPx:s,dotCollisionThresholdPx:i});f.push(...c)}}),f}function j(a,e){return Math.hypot(a.x-e.x,a.y-e.y)}function R(a){let e=O(a);return Math.max(48,e)}function Z(a,e,t){var m,y;let r=a.type===t,n=e.type===t;if(r&&!n)return 1;if(!r&&n)return-1;let s=A(a)-A(e);if(s!==0)return s;let i=N(a)-N(e);if(i!==0)return i;let p=((m=a.reviews)!=null?m:0)-((y=e.reviews)!=null?y:0);return p!==0?p:a.tripadvisor_id-e.tripadvisor_id}function A(a){if(typeof a.rating=="number")return a.rating;if(a.rating===void 0||a.rating===null)return-1/0;let e=Number(a.rating);return Number.isNaN(e)?-1/0:e}function N(a){var t,r,n;if(!((r=(t=a.pricing)==null?void 0:t.offer)!=null&&r.price))return-1/0;let e=Number(((n=a.pricing.offer.displayPrice)!=null?n:"0").replace(/[^0-9.,-]+/g,"").replace(/,/g,""));return Number.isNaN(e)?-1/0:e}function $(a,e,t){let r=Math.cos(e*Math.PI/180)*2*Math.PI*6378137/(256*2**t);return!Number.isFinite(r)||r<=0?a:a/r}export{T as MapFirstCore};
//# sourceMappingURL=index.mjs.map