function z(n,{insertAt:e}={}){if(!n||typeof document=="undefined")return;let r=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style");t.type="text/css",e==="top"&&r.firstChild?r.insertBefore(t,r.firstChild):r.appendChild(t),t.styleSheet?t.styleSheet.cssText=n:t.appendChild(document.createTextNode(n))}z(`.mapfirst-marker-root{display:flex;z-index:20;flex-direction:column;align-items:center;pointer-events:auto}.mapfirst-marker-pill{border:2px solid;border-radius:999px;padding:8px;font-size:16px;font-weight:600;font-family:system-ui,-apple-system,sans-serif;box-shadow:0 4px 6px #6b728080;display:flex;align-items:center;justify-content:center;position:relative;transition:transform .2s;transform-origin:center bottom}.mapfirst-marker-pill-pending{background:#ffffff80;backdrop-filter:blur(4px);border-color:transparent;cursor:default}.mapfirst-marker-pill-active{background:#012b11;border-color:#fff;color:#fff;cursor:pointer}.mapfirst-marker-pill-active.mapfirst-marker-non-primary{background:#ffffffb3;border-color:#03852e80;color:#03852e80;padding:4px}.mapfirst-marker-pill-active.mapfirst-marker-selected{background:#fff;border-color:#03852e;color:#03852e;transform:scale(1.2)}.mapfirst-marker-pill-active:hover{transform:scale(1.2)}.mapfirst-marker-badge{position:absolute;top:-12px;right:-20px}.mapfirst-marker-award-container{position:relative;width:32px;height:32px}.mapfirst-marker-award-back{position:absolute;stroke:#f5f5f5;stroke-width:2px}.mapfirst-marker-award-dot{position:absolute;top:6.2px;left:6.3px;width:18.5px;height:18.5px;border-radius:50%;z-index:1}.mapfirst-marker-award-dot-type-0{background:#ffef0e}.mapfirst-marker-award-dot-type-1{background:#01ea5b}.mapfirst-marker-award-front{position:relative;z-index:2;color:#012b11}.mapfirst-marker-rating-badge{display:flex;align-items:center;justify-content:center;border-radius:999px;background:#03852e;color:#fff;font-size:12px;line-height:1;box-shadow:0 2px 4px #0003;padding:2px 6px;border:2px solid #ffffff;font-weight:400}.mapfirst-marker-content{display:flex;align-items:center}.mapfirst-dot-marker-container{display:flex;z-index:10;align-items:center;justify-content:center;pointer-events:auto}.mapfirst-dot-marker-button{width:20px;height:20px;border-radius:999px;border:2px solid #ffffff;box-shadow:0 2px 4px #6b728066;transition:transform .2s;outline:none;transform-origin:center center}.mapfirst-dot-marker-button-pending{background:#d1d5db;cursor:default}.mapfirst-dot-marker-button-active{background:#012b11;cursor:pointer}.mapfirst-dot-marker-button-active.mapfirst-dot-marker-non-primary{background:#ffffffb3;border-color:#03852e33}.mapfirst-dot-marker-button-active.mapfirst-dot-marker-selected{background:#fff;border-color:#03852e}.mapfirst-dot-marker-button-active:hover{transform:scale(1.2)}.mapfirst-dot-marker-button-active:focus{outline:2px solid #ffffff;outline-offset:2px}
`);function P(n,e,r,t){var f,g,k;if(typeof document=="undefined")return null;let a=n.marker,i=a.type===e,s=r===a.tripadvisor_id,l=a.type==="Accommodation"&&((g=(f=a.pricing)==null?void 0:f.offer)==null?void 0:g.availability)!=="available",m=document.createElement("div");m.className="mapfirst-dot-marker-container",m.style.zIndex=s?"20":i?"3":"1";let h=document.createElement("button");return h.type="button",h.className=l?"mapfirst-dot-marker-button mapfirst-dot-marker-button-pending":`mapfirst-dot-marker-button mapfirst-dot-marker-button-active${s?" mapfirst-dot-marker-selected":i?"":" mapfirst-dot-marker-non-primary"}`,h.title=(k=a.name)!=null?k:String(a.tripadvisor_id),h.addEventListener("click",M=>{M.stopPropagation(),l||t==null||t(a)}),m.appendChild(h),m}var Z='<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014"></path><path d="M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827"></path></svg>',q='<svg viewBox="0 0 24 24" width="32" height="32"><path d="M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014"></path><path d="M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827"></path></svg>',K='<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.051 6.549v.003l1.134 1.14 3.241-3.25.003-.002 1.134 1.136-3.243 3.252 1.134 1.14a1 1 0 0 0 .09-.008c.293-.05.573-.324.72-.474l.005-.006 2.596-2.603L22 8.016l-2.597 2.604a3.73 3.73 0 0 1-1.982 1.015 4.3 4.3 0 0 1-3.162-.657l-.023-.016-.026-.018-1.366 1.407 8.509 8.512L20.219 22l-.002-.002-6.654-6.663-2.597 2.76-7.3-7.315C1.967 8.948 1.531 6.274 2.524 4.198c.241-.504.566-.973.978-1.386l8.154 8.416 1.418-1.423-.039-.045c-.858-1.002-1.048-2.368-.62-3.595a4.15 4.15 0 0 1 .983-1.561L16 2l1.135 1.138-2.598 2.602-.047.045c-.16.151-.394.374-.433.678zM3.809 5.523c-.362 1.319-.037 2.905 1.06 4.103L10.93 15.7l1.408-1.496zM2.205 20.697 3.34 21.84l4.543-4.552-1.135-1.143z"/></svg>',W='<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.56 7.5H3.75a.25.25 0 0 0-.25.25v10c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25v-10a.25.25 0 0 0-.25-.25h-3.81l-2-2H9.56zM8.94 4h6.12l2 2h3.19c.966 0 1.75.784 1.75 1.75v10a1.75 1.75 0 0 1-1.75 1.75H3.75A1.75 1.75 0 0 1 2 17.75v-10C2 6.784 2.784 6 3.75 6h3.19z"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 9.25a2.75 2.75 0 1 0 0 5.5 2.75 2.75 0 0 0 0-5.5M7.75 12a4.25 4.25 0 1 1 8.5 0 4.25 4.25 0 0 1-8.5 0"/></svg>';function L(n,e,r,t){var M,p,u,c,v,C,N,I;if(typeof document=="undefined")return null;let a=n.marker,i=a.type===e,s=r===a.tripadvisor_id,o=a.type==="Accommodation",l=(p=(M=a.pricing)==null?void 0:M.offer)==null?void 0:p.displayPrice,m=o&&!l,h=(()=>{if(a.rating===void 0||a.rating===null)return null;let y=typeof a.rating=="number"?a.rating:Number(a.rating);return Number.isNaN(y)||y<=0?null:y.toFixed(1)})(),f=document.createElement("div");f.className="mapfirst-marker-root",f.style.zIndex=s?"20":i?"12":"11";let g=document.createElement("button");if(g.type="button",g.className=m?"mapfirst-marker-pill mapfirst-marker-pill-pending":`mapfirst-marker-pill mapfirst-marker-pill-active${s?" mapfirst-marker-selected":i?"":" mapfirst-marker-non-primary"}`,g.title=(u=a.name)!=null?u:String(a.tripadvisor_id),!m&&((c=a.awards)!=null&&c.length||h)){let y=document.createElement("div");if(y.className="mapfirst-marker-badge",i||(y.style.opacity="0.2"),y.className="mapfirst-marker-badge",(v=a.awards)!=null&&v.length&&a.awards[0].type){let d=document.createElement("div");d.className="mapfirst-marker-award-container";let b=document.createElement("div");b.className="mapfirst-marker-award-back",b.innerHTML=q;let S=document.createElement("div");S.className=`mapfirst-marker-award-dot mapfirst-marker-award-dot-type-${a.awards[0].type}`;let D=document.createElement("div");D.className="mapfirst-marker-award-front",D.innerHTML=Z,d.appendChild(b),d.appendChild(S),d.appendChild(D),y.appendChild(d)}else h&&(y.className="mapfirst-marker-badge mapfirst-marker-rating-badge",y.textContent=h);g.appendChild(y)}let k=document.createElement("span");return k.className="mapfirst-marker-content",o?k.textContent=(I=(N=(C=a.pricing)==null?void 0:C.offer)==null?void 0:N.displayPrice)!=null?I:"\u2014":a.type==="Eat & Drink"?k.innerHTML=K:a.type==="Attraction"&&(k.innerHTML=W),g.appendChild(k),g.addEventListener("click",y=>{y.stopPropagation(),m||t==null||t(a)}),f.appendChild(g),f}var A=class{constructor(e){this.markerCache=new Map;this.primaryType="Accommodation";this.selectedMarkerId=null;var r;this.mapInstance=e.mapInstance,this.MarkerCtor=(r=e.maplibregl)==null?void 0:r.Marker,this.onMarkerClick=e.onMarkerClick}render(e,r,t){if(r&&r!==this.primaryType&&(this.primaryType=r),t!==void 0&&(this.selectedMarkerId=t),!this.MarkerCtor)return;let a=new Set(e.map(i=>i.key));for(let[i,s]of this.markerCache.entries())if(!a.has(i)){try{s.marker.remove()}catch{}this.markerCache.delete(i)}for(let i of e){let s=Y(i.marker.location);if(!s)continue;let o=this.markerCache.get(i.key);if(o)try{o.marker.setLngLat([s.lon,s.lat])}catch{try{o.marker.remove()}catch{}this.markerCache.delete(i.key),this.createAndAddMarker(i,s)}else this.createAndAddMarker(i,s)}}destroy(){for(let e of this.markerCache.values())try{e.marker.remove()}catch{}this.markerCache.clear()}createAndAddMarker(e,r){if(!this.MarkerCtor)return;let t=e.kind==="primary"?L(e,this.primaryType,this.selectedMarkerId,this.onMarkerClick):P(e,this.primaryType,this.selectedMarkerId,this.onMarkerClick);if(t)try{let a=new this.MarkerCtor({element:t,anchor:e.kind==="primary"?"bottom":"center"}).setLngLat([r.lon,r.lat]).addTo(this.mapInstance);this.markerCache.set(e.key,{key:e.key,marker:a,kind:e.kind,parentId:e.kind==="dot"?e.parentId:void 0})}catch{}}};function Y(n){return typeof(n==null?void 0:n.lon)!="number"||typeof(n==null?void 0:n.lat)!="number"||Number.isNaN(n.lon)||Number.isNaN(n.lat)?null:{lon:n.lon,lat:n.lat}}var T=class{constructor(e){this.markerCache=new Map;this.primaryType="Accommodation";this.selectedMarkerId=null;this.mapInstance=e.mapInstance,this.google=e.google,this.onMarkerClick=e.onMarkerClick}render(e,r,t){var i,s;if(r&&r!==this.primaryType&&(this.primaryType=r),t!==void 0&&(this.selectedMarkerId=t),!((s=(i=this.google)==null?void 0:i.marker)!=null&&s.AdvancedMarkerElement)){console.warn("AdvancedMarkerElement not available");return}let a=new Set(e.map(o=>o.key));for(let[o,l]of this.markerCache.entries())if(!a.has(o)){try{l.marker.map=null}catch(m){console.error("Error removing marker",m)}this.markerCache.delete(o)}for(let o of e){let l=J(o.marker.location);if(!l)continue;let m=this.markerCache.get(o.key);if(m)try{m.marker.position={lat:l.lat,lng:l.lon}}catch{try{m.marker.map=null}catch(h){console.error("Error removing marker",h)}this.markerCache.delete(o.key),this.createAndAddMarker(o,l)}else this.createAndAddMarker(o,l)}}destroy(){for(let e of this.markerCache.values())try{e.marker.map=null}catch(r){console.error("Error removing marker",r)}this.markerCache.clear()}createAndAddMarker(e,r){var o,l;if(!((l=(o=this.google)==null?void 0:o.marker)!=null&&l.AdvancedMarkerElement))return;let t=e.kind==="primary"?L(e,this.primaryType,this.selectedMarkerId,this.onMarkerClick):P(e,this.primaryType,this.selectedMarkerId,this.onMarkerClick);if(!t)return;let a=e.marker.type===this.primaryType,i=this.selectedMarkerId===e.marker.tripadvisor_id,s=e.kind==="primary"?i?20:a?12:11:i?20:a?3:1;try{let m=new this.google.marker.AdvancedMarkerElement({map:this.mapInstance,position:{lat:r.lat,lng:r.lon},content:t,zIndex:s});this.markerCache.set(e.key,{key:e.key,marker:m,kind:e.kind,parentId:e.kind==="dot"?e.parentId:void 0})}catch(m){console.error("Error creating marker",m)}}};function J(n){return typeof(n==null?void 0:n.lon)!="number"||typeof(n==null?void 0:n.lat)!="number"||Number.isNaN(n.lon)||Number.isNaN(n.lat)?null:{lon:n.lon,lat:n.lat}}var w=class{constructor(e){this.markerCache=new Map;this.primaryType="Accommodation";this.selectedMarkerId=null;var r;this.mapInstance=e.mapInstance,this.MarkerCtor=(r=e.mapboxgl)==null?void 0:r.Marker,this.onMarkerClick=e.onMarkerClick}render(e,r,t){if(r&&r!==this.primaryType&&(this.primaryType=r),t!==void 0&&(this.selectedMarkerId=t),!this.MarkerCtor)return;let a=new Set(e.map(i=>i.key));for(let[i,s]of this.markerCache.entries())if(!a.has(i)){try{s.marker.remove()}catch{}this.markerCache.delete(i)}for(let i of e){let s=X(i.marker.location);if(!s)continue;let o=this.markerCache.get(i.key);if(o)try{o.marker.setLngLat([s.lon,s.lat])}catch{try{o.marker.remove()}catch{}this.markerCache.delete(i.key),this.createAndAddMarker(i,s)}else this.createAndAddMarker(i,s)}}destroy(){for(let e of this.markerCache.values())try{e.marker.remove()}catch{}this.markerCache.clear()}createAndAddMarker(e,r){if(!this.MarkerCtor)return;let t=e.kind==="primary"?L(e,this.primaryType,this.selectedMarkerId,this.onMarkerClick):P(e,this.primaryType,this.selectedMarkerId,this.onMarkerClick);if(t)try{let a=new this.MarkerCtor({element:t,anchor:e.kind==="primary"?"bottom":"center"}).setLngLat([r.lon,r.lat]).addTo(this.mapInstance);this.markerCache.set(e.key,{key:e.key,marker:a,kind:e.kind,parentId:e.kind==="dot"?e.parentId:void 0})}catch{}}};function X(n){return typeof(n==null?void 0:n.lon)!="number"||typeof(n==null?void 0:n.lat)!="number"||Number.isNaN(n.lon)||Number.isNaN(n.lat)?null:{lon:n.lon,lat:n.lat}}var x=class{constructor(e){this.map=e}getMap(){return this.map}};var E=class extends x{constructor(r){super(r);this.cleanupFns=[]}initialize(r){return this.markerManager=new A({mapInstance:this.map,maplibregl:r.maplibregl,onMarkerClick:r.onMarkerClick}),r.onRefresh&&this.attachEventListeners(r.onRefresh),this.markerManager}attachEventListeners(r){if(!this.map||typeof this.map.on!="function")return;["move","zoom","dragend","pitch","rotate"].forEach(a=>{this.map.on(a,r),this.cleanupFns.push(()=>{typeof this.map.off=="function"&&this.map.off(a,r)})})}getMarkerManager(){return this.markerManager}cleanup(){for(let r of this.cleanupFns)try{r()}catch{}this.cleanupFns.length=0}getMap(){return this.map}getCenter(){let r=this.map.getCenter();return{lng:r.lng,lat:r.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let r=this.map.getBounds(),t=r.getSouthWest(),a=r.getNorthEast();return{sw:{lat:t.lat,lng:t.lng},ne:{lat:a.lat,lng:a.lng}}}project(r){return this.map.project({lng:r[0],lat:r[1]})}on(r,t){this.map.on(r,t)}off(r,t){this.map.off(r,t)}resize(){this.map.resize()}remove(){this.cleanup(),this.map.remove()}};var B=class extends x{constructor(r){super(r);this.cleanupFns=[];this.initializeOverlayView()}initialize(r){return this.markerManager=new T({mapInstance:this.map,google:r.google,onMarkerClick:r.onMarkerClick}),r.onRefresh&&this.attachEventListeners(r.onRefresh),this.markerManager}attachEventListeners(r){let t=["center_changed","zoom_changed","drag","heading_changed","tilt_changed"],a=[];t.forEach(i=>{let s=this.map.addListener(i,r);a.push(s)}),this.cleanupFns.push(()=>{a.forEach(i=>{try{i.remove()}catch{}})})}getMarkerManager(){return this.markerManager}cleanup(){for(let r of this.cleanupFns)try{r()}catch{}this.cleanupFns.length=0}initializeOverlayView(){var a;let r=(a=globalThis.google)==null?void 0:a.maps;if(!r)return;let t=r.OverlayView;t&&(this.overlayView=new t,this.overlayView.draw=function(){},this.overlayView.setMap(this.map))}getMap(){return this.map}getCenter(){let r=this.map.getCenter();return r?{lng:r.lng(),lat:r.lat()}:{lng:0,lat:0}}getZoom(){var r;return(r=this.map.getZoom())!=null?r:0}getBearing(){var r;return(r=this.map.getHeading())!=null?r:0}getPitch(){var r;return(r=this.map.getTilt())!=null?r:0}getMapBounds(){let r=this.map.getBounds();if(!r)return{sw:{lat:0,lng:0},ne:{lat:0,lng:0}};let t=r.getSouthWest(),a=r.getNorthEast();return{sw:{lat:t.lat(),lng:t.lng()},ne:{lat:a.lat(),lng:a.lng()}}}project(r){var o;if(!this.overlayView)return{x:0,y:0};let t=this.overlayView.getProjection();if(!t)return{x:0,y:0};let a=(o=globalThis.google)==null?void 0:o.maps;if(!a)return{x:0,y:0};let i=new a.LatLng(r[1],r[0]),s=t.fromLatLngToContainerPixel(i);return s?{x:s.x,y:s.y}:{x:0,y:0}}on(r,t){this.map.addListener(r,t)}off(r,t){var i;let a=(i=globalThis.google)==null?void 0:i.maps;a!=null&&a.event&&a.event.clearListeners(this.map,r)}resize(){var t;let r=(t=globalThis.google)==null?void 0:t.maps;r!=null&&r.event&&r.event.trigger(this.map,"resize")}remove(){this.cleanup(),this.overlayView&&(this.overlayView.setMap(null),this.overlayView=null)}};var O=class extends x{constructor(r){super(r);this.cleanupFns=[]}initialize(r){return this.markerManager=new w({mapInstance:this.map,mapboxgl:r.mapboxgl,onMarkerClick:r.onMarkerClick}),r.onRefresh&&this.attachEventListeners(r.onRefresh),this.markerManager}attachEventListeners(r){if(!this.map||typeof this.map.on!="function")return;["move","zoom","dragend","pitch","rotate"].forEach(a=>{this.map.on(a,r),this.cleanupFns.push(()=>{typeof this.map.off=="function"&&this.map.off(a,r)})})}getMarkerManager(){return this.markerManager}cleanup(){for(let r of this.cleanupFns)try{r()}catch{}this.cleanupFns.length=0}getMap(){return this.map}getCenter(){let r=this.map.getCenter();return{lng:r.lng,lat:r.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let r=this.map.getBounds(),t=r.getSouthWest(),a=r.getNorthEast();return{sw:{lat:t.lat,lng:t.lng},ne:{lat:a.lat,lng:a.lng}}}project(r){return this.map.project({lng:r[0],lat:r[1]})}on(r,t){this.map.on(r,t)}off(r,t){this.map.off(r,t)}resize(){this.map.resize()}remove(){this.cleanup(),this.map.remove()}};function j(n){let e=n.getCenter();return{longitude:e.lng,latitude:e.lat,zoom:n.getZoom(),bearing:n.getBearing(),pitch:n.getPitch()}}var Q=[{zoom:6,threshold:120},{zoom:8,threshold:108},{zoom:10,threshold:92},{zoom:12,threshold:80},{zoom:14,threshold:68},{zoom:16,threshold:56}];function V(n){for(let e of Q)if(n<=e.zoom)return e.threshold;return 48}function F({primaryType:n,markers:e,map:r,selectedMarkerId:t,zoom:a,collisionThresholdPx:i,dotCollisionThresholdPx:s}){if(!e.length)return[];if(!r)return e.map(p=>({kind:"primary",marker:p,key:`primary-${p.tripadvisor_id}`}));let o=e.map((p,u)=>{let c=p.location;if(typeof(c==null?void 0:c.lon)!="number"||typeof(c==null?void 0:c.lat)!="number")return null;let{x:v,y:C}=r.project([c.lon,c.lat]);return{marker:p,index:u,x:v,y:C}}).filter(p=>!!p);if(!o.length)return[];let l=V(a),m=re(a),h=o.map((p,u)=>u),f=p=>h[p]===p?p:(h[p]=f(h[p]),h[p]),g=(p,u)=>{let c=f(p),v=f(u);c!==v&&(h[v]=c)};for(let p=0;p<o.length;p+=1)for(let u=p+1;u<o.length;u+=1){let c=o[p].x-o[u].x,v=o[p].y-o[u].y;Math.hypot(c,v)<=l&&g(p,u)}let k=new Map;for(let p of o){let u=f(p.index),c=k.get(u);c?c.push(p):k.set(u,[p])}let M=[];return k.forEach(p=>{if(p.length===1){let[{marker:d}]=p,b=d.type===n,S=t===d.tripadvisor_id;M.push({kind:"primary",marker:d,key:`primary-${d.tripadvisor_id}-p${b?1:0}-s${S?1:0}`});return}let u=[...p].sort((d,b)=>te(b.marker,d.marker,n)),[c,...v]=u,C=c.marker.type===n,N=t===c.marker.tripadvisor_id;if(M.push({kind:"primary",marker:c.marker,key:`primary-${c.marker.tripadvisor_id}-p${C?1:0}-s${N?1:0}`}),!v.length)return;let I=[],y=[];if(v.forEach(d=>{if(t&&d.marker.tripadvisor_id===t){let b=d.marker.type===n;M.push({kind:"primary",marker:d.marker,key:`primary-${d.marker.tripadvisor_id}-p${b?1:0}-s1`});return}ee(c,d)<=m?I.push(d):y.push(d)}),I.forEach(d=>{let b=d.marker.type===n;M.push({kind:"dot",marker:d.marker,key:`dot-${d.marker.tripadvisor_id}-p${b?1:0}-s0`,parentId:c.marker.tripadvisor_id})}),y.length){let d=F({markers:y.map(b=>b.marker),map:r,selectedMarkerId:t,zoom:a,primaryType:n,collisionThresholdPx:i,dotCollisionThresholdPx:s});M.push(...d)}}),M}function ee(n,e){return Math.hypot(n.x-e.x,n.y-e.y)}function re(n){let e=V(n);return Math.max(48,e)}function te(n,e,r){var l,m;let t=n.type===r,a=e.type===r;if(t&&!a)return 1;if(!t&&a)return-1;let i=H(n)-H(e);if(i!==0)return i;let s=R(n)-R(e);if(s!==0)return s;let o=((l=n.reviews)!=null?l:0)-((m=e.reviews)!=null?m:0);return o!==0?o:n.tripadvisor_id-e.tripadvisor_id}function H(n){if(typeof n.rating=="number")return n.rating;if(n.rating===void 0||n.rating===null)return-1/0;let e=Number(n.rating);return Number.isNaN(e)?-1/0:e}function R(n){var r,t,a;if(!((t=(r=n.pricing)==null?void 0:r.offer)!=null&&t.price))return-1/0;let e=Number(((a=n.pricing.offer.displayPrice)!=null?a:"0").replace(/[^0-9.,-]+/g,"").replace(/,/g,""));return Number.isNaN(e)?-1/0:e}var ae={prod:"https://api.mapfirst.ai",test:"https://ta-backend-test-290791666935.us-central1.run.app"},_=class extends Error{constructor({message:e,status:r,code:t}){super(e),this.name="PropertiesFetchError",this.status=r,this.code=t}};async function ne(n,e,{signal:r}={}){var a,i;let t=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:r});if(!t.ok){let s=`Unexpected response: ${t.status}`,o;try{let l=await t.json();s=(i=(a=l.detail)!=null?a:l.error)!=null?i:s,o=l.code}catch{}throw new _({message:s,status:t.status,code:o})}return await t.json()}function G(n){return typeof n=="string"?n:n.toISOString().slice(0,10)}var $="Accommodation";function ie(){let e=new Date(Date.now()+864e6),r=(6-e.getDay()+7)%7,t=new Date(e.getTime()+r*864e5),a=t.getDay(),i=a===0?6:6-a,s=new Date(t.getTime()+(i+1)*864e5);return{checkIn:t,checkOut:s}}var U=class{constructor(e){this.options=e;this.properties=[];this.selectedMarkerId=null;this.destroyed=!1;this.clusterItems=[];var t,a,i,s,o,l;this.properties=[...(t=e.properties)!=null?t:[]],this.primaryType=e.primaryType,this.selectedMarkerId=(a=e.selectedMarkerId)!=null?a:null,this.environment=(i=e.environment)!=null?i:"prod",this.apiUrl=ae[this.environment],this.mfid=(s=e.mfid)!=null?s:"default",this.requestBody=e.requestBody;let r=ie();this.state={center:[0,0],zoom:0,bounds:null,pendingBounds:null,tempBounds:null,properties:this.properties,primary:(o=this.primaryType)!=null?o:$,selectedPropertyId:this.selectedMarkerId,initialLoading:!0,isSearching:!1,firstCallDone:!1,filters:{checkIn:r.checkIn,checkOut:r.checkOut,numAdults:2,numRooms:1},activeLocation:{country:"",location_id:null,locationName:"",coordinates:[0,0]},isFlyToAnimating:!1,...e.state},this.callbacks=(l=e.callbacks)!=null?l:{},this.adapter=this.createAdapter(e),this.refresh(),this.requestBody&&this.autoLoadProperties()}async autoLoadProperties(){if(!this.requestBody)return;let e={filters:this.getFilters(),initial:!0,...this.requestBody};await this.loadProperties({fetchFn:async()=>(await ne(`${this.apiUrl}/${this.mfid}/hotels`,e)).properties||[],onError:r=>{var t,a;console.error("Failed to load properties:",r),(a=(t=this.callbacks).onPropertiesLoadError)==null||a.call(t,r)}})}createAdapter(e){return se(e)?this.initializeAdapter(new E(e.mapInstance),{maplibregl:e.maplibregl,onMarkerClick:e.onMarkerClick}):oe(e)?this.initializeAdapter(new B(e.mapInstance),{google:e.google,onMarkerClick:e.onMarkerClick}):pe(e)?this.initializeAdapter(new O(e.mapInstance),{mapboxgl:e.mapboxgl,onMarkerClick:e.onMarkerClick}):e.adapter}initializeAdapter(e,r){var a;let t=(a=this.options.autoSelectOnClick)!=null?a:!0;return e.initialize({...r,onMarkerClick:i=>{var s;i.type!==this.primaryType&&this.setPrimaryType(i.type),t&&this.setSelectedMarker(i.tripadvisor_id),(s=r.onMarkerClick)==null||s.call(r,i)},onRefresh:()=>this.refresh()}),e}setMarkers(e){var r,t;this.ensureAlive(),this.properties=[...e],this.updateState({properties:e}),(t=(r=this.callbacks).onPropertiesChange)==null||t.call(r,e),this.refresh()}addMarker(e){var r,t;this.ensureAlive(),this.properties=[...this.properties,e],this.updateState({properties:this.properties}),(t=(r=this.callbacks).onPropertiesChange)==null||t.call(r,this.properties),this.refresh()}clearMarkers(){var e,r;this.ensureAlive(),this.properties=[],this.updateState({properties:[]}),(r=(e=this.callbacks).onPropertiesChange)==null||r.call(e,[]),this.refresh()}setPrimaryType(e){var r,t;this.ensureAlive(),this.primaryType!==e&&(this.primaryType=e,this.updateState({primary:e}),(t=(r=this.callbacks).onPrimaryTypeChange)==null||t.call(r,e),this.refresh())}setSelectedMarker(e){var r,t;this.ensureAlive(),this.selectedMarkerId!==e&&(this.selectedMarkerId=e,this.updateState({selectedPropertyId:e}),(t=(r=this.callbacks).onSelectedPropertyChange)==null||t.call(r,e),this.refresh())}getState(){return{...this.state}}updateState(e){this.state={...this.state,...e}}setState(e){var t,a,i,s,o,l,m,h,f,g,k,M,p,u;let r={...this.state};this.updateState(e),e.center!==void 0&&e.center!==r.center&&((a=(t=this.callbacks).onCenterChange)==null||a.call(t,e.center,this.state.zoom)),e.zoom!==void 0&&e.zoom!==r.zoom&&((s=(i=this.callbacks).onZoomChange)==null||s.call(i,e.zoom)),e.bounds!==void 0&&e.bounds!==r.bounds&&((l=(o=this.callbacks).onBoundsChange)==null||l.call(o,e.bounds)),e.filters!==void 0&&e.filters!==r.filters&&((h=(m=this.callbacks).onFiltersChange)==null||h.call(m,e.filters)),e.activeLocation!==void 0&&e.activeLocation!==r.activeLocation&&((g=(f=this.callbacks).onActiveLocationChange)==null||g.call(f,e.activeLocation)),e.initialLoading!==void 0&&e.initialLoading!==r.initialLoading&&((M=(k=this.callbacks).onLoadingStateChange)==null||M.call(k,e.initialLoading)),e.isSearching!==void 0&&e.isSearching!==r.isSearching&&((u=(p=this.callbacks).onSearchingStateChange)==null||u.call(p,e.isSearching))}setFilters(e){this.setState({filters:e})}setActiveLocation(e){this.setState({activeLocation:e})}setBounds(e){this.setState({bounds:e})}setPendingBounds(e){this.setState({pendingBounds:e})}setTempBounds(e){this.setState({tempBounds:e})}setLoading(e){this.setState({initialLoading:e})}setSearching(e){this.setState({isSearching:e})}setFlyToAnimating(e){this.setState({isFlyToAnimating:e})}getFilters(){let e={...this.state.filters};return e.checkIn instanceof Date&&(e.checkIn=G(e.checkIn)),e.checkOut instanceof Date&&(e.checkOut=G(e.checkOut)),e}async loadProperties({fetchFn:e,onSuccess:r,onError:t}){this.ensureAlive(),this.setLoading(!0),this.setSearching(!0),this.clearMarkers();try{let a=await e();if(this.setMarkers(a),!this.primaryType&&a.length>0){let i=a.reduce((o,l)=>(o[l.type]=(o[l.type]||0)+1,o),{}),s=Object.entries(i).reduce((o,l)=>i[o[0]]>i[l[0]]?o:l)[0];this.setPrimaryType(s)}this.setState({firstCallDone:!0}),r==null||r(a)}catch(a){this.clearMarkers(),t==null||t(a)}finally{this.setSearching(!1),this.setLoading(!1),this.setState({firstCallDone:!0})}}getClusters(){return this.ensureAlive(),[...this.clusterItems]}refresh(){var a,i,s;this.ensureAlive();let e=this.safeExtractViewState(),r=this.resolvePrimaryType();this.clusterItems=F({primaryType:r,markers:this.properties,map:this.adapter,selectedMarkerId:this.selectedMarkerId,zoom:(a=e==null?void 0:e.zoom)!=null?a:0}),this.adapter.getMarkerManager().render(this.clusterItems,r,this.selectedMarkerId),(s=(i=this.options).onClusterUpdate)==null||s.call(i,this.clusterItems,e)}destroy(){if(this.destroyed)return;this.adapter.getMarkerManager().destroy(),this.adapter.cleanup(),this.clusterItems=[],this.properties=[],this.destroyed=!0}resolvePrimaryType(){var e,r,t;return(t=(r=this.primaryType)!=null?r:(e=this.properties.find(a=>a.type))==null?void 0:e.type)!=null?t:$}safeExtractViewState(){try{return j(this.adapter)}catch{return null}}ensureAlive(){if(this.destroyed)throw new Error("MapFirstCore instance has been destroyed")}};function se(n){return n.platform==="maplibre"}function oe(n){return n.platform==="google"}function pe(n){return n.platform==="mapbox"}export{U as MapFirstCore,_ as PropertiesFetchError,ne as fetchProperties};
//# sourceMappingURL=index.mjs.map