function O(s,{insertAt:e}={}){if(!s||typeof document=="undefined")return;let t=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",e==="top"&&t.firstChild?t.insertBefore(r,t.firstChild):t.appendChild(r),r.styleSheet?r.styleSheet.cssText=s:r.appendChild(document.createTextNode(s))}O(`.mapfirst-marker-root{display:flex;z-index:20;flex-direction:column;align-items:center;pointer-events:auto}.mapfirst-marker-pill{border:2px solid;border-radius:999px;padding:8px;font-size:16px;font-weight:600;font-family:system-ui,-apple-system,sans-serif;box-shadow:0 4px 6px #6b728080;display:flex;align-items:center;justify-content:center;position:relative;transition:transform .2s;transform-origin:center bottom}.mapfirst-marker-pill-pending{background:#ffffff80;backdrop-filter:blur(4px);border-color:transparent;cursor:default}.mapfirst-marker-pill-active{background:#012b11;border-color:#fff;color:#fff;cursor:pointer}.mapfirst-marker-pill-active.mapfirst-marker-non-primary{background:#ffffffb3;border-color:#03852e80;color:#03852e80;padding:4px}.mapfirst-marker-pill-active.mapfirst-marker-selected{background:#fff;border-color:#03852e;color:#03852e;transform:scale(1.2)}.mapfirst-marker-pill-active:hover{transform:scale(1.2)}.mapfirst-marker-badge{position:absolute;top:-12px;right:-20px}.mapfirst-marker-award-container{position:relative;width:32px;height:32px}.mapfirst-marker-award-back{position:absolute;stroke:#f5f5f5;stroke-width:2px}.mapfirst-marker-award-dot{position:absolute;top:6.2px;left:6.3px;width:18.5px;height:18.5px;border-radius:50%;z-index:1}.mapfirst-marker-award-dot-type-0{background:#ffef0e}.mapfirst-marker-award-dot-type-1{background:#01ea5b}.mapfirst-marker-award-front{position:relative;z-index:2;color:#012b11}.mapfirst-marker-rating-badge{display:flex;align-items:center;justify-content:center;border-radius:999px;background:#03852e;color:#fff;font-size:12px;line-height:1;box-shadow:0 2px 4px #0003;padding:2px 6px;border:2px solid #ffffff;font-weight:400}.mapfirst-marker-content{display:flex;align-items:center}.mapfirst-dot-marker-container{display:flex;z-index:10;align-items:center;justify-content:center;pointer-events:auto}.mapfirst-dot-marker-button{width:20px;height:20px;border-radius:999px;border:2px solid #ffffff;box-shadow:0 2px 4px #6b728066;transition:transform .2s;outline:none;transform-origin:center center}.mapfirst-dot-marker-button-pending{background:#d1d5db;cursor:default}.mapfirst-dot-marker-button-active{background:#012b11;cursor:pointer}.mapfirst-dot-marker-button-active.mapfirst-dot-marker-non-primary{background:#ffffffb3;border-color:#03852e33}.mapfirst-dot-marker-button-active.mapfirst-dot-marker-selected{background:#fff;border-color:#03852e}.mapfirst-dot-marker-button-active:hover{transform:scale(1.2)}.mapfirst-dot-marker-button-active:focus{outline:2px solid #ffffff;outline-offset:2px}
`);function $(s,e,t,r){var g,c,y;if(typeof document=="undefined")return null;let a=s.marker,i=a.type===e,o=t===a.tripadvisor_id,n=a.type==="Accommodation"&&((c=(g=a.pricing)==null?void 0:g.offer)==null?void 0:c.availability)!=="available",p=document.createElement("div");p.className="mapfirst-dot-marker-container",p.style.zIndex=o?"20":i?"3":"1";let f=document.createElement("div");return f.className=n?"mapfirst-dot-marker-button mapfirst-dot-marker-button-pending":`mapfirst-dot-marker-button mapfirst-dot-marker-button-active${o?" mapfirst-dot-marker-selected":i?"":" mapfirst-dot-marker-non-primary"}`,f.title=(y=a.name)!=null?y:String(a.tripadvisor_id),f.addEventListener("click",k=>{k.stopPropagation(),n||r==null||r(a)}),p.appendChild(f),p}var te='<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014"></path><path d="M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827"></path></svg>',re='<svg viewBox="0 0 24 24" width="32" height="32"><path d="M12 3.953a7.442 7.442 0 1 0 .001 14.884A7.442 7.442 0 0 0 12 3.953m0 14.05a6.61 6.61 0 1 1 0-13.218 6.61 6.61 0 0 1 0 13.219M10.343 11.9a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.821 0m5.134 0a.91.91 0 1 1-1.821 0 .91.91 0 0 1 1.82 0m.82-1.897.84-.913h-1.863A5.8 5.8 0 0 0 12 8.08a5.77 5.77 0 0 0-3.27 1.008H6.862l.84.913a2.567 2.567 0 1 0 3.475 3.78l.823.896.823-.895a2.568 2.568 0 1 0 3.474-3.78m-6.865 3.634a1.738 1.738 0 1 1 0-3.476 1.738 1.738 0 0 1 0 3.476M12 11.85c0-1.143-.832-2.124-1.929-2.543A5 5 0 0 1 12 8.92a5 5 0 0 1 1.928.386c-1.096.42-1.927 1.4-1.927 2.543m2.566 1.787a1.738 1.738 0 1 1 .001-3.476 1.738 1.738 0 0 1 0 3.476m-8.456 3.719s-.377-.946-1.396-1.903c-1.02-.957-2.303-1.132-2.303-1.132s.457 1.02 1.54 2.04c1.086 1.017 2.159.995 2.159.995m2.568 1.41s-.524-.511-1.479-.883-1.861-.191-1.861-.191.598.54 1.615.935c1.016.397 1.725.139 1.725.139m2.493.505s-.545-.224-1.357-.196-1.415.47-1.415.47.608.222 1.473.193 1.3-.467 1.3-.467m-6.186-4.203s-.175-1.008-.974-2.154c-.8-1.147-2.015-1.578-2.015-1.578s.238 1.098 1.089 2.319c.85 1.22 1.9 1.413 1.9 1.413m-1.003-3.071s.195-1.021-.134-2.393c-.328-1.371-1.294-2.21-1.294-2.21s-.17 1.128.18 2.589c.35 1.46 1.248 2.014 1.248 2.014"></path><path d="M17.887 17.355s.377-.946 1.396-1.903c1.02-.957 2.303-1.132 2.303-1.132s-.457 1.02-1.54 2.04c-1.086 1.017-2.159.995-2.159.995m-2.567 1.41s.524-.511 1.479-.883 1.861-.191 1.861-.191-.598.54-1.615.935c-1.016.397-1.725.139-1.725.139m-2.493.505s.545-.224 1.357-.196 1.415.47 1.415.47-.608.222-1.473.193-1.3-.467-1.3-.467m6.186-4.203s.175-1.008.974-2.154c.8-1.147 2.015-1.578 2.015-1.578s-.238 1.098-1.089 2.319c-.85 1.22-1.9 1.413-1.9 1.413m1.003-3.071s-.195-1.021.133-2.393c.33-1.371 1.293-2.21 1.293-2.21s.17 1.128-.18 2.589c-.349 1.46-1.246 2.014-1.246 2.014M12 20.047a.413.413 0 1 0 0-.827.413.413 0 0 0 0 .827"></path></svg>',ae='<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.051 6.549v.003l1.134 1.14 3.241-3.25.003-.002 1.134 1.136-3.243 3.252 1.134 1.14a1 1 0 0 0 .09-.008c.293-.05.573-.324.72-.474l.005-.006 2.596-2.603L22 8.016l-2.597 2.604a3.73 3.73 0 0 1-1.982 1.015 4.3 4.3 0 0 1-3.162-.657l-.023-.016-.026-.018-1.366 1.407 8.509 8.512L20.219 22l-.002-.002-6.654-6.663-2.597 2.76-7.3-7.315C1.967 8.948 1.531 6.274 2.524 4.198c.241-.504.566-.973.978-1.386l8.154 8.416 1.418-1.423-.039-.045c-.858-1.002-1.048-2.368-.62-3.595a4.15 4.15 0 0 1 .983-1.561L16 2l1.135 1.138-2.598 2.602-.047.045c-.16.151-.394.374-.433.678zM3.809 5.523c-.362 1.319-.037 2.905 1.06 4.103L10.93 15.7l1.408-1.496zM2.205 20.697 3.34 21.84l4.543-4.552-1.135-1.143z"/></svg>',ie='<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.56 7.5H3.75a.25.25 0 0 0-.25.25v10c0 .138.112.25.25.25h16.5a.25.25 0 0 0 .25-.25v-10a.25.25 0 0 0-.25-.25h-3.81l-2-2H9.56zM8.94 4h6.12l2 2h3.19c.966 0 1.75.784 1.75 1.75v10a1.75 1.75 0 0 1-1.75 1.75H3.75A1.75 1.75 0 0 1 2 17.75v-10C2 6.784 2.784 6 3.75 6h3.19z"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 9.25a2.75 2.75 0 1 0 0 5.5 2.75 2.75 0 0 0 0-5.5M7.75 12a4.25 4.25 0 1 1 8.5 0 4.25 4.25 0 0 1-8.5 0"/></svg>';function j(s,e,t,r){var k,d,u,h,l,M,L,x;if(typeof document=="undefined")return null;let a=s.marker,i=a.type===e,o=t===a.tripadvisor_id,m=a.type==="Accommodation",n=(d=(k=a.pricing)==null?void 0:k.offer)==null?void 0:d.displayPrice,p=m&&!n,f=(()=>{if(a.rating===void 0||a.rating===null)return null;let b=typeof a.rating=="number"?a.rating:Number(a.rating);return Number.isNaN(b)||b<=0?null:b.toFixed(1)})(),g=document.createElement("div");g.className="mapfirst-marker-root",g.style.zIndex=o?"20":i?"12":"11";let c=document.createElement("div");if(c.className=p?"mapfirst-marker-pill mapfirst-marker-pill-pending":`mapfirst-marker-pill mapfirst-marker-pill-active${o?" mapfirst-marker-selected":i?"":" mapfirst-marker-non-primary"}`,c.title=(u=a.name)!=null?u:String(a.tripadvisor_id),!p&&((h=a.awards)!=null&&h.length||f)){let b=document.createElement("div");if(b.className="mapfirst-marker-badge",i||(b.style.opacity="0.2"),b.className="mapfirst-marker-badge",(l=a.awards)!=null&&l.length&&a.awards[0].type){let C=document.createElement("div");C.className="mapfirst-marker-award-container";let T=document.createElement("div");T.className="mapfirst-marker-award-back",T.innerHTML=re;let v=document.createElement("div");v.className=`mapfirst-marker-award-dot mapfirst-marker-award-dot-type-${a.awards[0].type}`;let P=document.createElement("div");P.className="mapfirst-marker-award-front",P.innerHTML=te,C.appendChild(T),C.appendChild(v),C.appendChild(P),b.appendChild(C)}else f&&(b.className="mapfirst-marker-badge mapfirst-marker-rating-badge",b.textContent=f);c.appendChild(b)}let y=document.createElement("span");return y.className="mapfirst-marker-content",m?y.textContent=(x=(L=(M=a.pricing)==null?void 0:M.offer)==null?void 0:L.displayPrice)!=null?x:"\u2014":a.type==="Eat & Drink"?y.innerHTML=ae:a.type==="Attraction"&&(y.innerHTML=ie),c.appendChild(y),c.addEventListener("click",b=>{b.stopPropagation(),p||r==null||r(a)}),g.appendChild(c),g}function G(s,e,t,r){let a=s;a.style.zIndex=t?"20":e?"12":"11";let i=a.querySelector(".mapfirst-marker-pill");i&&(r?i.className="mapfirst-marker-pill mapfirst-marker-pill-pending":i.className=`mapfirst-marker-pill mapfirst-marker-pill-active${t?" mapfirst-marker-selected":e?"":" mapfirst-marker-non-primary"}`);let o=a.querySelector(".mapfirst-marker-badge");o instanceof HTMLElement&&(o.style.opacity=!e&&!t?"0.2":"")}function V(s,e,t,r){let a=s;a.style.zIndex=t?"20":e?"3":"1";let i=a.querySelector(".mapfirst-dot-marker-button");i&&(r?i.className="mapfirst-dot-marker-button mapfirst-dot-marker-button-pending":i.className=`mapfirst-dot-marker-button mapfirst-dot-marker-button-active${t?" mapfirst-dot-marker-selected":e?"":" mapfirst-dot-marker-non-primary"}`)}function q(s){let e=s.match(/^(?:primary|dot)-(\d+)-/);return e?parseInt(e[1],10):null}var A=class{constructor(e,t){this.markerCache=new Map;this.primaryType="Accommodation";this.selectedMarkerId=null;this.mapInstance=e,this.onMarkerClick=t}render(e,t,r){var i,o,m,n;t&&t!==this.primaryType&&(this.primaryType=t),r!==void 0&&(this.selectedMarkerId=r);let a=new Set(e.map(p=>p.key));for(let[p,f]of this.markerCache.entries())a.has(p)||(this.removeMarkerFromMap(f.marker),this.markerCache.delete(p));for(let p of e){let f=ne(p.marker.location);if(!f)continue;let g=this.markerCache.get(p.key);if(g)try{this.updateMarkerPosition(g.marker,f)}catch{this.removeMarkerFromMap(g.marker),this.markerCache.delete(p.key),this.createAndAddMarker(p,f)}else{let c=p.marker.tripadvisor_id,y,k;for(let[d,u]of this.markerCache.entries())if(q(d)===c&&u.kind===p.kind){y=u,k=d;break}if(y&&k){let d=p.marker.type===this.primaryType,u=this.selectedMarkerId===p.marker.tripadvisor_id,h=p.marker.type==="Accommodation",l=p.kind==="primary"?h&&!((o=(i=p.marker.pricing)==null?void 0:i.offer)!=null&&o.displayPrice):h&&((n=(m=p.marker.pricing)==null?void 0:m.offer)==null?void 0:n.availability)!=="available",M=this.getMarkerElement(y.marker);M&&(p.kind==="primary"?G(M,d,u,l):V(M,d,u,l)),this.updateMarkerZIndex(y.marker,p,d,u),this.markerCache.delete(k),this.markerCache.set(p.key,y);try{this.updateMarkerPosition(y.marker,f)}catch{}}else this.createAndAddMarker(p,f)}}}destroy(){for(let e of this.markerCache.values())this.removeMarkerFromMap(e.marker);this.markerCache.clear()}createAndAddMarker(e,t){let r=e.kind==="primary"?j(e,this.primaryType,this.selectedMarkerId,this.onMarkerClick):$(e,this.primaryType,this.selectedMarkerId,this.onMarkerClick);if(!r)return;let a=e.marker.type===this.primaryType,i=this.selectedMarkerId===e.marker.tripadvisor_id;try{let o=this.createMarker(r,t,e,a,i);o&&this.markerCache.set(e.key,{key:e.key,marker:o,kind:e.kind,parentId:e.kind==="dot"?e.parentId:void 0})}catch(o){console.error("Error creating marker",o)}}updateMarkerZIndex(e,t,r,a){}};function ne(s){return typeof(s==null?void 0:s.lon)!="number"||typeof(s==null?void 0:s.lat)!="number"||Number.isNaN(s.lon)||Number.isNaN(s.lat)?null:{lon:s.lon,lat:s.lat}}var w=class extends A{constructor(e){var t;super(e.mapInstance,e.onMarkerClick),this.MarkerCtor=(t=e.maplibregl)==null?void 0:t.Marker}render(e,t,r){this.MarkerCtor&&super.render(e,t,r)}createMarker(e,t,r){return this.MarkerCtor?new this.MarkerCtor({element:e,anchor:r.kind==="primary"?"bottom":"center"}).setLngLat([t.lon,t.lat]).addTo(this.mapInstance):null}removeMarkerFromMap(e){try{e.remove()}catch{}}updateMarkerPosition(e,t){e.setLngLat([t.lon,t.lat])}getMarkerElement(e){return e.getElement()}};var B=class extends A{constructor(e){super(e.mapInstance,e.onMarkerClick),this.google=e.google}render(e,t,r){var a,i;if(!((i=(a=this.google)==null?void 0:a.marker)!=null&&i.AdvancedMarkerElement)){console.warn("AdvancedMarkerElement not available");return}super.render(e,t,r)}createMarker(e,t,r,a,i){var m,n;if(!((n=(m=this.google)==null?void 0:m.marker)!=null&&n.AdvancedMarkerElement))return null;let o=r.kind==="primary"?i?20:a?12:11:i?20:a?3:1;return new this.google.marker.AdvancedMarkerElement({map:this.mapInstance,position:{lat:t.lat,lng:t.lon},content:e,zIndex:o})}removeMarkerFromMap(e){try{e.map=null}catch(t){console.error("Error removing marker",t)}}updateMarkerPosition(e,t){e.position={lat:t.lat,lng:t.lon}}getMarkerElement(e){let t=e.content;return t instanceof HTMLElement?t:null}updateMarkerZIndex(e,t,r,a){let i=t.kind==="primary"?a?20:r?12:11:a?20:r?3:1;e.zIndex=i}};var E=class extends A{constructor(e){var t;super(e.mapInstance,e.onMarkerClick),this.MarkerCtor=(t=e.mapboxgl)==null?void 0:t.Marker}render(e,t,r){this.MarkerCtor&&super.render(e,t,r)}createMarker(e,t,r){return this.MarkerCtor?new this.MarkerCtor({element:e,anchor:r.kind==="primary"?"bottom":"center"}).setLngLat([t.lon,t.lat]).addTo(this.mapInstance):null}removeMarkerFromMap(e){try{e.remove()}catch{}}updateMarkerPosition(e,t){e.setLngLat([t.lon,t.lat])}getMarkerElement(e){return e.getElement()}};var S=class{constructor(e){this.map=e}getMap(){return this.map}};var _=class extends S{constructor(t){super(t);this.cleanupFns=[]}initialize(t){return this.markerManager=new w({mapInstance:this.map,maplibregl:t.maplibregl,onMarkerClick:t.onMarkerClick}),t.onRefresh&&this.attachEventListeners(t.onRefresh),this.markerManager}attachEventListeners(t){if(!this.map||typeof this.map.on!="function")return;["move","zoom","dragend","pitch","rotate"].forEach(a=>{this.map.on(a,t),this.cleanupFns.push(()=>{typeof this.map.off=="function"&&this.map.off(a,t)})})}getMarkerManager(){return this.markerManager}cleanup(){for(let t of this.cleanupFns)try{t()}catch{}this.cleanupFns.length=0}getMap(){return this.map}getCenter(){let t=this.map.getCenter();return{lng:t.lng,lat:t.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let t=this.map.getBounds(),r=t.getSouthWest(),a=t.getNorthEast();return{sw:{lat:r.lat,lng:r.lng},ne:{lat:a.lat,lng:a.lng}}}project(t){return this.map.project({lng:t[0],lat:t[1]})}on(t,r){this.map.on(t,r)}off(t,r){this.map.off(t,r)}resize(){this.map.resize()}remove(){this.cleanup(),this.map.remove()}};var F=class extends S{constructor(t){super(t);this.cleanupFns=[];this.initializeOverlayView()}initialize(t){return this.markerManager=new B({mapInstance:this.map,google:t.google,onMarkerClick:t.onMarkerClick}),t.onRefresh&&this.attachEventListeners(t.onRefresh),this.markerManager}attachEventListeners(t){let r=["center_changed","zoom_changed","drag","heading_changed","tilt_changed"],a=[];r.forEach(i=>{let o=this.map.addListener(i,t);a.push(o)}),this.cleanupFns.push(()=>{a.forEach(i=>{try{i.remove()}catch{}})})}getMarkerManager(){return this.markerManager}cleanup(){for(let t of this.cleanupFns)try{t()}catch{}this.cleanupFns.length=0}initializeOverlayView(){var a;let t=(a=globalThis.google)==null?void 0:a.maps;if(!t)return;let r=t.OverlayView;r&&(this.overlayView=new r,this.overlayView.draw=function(){},this.overlayView.setMap(this.map))}getMap(){return this.map}getCenter(){let t=this.map.getCenter();return t?{lng:t.lng(),lat:t.lat()}:{lng:0,lat:0}}getZoom(){var t;return(t=this.map.getZoom())!=null?t:0}getBearing(){var t;return(t=this.map.getHeading())!=null?t:0}getPitch(){var t;return(t=this.map.getTilt())!=null?t:0}getMapBounds(){let t=this.map.getBounds();if(!t)return{sw:{lat:0,lng:0},ne:{lat:0,lng:0}};let r=t.getSouthWest(),a=t.getNorthEast();return{sw:{lat:r.lat(),lng:r.lng()},ne:{lat:a.lat(),lng:a.lng()}}}project(t){var m;if(!this.overlayView)return{x:0,y:0};let r=this.overlayView.getProjection();if(!r)return{x:0,y:0};let a=(m=globalThis.google)==null?void 0:m.maps;if(!a)return{x:0,y:0};let i=new a.LatLng(t[1],t[0]),o=r.fromLatLngToContainerPixel(i);return o?{x:o.x,y:o.y}:{x:0,y:0}}on(t,r){this.map.addListener(t,r)}off(t,r){var i;let a=(i=globalThis.google)==null?void 0:i.maps;a!=null&&a.event&&a.event.clearListeners(this.map,t)}resize(){var r;let t=(r=globalThis.google)==null?void 0:r.maps;t!=null&&t.event&&t.event.trigger(this.map,"resize")}remove(){this.cleanup(),this.overlayView&&(this.overlayView.setMap(null),this.overlayView=null)}};var N=class extends S{constructor(t){super(t);this.cleanupFns=[]}initialize(t){return this.markerManager=new E({mapInstance:this.map,mapboxgl:t.mapboxgl,onMarkerClick:t.onMarkerClick}),t.onRefresh&&this.attachEventListeners(t.onRefresh),this.markerManager}attachEventListeners(t){if(!this.map||typeof this.map.on!="function")return;["move","zoom","dragend","pitch","rotate"].forEach(a=>{this.map.on(a,t),this.cleanupFns.push(()=>{typeof this.map.off=="function"&&this.map.off(a,t)})})}getMarkerManager(){return this.markerManager}cleanup(){for(let t of this.cleanupFns)try{t()}catch{}this.cleanupFns.length=0}getMap(){return this.map}getCenter(){let t=this.map.getCenter();return{lng:t.lng,lat:t.lat}}getZoom(){return this.map.getZoom()}getBearing(){return this.map.getBearing()}getPitch(){return this.map.getPitch()}getMapBounds(){let t=this.map.getBounds(),r=t.getSouthWest(),a=t.getNorthEast();return{sw:{lat:r.lat,lng:r.lng},ne:{lat:a.lat,lng:a.lng}}}project(t){return this.map.project({lng:t[0],lat:t[1]})}on(t,r){this.map.on(t,r)}off(t,r){this.map.off(t,r)}resize(){this.map.resize()}remove(){this.cleanup(),this.map.remove()}};function K(s){let e=s.getCenter();return{longitude:e.lng,latitude:e.lat,zoom:s.getZoom(),bearing:s.getBearing(),pitch:s.getPitch()}}var se=[{zoom:6,threshold:120},{zoom:8,threshold:108},{zoom:10,threshold:92},{zoom:12,threshold:80},{zoom:14,threshold:68},{zoom:16,threshold:56}];function W(s){for(let e of se)if(s<=e.zoom)return e.threshold;return 48}function R({primaryType:s,markers:e,map:t,selectedMarkerId:r,zoom:a,collisionThresholdPx:i,dotCollisionThresholdPx:o}){if(!e.length)return[];if(!t)return e.map(d=>({kind:"primary",marker:d,key:`primary-${d.tripadvisor_id}`}));let m=e.map((d,u)=>{let h=d.location;if(typeof(h==null?void 0:h.lon)!="number"||typeof(h==null?void 0:h.lat)!="number")return null;let{x:l,y:M}=t.project([h.lon,h.lat]);return{marker:d,index:u,x:l,y:M}}).filter(d=>!!d);if(!m.length)return[];let n=W(a),p=pe(a),f=m.map((d,u)=>u),g=d=>f[d]===d?d:(f[d]=g(f[d]),f[d]),c=(d,u)=>{let h=g(d),l=g(u);h!==l&&(f[l]=h)};for(let d=0;d<m.length;d+=1)for(let u=d+1;u<m.length;u+=1){let h=m[d].x-m[u].x,l=m[d].y-m[u].y;Math.hypot(h,l)<=n&&c(d,u)}let y=new Map;for(let d of m){let u=g(d.index),h=y.get(u);h?h.push(d):y.set(u,[d])}let k=[];return y.forEach(d=>{var C,T;if(d.length===1){let[{marker:v}]=d,P=v.type===s,I=r===v.tripadvisor_id;k.push({kind:"primary",marker:v,key:`primary-${v.tripadvisor_id}-p${P?1:0}-s${I?1:0}-${(C=v.pricing)==null?void 0:C.availability}`});return}let u=[...d].sort((v,P)=>le(P.marker,v.marker,s)),[h,...l]=u,M=h.marker.type===s,L=r===h.marker.tripadvisor_id;if(k.push({kind:"primary",marker:h.marker,key:`primary-${h.marker.tripadvisor_id}-p${M?1:0}-s${L?1:0}-${(T=h.marker.pricing)==null?void 0:T.availability}`}),!l.length)return;let x=[],b=[];if(l.forEach(v=>{var P;if(r&&v.marker.tripadvisor_id===r){let I=v.marker.type===s;k.push({kind:"primary",marker:v.marker,key:`primary-${v.marker.tripadvisor_id}-p${I?1:0}-s1-${(P=v.marker.pricing)==null?void 0:P.availability}`});return}oe(h,v)<=p?x.push(v):b.push(v)}),x.forEach(v=>{var I;let P=v.marker.type===s;k.push({kind:"dot",marker:v.marker,key:`dot-${v.marker.tripadvisor_id}-p${P?1:0}-s0-${(I=v.marker.pricing)==null?void 0:I.availability}`,parentId:h.marker.tripadvisor_id})}),b.length){let v=R({markers:b.map(P=>P.marker),map:t,selectedMarkerId:r,zoom:a,primaryType:s,collisionThresholdPx:i,dotCollisionThresholdPx:o});k.push(...v)}}),k}function oe(s,e){return Math.hypot(s.x-e.x,s.y-e.y)}function pe(s){let e=W(s);return Math.max(48,e)}function le(s,e,t){var n,p;let r=s.type===t,a=e.type===t;if(r&&!a)return 1;if(!r&&a)return-1;let i=U(s)-U(e);if(i!==0)return i;let o=Z(s)-Z(e);if(o!==0)return o;let m=((n=s.reviews)!=null?n:0)-((p=e.reviews)!=null?p:0);return m!==0?m:s.tripadvisor_id-e.tripadvisor_id}function U(s){if(typeof s.rating=="number")return s.rating;if(s.rating===void 0||s.rating===null)return-1/0;let e=Number(s.rating);return Number.isNaN(e)?-1/0:e}function Z(s){var t,r,a;if(!((r=(t=s.pricing)==null?void 0:t.offer)!=null&&r.price))return-1/0;let e=Number(((a=s.pricing.offer.displayPrice)!=null?a:"0").replace(/[^0-9.,-]+/g,"").replace(/,/g,""));return Number.isNaN(e)?-1/0:e}var ce={prod:"https://api.mapfirst.ai",test:"https://ta-backend-test-290791666935.us-central1.run.app"},D=class extends Error{constructor({message:e,status:t,code:r}){super(e),this.name="PropertiesFetchError",this.status=t,this.code=r}};async function me(s,e,{signal:t}={}){var a,i;let r=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:t});if(!r.ok){let o=`Unexpected response: ${r.status}`,m;try{let n=await r.json();o=(i=(a=n.detail)!=null?a:n.error)!=null?i:o,m=n.code}catch{}throw new D({message:o,status:r.status,code:m})}return await r.json()}function J(s){return typeof s=="string"?s:s.toISOString().slice(0,10)}var Y="Accommodation";function de(){let e=new Date(Date.now()+864e6),t=(6-e.getDay()+7)%7,r=new Date(e.getTime()+t*864e5),a=r.getDay(),i=a===0?6:6-a,o=new Date(r.getTime()+(i+1)*864e5);return{checkIn:r,checkOut:o}}var X=class{constructor(e){this.options=e;this.adapter=null;this.properties=[];this.selectedMarkerId=null;this.destroyed=!1;this.clusterItems=[];this.isMapAttached=!1;var a,i,o,m,n,p,f,g,c,y,k,d,u,h,l,M;this.properties=[...(a=e.properties)!=null?a:[]],this.primaryType=e.primaryType,this.selectedMarkerId=(i=e.selectedMarkerId)!=null?i:null,this.environment=(o=e.environment)!=null?o:"prod",this.apiUrl=(m=e.apiUrl)!=null?m:ce[this.environment],this.mfid=(n=e.mfid)!=null?n:"default",this.requestBody=e.requestBody,this.currentPlatform=e.platform;let t=Q(e);this.fitBoundsPadding={top:(f=(p=e.fitBoundsPadding)==null?void 0:p.top)!=null?f:t?0:50,bottom:(c=(g=e.fitBoundsPadding)==null?void 0:g.bottom)!=null?c:t?0:160,left:(k=(y=e.fitBoundsPadding)==null?void 0:y.left)!=null?k:t?0:50,right:(u=(d=e.fitBoundsPadding)==null?void 0:d.right)!=null?u:t?0:50};let r=de();this.state={center:[0,0],zoom:0,bounds:null,pendingBounds:null,tempBounds:null,properties:this.properties,primary:(h=this.primaryType)!=null?h:Y,selectedPropertyId:this.selectedMarkerId,initialLoading:!0,isSearching:!1,firstCallDone:!1,filters:{checkIn:r.checkIn,checkOut:r.checkOut,numAdults:2,numRooms:1,...((l=e.initialLocationData)==null?void 0:l.currency)&&{currency:e.initialLocationData.currency}},activeLocation:{country:"",location_id:null,locationName:"",coordinates:[0,0]},isFlyToAnimating:!1,...e.state},this.callbacks=(M=e.callbacks)!=null?M:{},this.hasMapInstance(e)&&(this.adapter=this.createAdapter(e),this.isMapAttached=!0,this.refresh()),e.initialLocationData?this.initializeFromLocationData(e.initialLocationData):this.requestBody&&this.isMapAttached&&this.autoLoadProperties()}hasMapInstance(e){return!!("adapter"in e&&e.adapter||"mapInstance"in e&&e.mapInstance)}async initializeFromLocationData(e){try{let{city:t,country:r,query:a,currency:i}=e,o={filters:this.getFilters(),initial:!0};if(t&&r||r){let m=await fetch(`${this.apiUrl}/geo-lookup?country=${encodeURIComponent(r)}${t?`&city=${encodeURIComponent(t)}`:""}`);if(m.ok){let n=await m.json(),p=t;n.location_name&&n.path3_name&&n.location_name===n.path3_name&&(p=void 0),n.location_name&&(p=n.location_name);let f=n.path3_name||r;o={...o,city:p,country:f,location_id:n.location_id,longitude:n.longitude,latitude:n.latitude},this.setActiveLocation({city:p,country:f,location_id:n.location_id,locationName:p&&f?`${p}, ${f}`:f||"",coordinates:[n.latitude,n.longitude]}),this.setState({center:[n.latitude,n.longitude],zoom:12})}else this.handleError(new Error(`Geo mapping fetch failed: ${m.statusText}`),"initializeFromLocationData")}else a&&(o.query=a);this.requestBody=o,this.isMapAttached&&await this.autoLoadProperties()}catch(t){this.handleError(t,"initializeFromLocationData")}}async autoLoadProperties(){if(!this.requestBody)return;let e={filters:this.getFilters(),initial:!0,...this.requestBody};await this.runPropertiesSearch({body:e,onError:t=>{var r,a;this.handleError(t,"autoLoadProperties"),(a=(r=this.callbacks).onPropertiesLoadError)==null||a.call(r,t)}})}attachMap(e,t){if(this.isMapAttached&&(console.warn("Map is already attached. Destroying previous adapter."),this.adapter)){let a=this.adapter.getMarkerManager();a==null||a.destroy(),this.adapter.cleanup()}let r={...this.options,platform:t.platform,mapInstance:e,maplibregl:t.maplibregl,google:t.google,mapboxgl:t.mapboxgl,onMarkerClick:t.onMarkerClick};this.currentPlatform=t.platform,this.adapter=this.createAdapter(r),this.isMapAttached=!0,this.refresh(),this.requestBody&&!this.state.firstCallDone&&this.autoLoadProperties()}createAdapter(e){return ue(e)&&e.mapInstance?this.initializeAdapter(new _(e.mapInstance),{maplibregl:e.maplibregl,onMarkerClick:e.onMarkerClick}):Q(e)&&e.mapInstance?this.initializeAdapter(new F(e.mapInstance),{google:e.google,onMarkerClick:e.onMarkerClick}):fe(e)&&e.mapInstance?this.initializeAdapter(new N(e.mapInstance),{mapboxgl:e.mapboxgl,onMarkerClick:e.onMarkerClick}):"adapter"in e&&e.adapter?e.adapter:null}initializeAdapter(e,t){var a;let r=(a=this.options.autoSelectOnClick)!=null?a:!0;return e.initialize({...t,onMarkerClick:i=>{var o;i.location&&this.flyMapTo(i.location.lon,i.location.lat,14),i.type!==this.primaryType&&this.setPrimaryType(i.type),r&&this.setSelectedMarker(i.tripadvisor_id===this.selectedMarkerId?null:i.tripadvisor_id),(o=t.onMarkerClick)==null||o.call(t,i)},onRefresh:()=>this.refresh()}),e}_setProperties(e){var t,r;this.ensureAlive(),this.properties=[...e.filter(a=>{var i;return a.type==="Accommodation"?((i=a.pricing)==null?void 0:i.availability)!=="unavailable":!0})],this.updateState({properties:this.properties}),(r=(t=this.callbacks).onPropertiesChange)==null||r.call(t,e),this.refresh()}addProperty(e){var t,r;this.ensureAlive(),this.properties=[...this.properties,e],this.updateState({properties:this.properties}),(r=(t=this.callbacks).onPropertiesChange)==null||r.call(t,this.properties),this.refresh()}clearProperties(){var e,t;this.ensureAlive(),this.properties=[],this.updateState({properties:[]}),(t=(e=this.callbacks).onPropertiesChange)==null||t.call(e,[]),this.refresh()}setPrimaryType(e){var t,r;this.ensureAlive(),this.primaryType!==e&&(this.primaryType=e,this.updateState({primary:e}),(r=(t=this.callbacks).onPrimaryTypeChange)==null||r.call(t,e),this.refresh())}setSelectedMarker(e){var t,r;if(this.ensureAlive(),this.selectedMarkerId!==e){if(e!==null){let a=this.properties.find(i=>i.tripadvisor_id===e);a&&a.type!==this.primaryType&&this.setPrimaryType(a.type)}this.selectedMarkerId=e,this.updateState({selectedPropertyId:e}),(r=(t=this.callbacks).onSelectedPropertyChange)==null||r.call(t,e),this.refresh()}}getState(){return{...this.state}}handleError(e,t="MapFirstCore"){let r=e instanceof Error?e.message:String(e),a=e instanceof Error?e:new Error(r);console.error(`[${t}]`,r),this.callbacks.onError&&this.callbacks.onError(a,t)}updateState(e){this.state={...this.state,...e}}setState(e){var r,a,i,o,m,n,p,f,g,c,y,k,d,u,h,l;let t={...this.state};this.updateState(e),e.center!==void 0&&e.center!==t.center&&((a=(r=this.callbacks).onCenterChange)==null||a.call(r,e.center,this.state.zoom)),e.zoom!==void 0&&e.zoom!==t.zoom&&((o=(i=this.callbacks).onZoomChange)==null||o.call(i,e.zoom)),e.bounds!==void 0&&e.bounds!==t.bounds&&((n=(m=this.callbacks).onBoundsChange)==null||n.call(m,e.bounds)),e.pendingBounds!==void 0&&e.pendingBounds!==t.pendingBounds&&((f=(p=this.callbacks).onPendingBoundsChange)==null||f.call(p,e.pendingBounds)),e.filters!==void 0&&e.filters!==t.filters&&((c=(g=this.callbacks).onFiltersChange)==null||c.call(g,e.filters)),e.activeLocation!==void 0&&e.activeLocation!==t.activeLocation&&((k=(y=this.callbacks).onActiveLocationChange)==null||k.call(y,e.activeLocation)),e.initialLoading!==void 0&&e.initialLoading!==t.initialLoading&&((u=(d=this.callbacks).onLoadingStateChange)==null||u.call(d,e.initialLoading)),e.isSearching!==void 0&&e.isSearching!==t.isSearching&&((l=(h=this.callbacks).onSearchingStateChange)==null||l.call(h,e.isSearching))}setFilters(e){this.setState({filters:e})}setActiveLocation(e){this.setState({activeLocation:e})}setBounds(e){this.setState({bounds:e})}setPendingBounds(e){this.setState({pendingBounds:e})}setTempBounds(e){this.setState({tempBounds:e})}setLoading(e){this.setState({initialLoading:e})}setSearching(e){this.setState({isSearching:e})}setFlyToAnimating(e){this.setState({isFlyToAnimating:e})}handleMapMoveEnd(e){if(this.state.isFlyToAnimating){this.setState({isFlyToAnimating:!1,tempBounds:e,pendingBounds:null});return}let t=this.state.tempBounds;if(!t){this.setState({tempBounds:e,pendingBounds:e});return}let r=.01;Math.abs(e.sw.lat-t.sw.lat)>r||Math.abs(e.sw.lng-t.sw.lng)>r||Math.abs(e.ne.lat-t.ne.lat)>r||Math.abs(e.ne.lng-t.ne.lng)>r?this.setState({pendingBounds:e}):this.setState({pendingBounds:null})}flyMapTo(e,t,r,a=!0){if(this.ensureAlive(),this.setState({center:[t,e]}),typeof r=="number"&&this.setState({zoom:r}),!this.adapter)return;let i=this.adapter.getMap();if(i){if(this.currentPlatform==="google"){this.setFlyToAnimating(!1),i.setCenter({lat:t,lng:e}),r!==null&&typeof r=="number"&&i.setZoom(r!=null?r:13);return}if(a===!1){this.setFlyToAnimating(!1),i.jumpTo&&i.jumpTo({center:[e,t],...r!==null&&{zoom:r!=null?r:13}});return}this.setFlyToAnimating(!0),i.flyTo&&i.flyTo({center:[e,t],...r!==null&&{zoom:r!=null?r:13}})}}flyToPOIs(e,t,r=!0){var o,m;if(this.ensureAlive(),!this.adapter)return;let a=this.adapter.getMap();if(!a)return;let i=e;if((!i||i.length===0)&&(i=this.properties.filter(n=>n.location!==void 0&&(t!==void 0?n.type===t:!0)).map(n=>({lat:n.location.lat,lng:n.location.lon}))),!(!i||i.length===0)){if(i.length===1){let n=i[0];this.currentPlatform==="google"?(a.setCenter({lat:n.lat,lng:n.lng}),a.setZoom(13)):a.flyTo&&a.flyTo({center:[n.lng,n.lat],zoom:13})}else if(this.currentPlatform==="google"){let n=(m=(o=window.google)==null?void 0:o.maps)==null?void 0:m.LatLngBounds;if(n){let p=new n;i.forEach(f=>{p.extend({lat:f.lat,lng:f.lng})}),r&&this.setFlyToAnimating(!0),a.fitBounds(p,this.fitBoundsPadding)}}else if(a.fitBounds){let n=[[i[0].lng,i[0].lat],[i[0].lng,i[0].lat]];i.forEach(p=>{n[0][0]=Math.min(n[0][0],p.lng),n[0][1]=Math.min(n[0][1],p.lat),n[1][0]=Math.max(n[1][0],p.lng),n[1][1]=Math.max(n[1][1],p.lat)}),r&&this.setFlyToAnimating(!0),a.fitBounds(n,{padding:this.fitBoundsPadding,animate:r})}}}getFilters(){let e={...this.state.filters};return e.checkIn instanceof Date&&(e.checkIn=J(e.checkIn)),e.checkOut instanceof Date&&(e.checkOut=J(e.checkOut)),e}async loadProperties({fetchFn:e,onSuccess:t,onError:r}){this.ensureAlive(),this.setLoading(!0),this.setSearching(!0),this.clearProperties();try{let a=await e();if(this._setProperties(a),!this.primaryType&&a.length>0){let i=a.reduce((m,n)=>(m[n.type]=(m[n.type]||0)+1,m),{}),o=Object.entries(i).reduce((m,n)=>i[m[0]]>i[n[0]]?m:n)[0];this.setPrimaryType(o)}this.setState({firstCallDone:!0}),t==null||t(a)}catch(a){this.clearProperties(),r==null||r(a)}finally{this.setSearching(!1),this.setLoading(!1),this.setState({firstCallDone:!0})}}async pollForPricing({pollingLink:e,maxAttempts:t=15,delayMs:r=2e3,isCancelled:a,price:i,limit:o}){var g,c,y,k,d;if(this.ensureAlive(),!e)return{completed:!1};let m=!1,n,p=this.getFilters();o&&(p.limit=o);let f={filters:p,pollingLink:e};for(let u=0;u<t;u++){if(a!=null&&a())return{completed:m,pollData:n};try{let h=await fetch(`${this.apiUrl}/${this.mfid}/ta-polling?pollingNumber=${u}`,{method:"POST",body:JSON.stringify(f),headers:{"Content-Type":"application/json"}});if(!h.ok)throw new D({message:`Poll failed: ${h.status}`,status:h.status});if(n=await h.json(),a!=null&&a())return{completed:m,pollData:n};let l=(c=(g=n==null?void 0:n.success)==null?void 0:g.results)!=null?c:[];if(l.length>0&&this.setProperties(M=>{let L=new Set(l.map(b=>b.tripadvisor_id)),x=M.filter(b=>b.type!=="Accommodation"||L.has(b.tripadvisor_id));return l.forEach(b=>{var T,v,P,I,H,z;if(!b.location)return;(v=(T=b.pricing)==null?void 0:T.offer)!=null&&v.price&&i&&(((I=(P=b.pricing)==null?void 0:P.offer)==null?void 0:I.price)<(i==null?void 0:i.min)||((z=(H=b.pricing)==null?void 0:H.offer)==null?void 0:z.price)>(i==null?void 0:i.max))&&(b.pricing.availability="unavailable");let C=x.findIndex(ee=>ee.tripadvisor_id===b.tripadvisor_id);C>=0?x[C]=b:x.push(b)}),x}),(y=n==null?void 0:n.success)!=null&&y.isComplete){m=!0;break}}catch(h){this.handleError(h,"pollForPricing"),(d=(k=this.callbacks).onPropertiesLoadError)==null||d.call(k,h);break}u<t-1&&await new Promise(h=>setTimeout(h,r))}return{completed:m,pollData:n}}setProperties(e){let t=e(this.properties);this._setProperties(t)}mostCommonTypeFromProperties(e){let t=e.reduce((r,a)=>(r[a.type]=(r[a.type]||0)+1,r),{});return Object.entries(t).reduce((r,a)=>t[r[0]]>t[a[0]]?r:a)[0]}async runPropertiesSearch({body:e,beforeApplyProperties:t,smartFiltersClearable:r,onError:a}){var i,o,m,n,p,f,g;this.ensureAlive(),this.setState({firstCallDone:!1}),this.setSearching(!0),this.clearProperties();try{let c=await me(`${this.apiUrl}/${this.mfid}/hotels`,e);this.updateActiveLocationFromResponse(c);let y=null,k=30,d=c.filters.primary_type;if(t){let l=t(c);y=(i=l.price)!=null?i:null,k=(o=l.limit)!=null?o:30}let u=c.properties.some(l=>!!l.location),h=y?c.properties.map(l=>{var M;return(M=l.pricing)!=null&&M.offer?{...l,pricing:{...l.pricing,availability:l.pricing.offer.price&&(l.pricing.offer.price<y.min||l.pricing.offer.price>y.max)?"unavailable":l.pricing.availability}}:l}):c.properties;if(this._setProperties(h),u&&this.flyToPOIs(c.properties.filter(l=>!!l.location&&(c.filters.primary_type?l.type===c.filters.primary_type:!0)).map(l=>({lat:l.location.lat,lng:l.location.lon})),void 0,e.initial!==!0),c.filters.primary_type&&c.properties.filter(l=>{var M;return l.type===c.filters.primary_type&&(l.type==="Accommodation"?((M=l.pricing)==null?void 0:M.availability)!=="unavailable":!0)}).length>0)d=c.filters.primary_type,this.setPrimaryType(c.filters.primary_type);else if(c.properties.length>0){let l=this.mostCommonTypeFromProperties(c.properties);this.setPrimaryType(l),d=l}if(this.setState({firstCallDone:!0}),c.isComplete===!1&&c.pollingLink){let{completed:l,pollData:M}=await this.pollForPricing({pollingLink:c.pollingLink,...y&&{price:y},...k&&{limit:k}});if(l&&((m=M==null?void 0:M.success)!=null&&m.results)&&M.success.results.filter(L=>{var x;return L.type===c.filters.primary_type&&(L.type==="Accommodation"?((x=L.pricing)==null?void 0:x.availability)!=="unavailable":!0)}).length===0&&d&&d!==c.filters.primary_type){let L=this.mostCommonTypeFromProperties(c.properties);this.setPrimaryType(L)}}return u||(c.properties.some(l=>!!l.location)?this.flyToPOIs(c.properties.filter(l=>!!l.location&&(c.filters.primary_type?l.type===c.filters.primary_type:!0)).map(l=>({lat:l.location.lat,lng:l.location.lon})),void 0,e.initial!==!0):(n=c.filters.location)!=null&&n.latitude&&((p=c.filters.location)!=null&&p.longitude)&&this.flyMapTo(c.filters.location.longitude,c.filters.location.latitude,12,e.initial!==!0)),c}catch(c){return this.handleError(c,"runPropertiesSearch"),a==null||a(c),(g=(f=this.callbacks).onPropertiesLoadError)==null||g.call(f,c),this.clearProperties(),this.setState({firstCallDone:!0}),null}finally{this.setSearching(!1),this.setState({firstCallDone:!0})}}async performBoundsSearch(){var i;if(this.ensureAlive(),!this.state.pendingBounds)return null;let e=this.getFilters(),t={bounds:this.state.pendingBounds,filters:e},r=(i=e==null?void 0:e.price)!=null?i:void 0,a=await this.runPropertiesSearch({body:t,beforeApplyProperties:()=>({price:r!=null?r:null})});return a&&(this.setBounds(this.state.pendingBounds),this.setTempBounds(this.state.pendingBounds),this.setPendingBounds(null)),a}updateActiveLocationFromResponse(e){var m,n,p,f;let t=(m=e.location_id)!=null?m:null,r=(p=(n=e.filters.location)==null?void 0:n.city)!=null?p:void 0,a=((f=e.filters.location)==null?void 0:f.country)||"",i=e.filters.location?[e.filters.location.latitude,e.filters.location.longitude]:void 0;if(!i)return;let o=this.state.activeLocation;(t!==(o==null?void 0:o.location_id)||r!==(o==null?void 0:o.city)||a!==(o==null?void 0:o.country))&&this.setActiveLocation({city:r,country:a,location_id:t,locationName:r&&a?`${r}, ${a}`:a||"",coordinates:i})}async runSmartFilterSearch({query:e,filters:t,onProcessFilters:r,onError:a}){this.ensureAlive();let i=this.getFilters(),o=this.getState();if(t&&t.length>0){let n=new Set,p=new Set,f,g,c,y,k,d;t.forEach(u=>{var h,l,M;switch(u.type){case"amenity":n.add(u.value);break;case"hotelStyle":p.add(u.value);break;case"priceRange":u.priceRange&&(f={min:u.priceRange.min,max:(h=u.priceRange.max)!=null?h:0});break;case"minRating":g=(l=u.numericValue)!=null?l:Number(u.value);break;case"starRating":c=(M=u.numericValue)!=null?M:Number(u.value);break;case"primary_type":y=u.propertyType;break;case"transformed_query":k=u.value;break;case"selected_restaurant_price_levels":d=u.priceLevels;break}}),i={...i,...n.size>0&&{amenities:Array.from(n)},...p.size>0&&{hotelStyle:Array.from(p)},...f&&{price:f},...g!==void 0&&{minRating:g},...c!==void 0&&{starRating:c},...y&&{primary_type:y},...k&&{transformed_query:k},...d&&{selected_restaurant_price_levels:d}}}else e||(i.minRating=4);let m={filters:i,...e&&{query:e},...o.bounds?{bounds:o.bounds}:o.activeLocation.location_id?{location_id:o.activeLocation.location_id}:o.activeLocation.coordinates?{latitude:o.activeLocation.coordinates[0],longitude:o.activeLocation.coordinates[1]}:{}};return this.runPropertiesSearch({body:m,beforeApplyProperties:r?n=>{var f,g;let p=r(n.filters,n.location_id);return{price:(f=p.price)!=null?f:null,limit:(g=p.limit)!=null?g:30}}:void 0,smartFiltersClearable:!!e,onError:a})}getClusters(){return this.ensureAlive(),[...this.clusterItems]}refresh(){var a,i,o;if(this.ensureAlive(),!this.adapter)return;let e=this.safeExtractViewState(),t=this.resolvePrimaryType();this.clusterItems=R({primaryType:t,markers:this.properties,map:this.adapter,selectedMarkerId:this.selectedMarkerId,zoom:(a=e==null?void 0:e.zoom)!=null?a:0}),this.adapter.getMarkerManager().render(this.clusterItems,t,this.selectedMarkerId),(o=(i=this.options).onClusterUpdate)==null||o.call(i,this.clusterItems,e)}destroy(){this.destroyed||(this.adapter&&(this.adapter.getMarkerManager().destroy(),this.adapter.cleanup()),this.clusterItems=[],this.properties=[],this.destroyed=!0,this.isMapAttached=!1)}resolvePrimaryType(){var e,t,r;return(r=(t=this.primaryType)!=null?t:(e=this.properties.find(a=>a.type))==null?void 0:e.type)!=null?r:Y}safeExtractViewState(){if(!this.adapter)return null;try{return K(this.adapter)}catch{return null}}ensureAlive(){if(this.destroyed)throw new Error("MapFirstCore instance has been destroyed")}};function ue(s){return s.platform==="maplibre"}function Q(s){return s.platform==="google"}function fe(s){return s.platform==="mapbox"}export{X as MapFirstCore,D as PropertiesFetchError,me as fetchProperties};
//# sourceMappingURL=index.mjs.map